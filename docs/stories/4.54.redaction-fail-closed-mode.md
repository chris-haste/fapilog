# Story 4.54: Redaction Fail-Closed Mode and Fallback Hardening

**Status:** Draft
**Priority:** High
**Depends on:** None

---

## Context / Background

An external audit (GPT-5.2 assessment, 2026-01-27) identified two security concerns with the current redaction implementation:

### Problem 1: No global fail-closed mode for redaction errors

When a redactor encounters an exception, the original unredacted entry is passed through to sinks:

```python
# src/fapilog/core/worker.py:355-375
async def _apply_redactors(self, entry: dict[str, Any]) -> dict[str, Any]:
    try:
        return await redact_in_order(entry, redactors, metrics=self._metrics)
    except Exception:
        # Fail-open: returns original entry unchanged
        return entry
```

**Existing mechanism**: Individual redactors have `block_on_unredactable` settings (e.g., `redactor_config.field_mask.block_on_unredactable`). However:
- This only handles cases where the redactor *itself* decides to block (e.g., can't parse a value)
- It doesn't handle unexpected exceptions in redactor code
- There's no global setting to enforce fail-closed across all redactors

### Problem 2: Serialized fallback path writes unredacted data

Story 4.46 implemented `fallback_redact_mode` with options `inherit`/`minimal`/`none` (default: `minimal`). However, this only applies to dict payloads. When a sink fails with pre-serialized data, the fallback writes raw bytes without redaction:

```python
# src/fapilog/plugins/sinks/fallback.py:80-94
def _format_payload(payload: Any, *, serialized: bool) -> str:
    if serialized:
        # Raw bytes decoded and written - NO REDACTION
        data = bytes(payload) if isinstance(payload, memoryview) else payload.data
        return data.decode("utf-8", errors="replace")
```

This creates a security gap where secrets can leak to stderr during sink failures on the serialized path.

---

## Scope (In / Out)

### In Scope

- Add `core.redaction_fail_mode` global setting with options: `"open"` (current), `"closed"`, `"warn"`
- This setting governs behavior when `_apply_redactors()` catches an unexpected exception
- Default to `"warn"` for production/fastapi/serverless presets
- Extend `_write_to_stderr()` to deserialize and redact serialized payloads
- Emit diagnostics when fail-closed mode drops an event
- Update docs to explain the relationship between settings

### Out of Scope

- Changes to per-redactor `block_on_unredactable` behavior (orthogonal mechanism)
- Full re-parse of serialized payloads for redaction (only fallback path)
- Content-based PII detection (explicitly documented as not supported)

---

## Relationship to Existing Settings

| Setting | Scope | Purpose | Default |
|---------|-------|---------|---------|
| `redactor_config.*.block_on_unredactable` | Per-redactor | Block when redactor can't process a value | `False` |
| `core.fallback_redact_mode` | Fallback sink | How to redact dict payloads on fallback | `"minimal"` |
| `core.redaction_fail_mode` (NEW) | Global | What to do when `_apply_redactors()` throws | `"open"` |

The new `redaction_fail_mode` handles the "outer" exception case - when the entire redaction pipeline fails unexpectedly, not when a specific redactor decides it can't redact a value.

---

## Acceptance Criteria

### AC1: Global redaction fail mode setting

**Description:** New `core.redaction_fail_mode` setting controls behavior on unexpected redactor exceptions.

**Validation:**
```python
from fapilog.core.settings import Settings, CoreSettings

# Default for dev preset
settings = Settings(preset="dev")
assert settings.core.redaction_fail_mode == "open"

# Default for production presets
settings = Settings(preset="production")
assert settings.core.redaction_fail_mode == "warn"

# Explicit override
settings = Settings(core=CoreSettings(redaction_fail_mode="closed"))
assert settings.core.redaction_fail_mode == "closed"
```

### AC2: Fail-closed mode drops events on redaction exception

**Description:** When `redaction_fail_mode="closed"`, events are dropped (not logged) if `_apply_redactors()` catches an exception.

**Validation:**
```python
# Configure with fail-closed and inject a redactor that raises
# Event should be dropped, not written to sink
# Diagnostic warning should be emitted
# Metrics counter `redaction_exceptions_total` should increment
```

### AC3: Warn mode logs diagnostic but passes event

**Description:** When `redaction_fail_mode="warn"`, events pass through but a diagnostic warning is emitted.

**Validation:**
```python
# With warn mode (default for production)
# Redaction exception should:
# 1. Emit diagnostic warning with rate limiting (key: "redaction_exception")
# 2. Pass original event to sink (fail-open behavior)
# 3. Increment metrics counter `redaction_exceptions_total`
```

### AC4: Serialized fallback path applies minimal redaction

**Description:** When `_write_to_stderr()` handles a serialized payload with `redact_mode="minimal"`, it deserializes, redacts, and re-serializes.

**Validation:**
```python
from fapilog.plugins.sinks.fallback import _write_to_stderr
from fapilog.core.serialization import SerializedView
import io
import sys

# Capture stderr
captured = io.StringIO()
sys.stderr = captured

# Serialized payload containing secrets
payload = SerializedView(data=b'{"password": "secret123", "user": "alice"}')

# Write with minimal redaction (the actual integration point)
_write_to_stderr(payload, serialized=True, redact_mode="minimal")

output = captured.getvalue()
assert "secret123" not in output
assert '"password"' in output  # Key present
assert '"user": "alice"' in output or '"user":"alice"' in output
```

### AC5: Invalid JSON in serialized fallback handled gracefully

**Description:** If serialized payload isn't valid JSON, fall back to raw output with diagnostic warning.

**Validation:**
```python
# Payload that isn't valid JSON
payload = SerializedView(data=b'not valid json {{{')

# Should not raise, should write raw bytes
_write_to_stderr(payload, serialized=True, redact_mode="minimal")

# Diagnostic warning should be emitted about deserialization failure
```

### AC6: Documentation explains setting relationships

**Description:** `docs/redaction/behavior.md` updated to explain the three redaction-related settings and when each applies.

---

## Implementation Notes

### File Changes

```
src/fapilog/core/settings.py (MODIFIED - add redaction_fail_mode to CoreSettings)
src/fapilog/core/worker.py (MODIFIED - honor fail mode in _apply_redactors)
src/fapilog/core/presets.py (MODIFIED - set warn mode for production presets)
src/fapilog/plugins/sinks/fallback.py (MODIFIED - redact serialized in _write_to_stderr)
docs/redaction/behavior.md (MODIFIED - document setting relationships)
```

### Key Code

```python
# settings.py - add to CoreSettings
redaction_fail_mode: Literal["open", "closed", "warn"] = Field(
    default="open",
    description=(
        "Behavior when _apply_redactors() catches an unexpected exception: "
        "'open' passes original event (current behavior), "
        "'closed' drops the event, "
        "'warn' passes event but emits diagnostic warning"
    ),
)

# worker.py - updated _apply_redactors
async def _apply_redactors(self, entry: dict[str, Any]) -> dict[str, Any] | None:
    redactors = self._redactors_getter()
    if not redactors:
        return entry
    try:
        return await redact_in_order(entry, redactors, metrics=self._metrics)
    except Exception as exc:
        fail_mode = self._redaction_fail_mode  # Injected from settings
        if self._metrics:
            await self._metrics.increment("redaction_exceptions_total")

        if fail_mode == "closed":
            warn("redactor", "dropping event due to redaction exception",
                 error=str(exc), _rate_limit_key="redaction_exception")
            return None  # Signal to drop event

        if fail_mode == "warn":
            warn("redactor", "redaction exception, passing original",
                 error=str(exc), _rate_limit_key="redaction_exception")

        return entry

# fallback.py - updated _write_to_stderr (the integration point)
def _write_to_stderr(
    payload: Any,
    *,
    serialized: bool,
    redact_mode: RedactMode = "minimal",
) -> None:
    if serialized and redact_mode == "minimal":
        # Attempt to deserialize, redact, re-serialize
        try:
            data = _extract_bytes(payload)
            parsed = json.loads(data)
            if isinstance(parsed, dict):
                parsed = minimal_redact(parsed)
            text = json.dumps(parsed, separators=(",", ":"), default=str)
        except (json.JSONDecodeError, UnicodeDecodeError) as exc:
            diagnostics.warn(
                "fallback",
                "serialized payload not valid JSON, writing raw",
                error=str(exc),
                _rate_limit_key="fallback_json_error",
            )
            text = _format_payload(payload, serialized=True)
    elif not serialized and isinstance(payload, dict):
        if redact_mode == "minimal":
            payload = minimal_redact(payload)
        text = _format_payload(payload, serialized=False)
    else:
        text = _format_payload(payload, serialized=serialized)

    if not text.endswith("\n"):
        text += "\n"
    sys.stderr.write(text)
    sys.stderr.flush()
```

---

## Tasks

### Phase 1: Core Implementation

- [ ] Add `redaction_fail_mode` to `CoreSettings` with Literal type and validation
- [ ] Add `_redaction_fail_mode` injection to `LoggerWorker.__init__`
- [ ] Update `LoggerWorker._apply_redactors()` to honor fail mode
- [ ] Update `_flush_batch()` to skip entries where redactors returned `None`

### Phase 2: Fallback Hardening

- [ ] Refactor `_write_to_stderr()` to handle serialized redaction
- [ ] Add `_extract_bytes()` helper for consistent byte extraction
- [ ] Handle JSON decode errors gracefully with diagnostic
- [ ] Add test coverage for serialized fallback redaction

### Phase 3: Presets

- [ ] Set `redaction_fail_mode="warn"` in production preset
- [ ] Set `redaction_fail_mode="warn"` in fastapi preset
- [ ] Set `redaction_fail_mode="warn"` in serverless preset
- [ ] Update env var docs for `FAPILOG__CORE__REDACTION_FAIL_MODE`

### Phase 4: Documentation

- [ ] Update `docs/redaction/behavior.md` with setting relationship table
- [ ] Add example configurations for compliance environments
- [ ] Update CHANGELOG

---

## Tests

### Unit Tests

- `tests/unit/test_worker_redaction_fail_modes.py`
  - test_fail_open_passes_original_on_exception
  - test_fail_closed_drops_event_on_exception
  - test_fail_closed_emits_diagnostic
  - test_fail_warn_emits_diagnostic_and_passes
  - test_fail_mode_metrics_incremented
  - test_none_return_skipped_in_flush_batch

- `tests/unit/test_fallback_serialized_redaction.py`
  - test_serialized_dict_redacted_on_minimal_mode
  - test_serialized_nested_secrets_redacted
  - test_invalid_json_falls_back_to_raw_with_warning
  - test_serialized_non_dict_passes_through
  - test_inherit_mode_not_affected (serialized path)

### Integration Tests

- `tests/integration/test_redaction_fail_closed.py`
  - end-to-end test with broken redactor and fail-closed mode
  - verify event is not written to any sink
  - verify diagnostic warning emitted

---

## Definition of Done

### Code Complete

- [ ] All acceptance criteria implemented
- [ ] Code follows project patterns
- [ ] No new linting errors

### Quality Assurance

- [ ] Unit tests written and passing
- [ ] Integration tests written and passing
- [ ] `ruff check` passes
- [ ] `mypy` passes
- [ ] No regression in existing tests

### Documentation

- [ ] Code has docstrings where needed
- [ ] Redaction docs updated with setting relationships
- [ ] CHANGELOG updated

---

## Risks / Rollback

### Risks

1. **Risk:** Fail-closed mode could drop legitimate logs if redactors have bugs
   - **Mitigation:** Default to "warn" mode; require explicit opt-in for "closed"

2. **Risk:** Deserializing serialized payloads for fallback redaction adds overhead
   - **Mitigation:** Only applies during sink failures (rare path); worth the security tradeoff

3. **Risk:** JSON parsing may fail on valid serialized payloads (e.g., non-JSON formats)
   - **Mitigation:** Graceful fallback to raw output with diagnostic warning

### Rollback Plan

If issues occur:
1. Set `FAPILOG__CORE__REDACTION_FAIL_MODE=open` to restore original behavior
2. Revert PR if fundamental issues discovered

---

## Related Stories

- **Related:** Story 4.46 - Fallback sink PII protection (implemented `fallback_redact_mode`)
- **Related:** Story 4.50 - Regex ReDoS protection
- **Related:** Story 4.51 - Secure header redaction defaults

---

## Change Log

| Date | Change | Author |
|------|--------|--------|
| 2026-01-27 | Initial draft from audit findings | Claude |
| 2026-01-27 | Revised: clarified relationship to existing settings, fixed AC4 | Claude |
