# Story 10.35: Unified Sampling Documentation

**Status:** Complete
**Priority:** Medium
**Depends on:** None

---

## Context / Background

An external audit (GPT-5.1 assessment, 2026-01-28) identified that fapilog has multiple sampling mechanisms with unclear relationships, causing user confusion.

### Current State

Fapilog has evolved its sampling approach over time:

**Legacy (deprecated):**
```python
# Old approach - still works but emits deprecation warning
settings = Settings(
    observability=ObservabilitySettings(
        logging=LoggingSettings(sampling_rate=0.1)
    )
)
```

This triggers a deprecation warning at `src/fapilog/core/logger.py:311`:
```
observability.logging.sampling_rate is deprecated.
Use core.filters=['sampling'] with filter_config.sampling instead.
```

**Current (recommended):**
```python
# Filter-based approach
logger = LoggerBuilder().with_sampling(rate=0.1).build()

# Or via Settings
settings = Settings(
    core=CoreSettings(filters=["sampling"]),
    filter_config=FilterConfigSettings(
        sampling=SamplingFilterSettings(rate=0.1)
    )
)
```

### Problem

1. **Two approaches coexist** without clear guidance on which to use
2. **Deprecation warning** points to new approach but docs don't emphasize migration
3. **`docs/user-guide/sampling.md`** focuses on filter-based approach but doesn't mention legacy
4. **`observability.logging.sampling_rate`** still appears in `ObservabilitySettings` without deprecation marker
5. Audit finding: "Make filter-based sampling the primary documented approach, mark legacy as deprecated"

### Files Involved

- `src/fapilog/core/observability.py:57-71` - `LoggingSettings.sampling_rate`
- `src/fapilog/core/logger.py:308-314` - Deprecation warning emission
- `docs/user-guide/sampling.md` - Current sampling docs (filter-focused)
- `src/fapilog/plugins/filters/sampling.py` - `SamplingFilter`
- `src/fapilog/plugins/filters/trace_sampling.py` - `TraceSamplingFilter`

---

## Scope (In / Out)

### In Scope

- Update sampling docs to be the authoritative reference
- Add deprecation notice for `observability.logging.sampling_rate`
- Add migration guide from legacy to filter-based
- Clarify which approach to use and why
- Add deprecation marker in code docstring

### Out of Scope

- Removing the deprecated setting (breaking change, separate story)
- Changing the deprecation warning message
- Adding new sampling features
- Modifying filter implementations

---

## Acceptance Criteria

### AC1: Sampling Doc Has Deprecation Section

**Description:** `docs/user-guide/sampling.md` includes clear deprecation notice for legacy approach.

**Validation:**
```markdown
## Deprecated: Settings-Based Sampling

> **Deprecated since v0.6.0**: The `observability.logging.sampling_rate` setting
> is deprecated. Use filter-based sampling instead.

If you're using:
```python
# Deprecated - will emit warning
settings = Settings(
    observability=ObservabilitySettings(
        logging=LoggingSettings(sampling_rate=0.1)
    )
)
```

Migrate to:
```python
# Recommended
logger = LoggerBuilder().with_sampling(rate=0.1).build()
```
```

### AC2: Migration Guide Included

**Description:** Clear step-by-step migration from legacy to filter-based sampling.

**Validation:**
- Before/after code examples
- Explains what changes
- Notes any behavioral differences

### AC3: Primary Approach Emphasized

**Description:** Filter-based sampling is clearly marked as the recommended approach.

**Validation:**
- First section of sampling.md covers filter-based approach
- "Recommended" badge or callout on filter-based examples
- Legacy approach in separate "Deprecated" section at end

### AC4: Code Docstring Updated

**Description:** `LoggingSettings.sampling_rate` has deprecation notice in docstring.

**Validation:**
```python
# src/fapilog/core/observability.py
class LoggingSettings(BaseModel):
    sampling_rate: float = Field(
        default=1.0,
        ge=0.0,
        le=1.0,
        description=(
            "DEPRECATED: Use core.filters=['sampling'] with filter_config.sampling "
            "instead. Log sampling probability in range 0.0–1.0."
        ),
    )
```

### AC5: Sampling Strategies Comparison

**Description:** Clear comparison of `SamplingFilter` vs `TraceSamplingFilter`.

**Validation:**
- Table or section comparing the two
- When to use each
- Examples for both

### AC6: Environment Variable Documented

**Description:** Env var for filter-based sampling documented.

**Validation:**
```markdown
## Configuration via Environment Variables

```bash
# Enable sampling filter
export FAPILOG_CORE__FILTERS='["sampling"]'

# Set sampling rate
export FAPILOG_FILTER_CONFIG__SAMPLING__RATE=0.1
```
```

---

## Implementation Notes

### File Changes

```
docs/user-guide/sampling.md (MODIFIED - add deprecation section, migration guide)
src/fapilog/core/observability.py (MODIFIED - update docstring)
```

### Suggested Doc Structure

```markdown
# Sampling Strategies

## Quick Start (Recommended)

Use the builder API for the simplest setup:

```python
from fapilog import LoggerBuilder

# Probabilistic sampling - keep ~10% of logs
logger = LoggerBuilder().with_sampling(rate=0.1).build()

# Trace-based sampling - consistent per trace
logger = LoggerBuilder().with_trace_sampling(rate=0.1).build()
```

## Probabilistic Sampling (`SamplingFilter`)
...

## Trace-Based Sampling (`TraceSamplingFilter`)
...

## Comparison: Which Strategy to Use?

| Feature | SamplingFilter | TraceSamplingFilter |
|---------|----------------|---------------------|
| Consistency | Random per event | Consistent per trace |
| Use case | General volume reduction | Distributed tracing |
| Error handling | Samples errors too | Preserves all errors |

## Configuration via Settings
...

## Configuration via Environment Variables
...

## Deprecated: `observability.logging.sampling_rate`

> **Deprecated since v0.6.0**

The legacy `observability.logging.sampling_rate` setting still works but
emits a deprecation warning. Migrate to filter-based sampling.

### Migration Guide

**Before (deprecated):**
```python
settings = Settings(
    observability=ObservabilitySettings(
        logging=LoggingSettings(sampling_rate=0.1)
    )
)
logger = get_logger(settings=settings)
```

**After (recommended):**
```python
logger = LoggerBuilder().with_sampling(rate=0.1).build()
```

Or via Settings:
```python
settings = Settings(
    core=CoreSettings(filters=["sampling"]),
    filter_config=FilterConfigSettings(
        sampling=SamplingFilterSettings(rate=0.1)
    )
)
```

### Behavioral Differences

- Legacy: Applied inline during log call
- Filter-based: Applied in pipeline, more efficient, supports level overrides
```

---

## Tasks

### Phase 1: Documentation Updates

- [ ] Restructure `docs/user-guide/sampling.md` with recommended approach first
- [ ] Add deprecation section with migration guide
- [ ] Add comparison table for sampling strategies
- [ ] Document env var configuration

### Phase 2: Code Updates

- [ ] Update `LoggingSettings.sampling_rate` docstring with deprecation notice
- [ ] Verify deprecation warning message is accurate

### Phase 3: Cross-References

- [ ] Link from configuration docs
- [ ] Update any other docs referencing legacy sampling
- [ ] Update CHANGELOG

---

## Tests

### Manual Verification

- [ ] Verify legacy approach still works and emits warning
- [ ] Verify filter-based approach works as documented
- [ ] Check env var examples work
- [ ] Docs build passes

---

## Definition of Done

### Code Complete

- [ ] Sampling docs restructured
- [ ] Deprecation section added
- [ ] Migration guide included
- [ ] Code docstring updated

### Quality Assurance

- [ ] Legacy approach tested (still works + warning)
- [ ] New approach tested
- [ ] Docs build passes

### Documentation

- [ ] Clear primary recommendation
- [ ] Deprecation clearly marked
- [ ] CHANGELOG updated

---

## Risks / Rollback

### Risks

1. **Risk:** Users confused by multiple approaches in same doc
   - **Mitigation:** Clear visual separation, "Recommended" badges

2. **Risk:** Breaking users who search for legacy approach
   - **Mitigation:** Keep legacy documented but in deprecated section

### Rollback Plan

If issues occur:
1. Documentation only - no code behavior changes
2. Revert doc changes if fundamentally confusing

---

## Code Review

**Date:** 2026-01-28
**Reviewer:** Claude
**Verdict:** OK to PR

### Summary

Documentation restructuring to establish filter-based sampling as the primary recommended approach, with deprecation notice and migration guide for legacy `observability.logging.sampling_rate` setting.

### AC Verification

| Criterion | Evidence |
|-----------|----------|
| AC1: Deprecation Section | `docs/user-guide/sampling.md:224-286` - Section with blockquote deprecation notice |
| AC2: Migration Guide | `docs/user-guide/sampling.md:230-269` - Before/after examples, behavioral differences |
| AC3: Primary Approach | `docs/user-guide/sampling.md:5-17` - Quick Start (Recommended) first |
| AC4: Code Docstring | `src/fapilog/core/observability.py:70-73` - DEPRECATED prefix in description |
| AC5: Strategy Comparison | `docs/user-guide/sampling.md:141-150` - 6-row comparison table |
| AC6: Env Vars | `docs/user-guide/sampling.md:169-182` - Both filter types documented |

### Quality Gates

- [x] ruff check passed
- [x] ruff format passed
- [x] mypy passed
- [x] Docs build passed
- [x] Settings descriptions valid

---

## Related Stories

- **Related:** Story 5.3 - Add sampling and rate limiting plugins (Complete)
- **Related:** Story 10.34 - Configuration map documentation
- **Enables:** Future story to remove deprecated `sampling_rate` setting

---

## Change Log

| Date | Change | Author |
|------|--------|--------|
| 2026-01-28 | Initial draft from audit findings | Claude |
| 2026-01-28 | Review passed, status → Ready | Claude |
| 2026-01-28 | Code review passed, status → Complete | Claude |
