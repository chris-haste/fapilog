# Story 5.27: Document Pipeline Stage Ordering

## Status: Planned

## Priority: Critical

## Estimated Effort: Small (1 day)

## Dependencies

- **Depends on:** None
- **Prerequisite for:** None
- **Related to:** Story 5.0 (Wire Processors into Pipeline)

## Epic / Series

Part of Series 5.x: Plugin System Completion & Enhancement

---

## Context / Background

The fapilog pipeline processes log events through multiple stages:

```
filters -> enrichers -> redactors -> processors -> sink
```

However, this ordering is **implicit** in the `_flush_batch()` method of `LoggerWorker` (`worker.py:235-268`). The code simply calls each stage in sequence without explaining:

1. **Why this order?** (e.g., why filters before enrichers?)
2. **What are the data flow guarantees?** (e.g., redactors see enriched data)
3. **What happens if a stage fails?**

This creates problems:

1. **Debugging difficulty:** "Why isn't my redactor seeing the field added by my enricher?" requires reading code to understand stage order
2. **Change risk:** Developers may reorder stages without understanding dependencies
3. **Onboarding friction:** New developers must trace through code to understand the pipeline

The Human Understandability Audit identified this as a **P0 issue** - fundamental to understanding the system.

---

## User Story

**As a** plugin developer
**I want** clear documentation of pipeline stage ordering and rationale
**So that** I can understand when my plugin runs and what data it receives

---

## Scope (In / Out)

### In Scope

- Add comprehensive docstring to `_flush_batch()` explaining stage order and rationale
- Add inline comments for each stage transition
- Create architecture documentation with pipeline diagram
- Document data flow guarantees (what each stage receives/produces)
- Document error handling behavior per stage

### Out of Scope

- Changing the pipeline order (that's a breaking change)
- Adding new pipeline stages
- Modifying how stages are configured

---

## Acceptance Criteria

### AC1: Code Documentation

- [ ] `LoggerWorker._flush_batch()` has docstring explaining full pipeline
- [ ] Each stage call in `_flush_batch()` has inline comment explaining "why here"
- [ ] Stage order is explicitly listed in docstring with rationale

### AC2: Architecture Documentation

- [ ] New doc `docs/architecture/pipeline-stages.md` exists
- [ ] Contains ASCII or Mermaid diagram of pipeline flow
- [ ] Explains rationale for each stage position
- [ ] Documents data transformations at each stage
- [ ] Documents error handling/containment per stage

### AC3: Plugin Developer Guidance

- [ ] Plugin development guide references pipeline documentation
- [ ] Each plugin type (filter, enricher, redactor, processor, sink) docs mention when they run
- [ ] Examples show expected input/output at each stage

---

## Technical Design / Implementation Notes

### Pipeline Order Rationale

The current order is:

1. **Filters** (first): Drop events early before any processing cost
2. **Enrichers** (second): Add context data (runtime info, request context, etc.)
3. **Redactors** (third): Mask sensitive data including enriched fields
4. **Processors** (fourth): Transform final payload (size limits, serialization)
5. **Sink** (last): Write to destination

This order ensures:
- Filters can drop before expensive enrichment
- Redactors see all data including enrichments
- Processors work on final, redacted data
- Sinks receive fully processed events

### Documentation Structure

```markdown
# Pipeline Stages

## Overview
[Diagram]

## Stage 1: Filters
- Purpose: Early event dropping
- Receives: Raw log event from queue
- Produces: Event or None (dropped)
- Error handling: Errors return original event (fail-open)

## Stage 2: Enrichers
- Purpose: Add contextual data
- Receives: Filtered event
- Produces: Enriched event with additional fields
- Error handling: Errors return original event

## Stage 3: Redactors
- Purpose: Mask sensitive data
- Receives: Enriched event
- Produces: Redacted event
- Error handling: Errors return original event

## Stage 4: Processors
- Purpose: Final transformations
- Receives: Serialized view (bytes)
- Produces: Transformed bytes
- Error handling: Errors return original bytes

## Stage 5: Sink
- Purpose: Write to destination
- Receives: Final event dict or serialized bytes
- Error handling: Contained, logged via diagnostics
```

### Code Locations

- Files to modify:
  - `src/fapilog/core/worker.py` - Add docstrings and comments
- Files to create:
  - `docs/architecture/pipeline-stages.md`
- Files to update:
  - `docs/plugins/index.md` or similar (link to pipeline docs)

---

## Tasks

### Phase 1: Code Documentation
- [ ] Add comprehensive docstring to `LoggerWorker._flush_batch()`
- [ ] Add inline comments before each `_apply_*` call
- [ ] Add docstrings to `_apply_filters()`, `_apply_enrichers()`, etc. if missing

### Phase 2: Architecture Documentation
- [ ] Create `docs/architecture/pipeline-stages.md`
- [ ] Add pipeline diagram (ASCII or Mermaid)
- [ ] Document each stage with purpose, inputs, outputs, error handling
- [ ] Add examples of data flow

### Phase 3: Cross-References
- [ ] Update plugin development guide to reference pipeline docs
- [ ] Add "When does my plugin run?" section to each plugin type doc
- [ ] Link from README or getting started guide

---

## Tests

### Unit Tests

No new tests needed - this is documentation only.

### Manual Verification

- [ ] Read through pipeline docs and verify accuracy against code
- [ ] Verify diagram matches actual code flow
- [ ] Have someone unfamiliar with codebase review docs for clarity

---

## Documentation Updates

- [ ] Create `docs/architecture/pipeline-stages.md`
- [ ] Update `docs/plugins/index.md` with pipeline reference
- [ ] Add inline code comments in `worker.py`
- [ ] No CHANGELOG entry (docs only)

---

## Definition of Done

### Code Complete
- [ ] All docstrings and comments added
- [ ] No linting errors
- [ ] Type checking passes

### Documentation
- [ ] Architecture doc created
- [ ] Pipeline diagram included
- [ ] All stages documented
- [ ] Cross-references added

### Review & Release
- [ ] Code review approved (focus on accuracy)
- [ ] Documentation reviewed for clarity
- [ ] CI/CD pipeline passing

---

## Risks / Rollback / Monitoring

### Risks

- **Risk 1:** Documentation becomes stale if pipeline changes
  - **Mitigation:** Add comment in code pointing to docs that must be updated

### Rollback Plan

- Documentation can be reverted easily
- No code behavior changes

### Success Metrics

- New developers can answer "what order do plugins run?" from docs
- Reduced support questions about plugin ordering

---

## Related Documents

- [5.0 Series Overview](./5.0-series-overview.md)
- [Human Understandability Audit Report](#) - P0 recommendation #3
- [Story 5.0: Wire Processors into Pipeline](./5.0.wire-processors-into-pipeline.md)

---

## Appendix: Proposed Docstring

```python
async def _flush_batch(self, batch: list[dict[str, Any]]) -> None:
    """Flush a batch of log events through the processing pipeline.

    Pipeline Stage Order (with rationale):

    1. FILTERS: Applied first to drop unwanted events before any processing
       cost is incurred. Filters see the raw event from the queue.

    2. ENRICHERS: Applied second to add contextual data (runtime info,
       request context, correlation IDs). Run after filters so dropped
       events don't waste enrichment cycles.

    3. REDACTORS: Applied third to mask sensitive data. Run after enrichers
       so they can redact both original fields AND enriched fields.

    4. PROCESSORS: Applied fourth to transform the final payload (size
       limits, format changes). Run on serialized bytes when serialize_in_flush
       is enabled.

    5. SINK: Final stage writes to destination. Receives either dict or
       SerializedView depending on configuration.

    Error Handling:
    - Filters/Enrichers/Redactors: Errors are contained; original event
      is passed through (fail-open for observability)
    - Processors: Errors return original bytes
    - Sink: Errors are logged via diagnostics; event is dropped

    See: docs/architecture/pipeline-stages.md for detailed documentation.
    """
```

---

## Change Log

| Date       | Change                 | Author |
| ---------- | ---------------------- | ------ |
| 2026-01-14 | Initial story creation | Claude |
