# Story 4.57: Make Core Redaction Guardrails Functional

**Status:** Ready for Code Review
**Priority:** High
**Depends on:** None
**Audit Reference:** v0.7.1-unreleased GPT-5.2 Assessment - P1 Issue

---

## Context / Background

The core redaction guardrails (`redaction_max_depth`, `redaction_max_keys_scanned`) are defined in settings but **never applied**. They are dead code.

Current state:
- `src/fapilog/core/settings.py:704-712` defines `redaction_max_depth=6` and `redaction_max_keys_scanned=5000`
- `src/fapilog/builder.py:371-373` sets these values in config
- **Nothing reads or applies these values** - `redact_in_order()` doesn't reference them
- Only per-redactor guardrails (FieldMaskConfig `max_depth=16`, `max_keys_scanned=1000`) actually function

This creates a false sense of security. Users configuring core guardrails expect them to work, but they don't.

---

## Scope (In / Out)

### In Scope

- Make `redaction_max_depth` and `redaction_max_keys_scanned` functional
- Apply core guardrails as outer limits that override per-redactor settings
- Pass core guardrail values to redactors during initialization
- Add tests verifying core guardrails take effect

### Out of Scope

- Changing default values
- Documentation updates (see Story 4.60)
- New guardrail features beyond making existing settings work

---

## Acceptance Criteria

### AC1: Core Guardrails Override Per-Redactor Settings

**Description:** When core guardrails are more restrictive than per-redactor settings, the core values take effect.

**Validation:**
```python
# Core: redaction_max_depth=6 (default)
# FieldMask: max_depth=16 (default)
# Effective: max_depth=6 (core wins because more restrictive)

settings = Settings()
# Configure a deeply nested event (depth > 6)
event = {"l1": {"l2": {"l3": {"l4": {"l5": {"l6": {"l7": {"password": "secret"}}}}}}}}
# password at depth 7 should NOT be redacted (exceeds core limit of 6)
```

### AC2: Per-Redactor Settings Apply When Less Restrictive Than Core

**Description:** When per-redactor settings are more restrictive, they take effect.

**Validation:**
```python
# Core: redaction_max_depth=20
# FieldMask: max_depth=5
# Effective: max_depth=5 (plugin wins because more restrictive)
```

### AC3: Core Guardrails Passed to Redactors at Init

**Description:** Core guardrail values are passed to redactors during plugin loading.

**Validation:**
```python
# When loading field_mask redactor:
# - Read core.redaction_max_depth from settings
# - Pass as max_depth override if more restrictive than plugin default
```

### AC4: Existing Per-Redactor Behavior Preserved

**Description:** When no core guardrails are set (None), per-redactor defaults still work.

**Validation:**
```python
settings = Settings(core=CoreSettings(redaction_max_depth=None))
# FieldMask uses its own max_depth=16
```

---

## Implementation Notes

### File Changes

```
src/fapilog/core/worker.py (MODIFIED - pass guardrails to redactor loader)
src/fapilog/plugins/redactors/__init__.py (MODIFIED - accept guardrail overrides)
src/fapilog/plugins/redactors/field_mask.py (MODIFIED - respect passed guardrails)
src/fapilog/plugins/redactors/regex_mask.py (MODIFIED - respect passed guardrails)
tests/unit/plugins/redactors/test_guardrails.py (NEW - guardrail tests)
```

### Key Implementation

**Option 1: Pass at redactor initialization**
```python
# In worker or plugin loader:
core_max_depth = settings.core.redaction_max_depth
core_max_keys = settings.core.redaction_max_keys_scanned

for redactor in redactors:
    if hasattr(redactor, 'set_guardrails'):
        redactor.set_guardrails(
            max_depth=core_max_depth,
            max_keys_scanned=core_max_keys,
        )
```

**Option 2: Min of core and plugin at each redactor**
```python
# In FieldMaskRedactor._apply_mask():
effective_depth = min(
    self._max_depth,
    self._core_max_depth or self._max_depth
)
```

---

## Tasks

### Phase 1: Core Implementation

- [ ] Add guardrail parameters to redactor loading in worker.py
- [ ] Update FieldMaskRedactor to accept and apply core guardrails
- [ ] Update RegexMaskRedactor to accept and apply core guardrails
- [ ] Ensure "more restrictive wins" logic

### Phase 2: Testing

- [ ] Test: core guardrail overrides plugin when more restrictive
- [ ] Test: plugin guardrail applies when more restrictive than core
- [ ] Test: None core guardrail preserves plugin behavior
- [ ] Test: both max_depth and max_keys_scanned work

### Phase 3: Cleanup

- [ ] Update CHANGELOG
- [ ] Verify existing tests still pass

---

## Tests

### Unit Tests

- `tests/unit/plugins/redactors/test_guardrails.py`
  - `test_core_max_depth_overrides_plugin`
  - `test_plugin_max_depth_when_more_restrictive`
  - `test_core_max_keys_overrides_plugin`
  - `test_none_core_guardrail_uses_plugin_default`
  - `test_guardrails_emit_warning_when_exceeded`

---

## Definition of Done

### Code Complete

- [ ] All acceptance criteria implemented
- [ ] Code follows project patterns
- [ ] No new linting errors

### Quality Assurance

- [ ] Unit tests written and passing
- [ ] `ruff check` passes
- [ ] `mypy` passes
- [ ] No regression in existing tests

### Documentation

- [ ] Code has docstrings where needed
- [ ] CHANGELOG updated

---

## Risks / Rollback

### Risks

1. **Risk:** Breaking change if users relied on core guardrails being ignored
   - **Mitigation:** This is a bug fix - settings should work as documented

2. **Risk:** Performance impact from additional checks
   - **Mitigation:** Single comparison per redactor init, negligible

### Rollback Plan

If issues occur:
1. Set core guardrails to None to restore current behavior

---

## Related Stories

- **Enables:** Story 4.60 - Document guardrails and precedence

---

## Change Log

| Date | Change | Author |
|------|--------|--------|
| 2026-01-28 | Initial draft from GPT-5.2 audit | Claude |
| 2026-01-28 | Revised: split from docs-only to code story after finding core guardrails non-functional | Claude |
