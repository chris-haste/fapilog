# Story 5.28: Unify Sync/Async Logger Factory Functions

## Status: Planned

## Priority: High

## Estimated Effort: Medium (2-3 days)

## Dependencies

- **Depends on:** Story 5.25 (Extract Config Builders)
- **Prerequisite for:** None
- **Related to:** Story 6.8 (if exists, regarding facade unification)

## Epic / Series

Part of Series 5.x: Plugin System Completion & Enhancement

---

## Context / Background

The `src/fapilog/__init__.py` file contains two nearly identical logger factory functions:

- `get_logger()` (lines 958-1089) - ~132 lines
- `get_async_logger()` (lines 1092-1216) - ~125 lines

These functions are **~95% identical**. The only meaningful difference is:
- `get_logger()` calls `_start_plugins_sync()` (synchronous plugin startup)
- `get_async_logger()` calls `await _start_plugins()` (async plugin startup)

This duplication creates problems:

1. **Bug propagation risk:** Fixes must be applied twice
2. **Feature drift:** New parameters may be added to one but not the other
3. **Maintenance burden:** ~250 lines of duplicated logic
4. **Cognitive load:** "Why are there two nearly identical functions?" creates confusion

The Human Understandability Audit identified this as a **P1 issue** - high leverage improvement.

---

## User Story

**As a** fapilog maintainer
**I want** a single internal logger creation function
**So that** bug fixes and features are implemented once and work for both sync and async loggers

---

## Scope (In / Out)

### In Scope

- Create a unified `_create_logger_common()` function containing shared logic
- Refactor `get_logger()` to use the common function
- Refactor `get_async_logger()` to use the common function
- Reduce duplication to <20 lines per public function
- Maintain identical public API and behavior

### Out of Scope

- Unifying `SyncLoggerFacade` and `AsyncLoggerFacade` classes (different story)
- Changing public API signatures
- Adding new logger factory parameters

---

## Acceptance Criteria

### AC1: Common Function Created

- [ ] New internal function `_create_logger_common()` or similar exists
- [ ] Function contains all shared validation, preset handling, format resolution
- [ ] Function returns a setup object or tuple that callers complete

### AC2: Factory Functions Simplified

- [ ] `get_logger()` reduced to <30 lines (call common + sync-specific logic)
- [ ] `get_async_logger()` reduced to <30 lines (call common + async-specific logic)
- [ ] Total duplication reduced by at least 80%

### AC3: Behavior Unchanged

- [ ] All existing tests pass without modification
- [ ] Public API signatures unchanged
- [ ] Error messages unchanged
- [ ] Plugin startup behavior identical

### AC4: Code Quality

- [ ] New function has comprehensive docstring
- [ ] Type hints complete and mypy passes
- [ ] No new linting warnings

---

## Technical Design / Implementation Notes

### Architecture Decisions

1. **Strategy pattern:** Common function prepares everything; caller handles sync/async divergence
2. **Return intermediate state:** Common function returns a setup dataclass; callers complete initialization
3. **Keep public functions as thin wrappers:** All logic in common function

### Proposed Refactoring

The existing `_LoggerSetup` dataclass (lines 741-755) already captures common configuration. Extend this pattern:

```python
def _prepare_logger(
    name: str | None,
    *,
    preset: str | None,
    format: Literal["json", "pretty", "auto"] | None,
    settings: Settings | None,
    sinks: list[object] | None,
    auto_detect: bool,
    environment: str | None,
) -> tuple[_LoggerSetup, Settings]:
    """Prepare logger configuration without starting plugins.

    Returns setup object and resolved settings. Caller must:
    1. Start plugins (sync or async)
    2. Create facade
    3. Apply extras
    4. Start logger
    """
    # All the shared validation, preset handling, format resolution
    # Currently duplicated in get_logger() and get_async_logger()
    ...
    return setup, cfg_source


def get_logger(...) -> SyncLoggerFacade:
    """Return a sync logger."""
    setup, cfg = _prepare_logger(name, preset=preset, ...)

    # Sync-specific: start plugins synchronously
    enrichers, redactors, processors, filters = _start_plugins_sync(...)

    # Create facade (shared pattern)
    logger = _create_facade(setup, cfg, SyncLoggerFacade, ...)
    _apply_logger_extras(logger, setup, ...)
    logger.start()
    return logger


async def get_async_logger(...) -> AsyncLoggerFacade:
    """Return an async logger."""
    setup, cfg = _prepare_logger(name, preset=preset, ...)

    # Async-specific: start plugins asynchronously
    enrichers = await _start_plugins(setup.enrichers, "enricher")
    # ... etc

    logger = _create_facade(setup, cfg, AsyncLoggerFacade, ...)
    _apply_logger_extras(logger, setup, ...)
    logger.start()
    return logger
```

### Implementation Approach

1. Identify all shared code between `get_logger()` and `get_async_logger()`
2. Extract to `_prepare_logger()` function
3. Optionally extract `_create_facade()` for facade instantiation
4. Update both public functions to use new helpers
5. Verify identical behavior with tests

### Code Locations

- Primary file to modify:
  - `src/fapilog/__init__.py`
- Test files:
  - Existing tests should pass unchanged
  - Add tests for `_prepare_logger()` specifically

### Shared Code to Extract

Both functions currently duplicate:
- Mutual exclusivity validation (format/settings, preset/settings, environment/settings)
- Preset loading and application
- Environment detection and configuration
- Format resolution
- `_configure_logger_common()` call
- Facade instantiation parameters
- `_apply_logger_extras()` call
- `logger.start()` call

Only difference:
- `_start_plugins_sync()` vs `await _start_plugins()`

---

## Tasks

### Phase 1: Analysis
- [ ] Map exactly which lines are shared vs different
- [ ] Identify the minimal divergence point
- [ ] Design return type for `_prepare_logger()`

### Phase 2: Extraction
- [ ] Create `_prepare_logger()` function
- [ ] Move shared validation logic
- [ ] Move preset/environment handling
- [ ] Move format resolution

### Phase 3: Refactoring
- [ ] Update `get_logger()` to use `_prepare_logger()`
- [ ] Update `get_async_logger()` to use `_prepare_logger()`
- [ ] Run tests after each change

### Phase 4: Cleanup
- [ ] Remove any remaining duplication
- [ ] Add docstrings
- [ ] Verify line count reduction

---

## Tests

### Unit Tests

- [ ] Test `_prepare_logger()` validation (mutual exclusivity errors)
- [ ] Test `_prepare_logger()` preset resolution
- [ ] Test `_prepare_logger()` environment auto-detection
- [ ] Test `_prepare_logger()` format resolution

### Integration Tests

- [ ] All existing `get_logger()` tests pass
- [ ] All existing `get_async_logger()` tests pass
- [ ] Preset-based creation works for both
- [ ] Environment-based creation works for both

### Regression Tests

- [ ] Error messages unchanged
- [ ] Parameter validation unchanged
- [ ] Plugin startup behavior unchanged

---

## Documentation Updates

- [ ] Add docstring to `_prepare_logger()` explaining its role
- [ ] No public API changes, no user-facing docs needed
- [ ] No CHANGELOG entry (internal refactor)

---

## Definition of Done

### Code Complete
- [ ] All acceptance criteria met
- [ ] `get_logger()` < 30 lines
- [ ] `get_async_logger()` < 30 lines
- [ ] Type checking passes
- [ ] No linting errors

### Quality Assurance
- [ ] All existing tests pass
- [ ] No behavior changes
- [ ] Duplication reduced by >= 80%

### Review & Release
- [ ] Code review approved
- [ ] CI/CD pipeline passing

### Backwards Compatibility
- [ ] Public API unchanged
- [ ] All tests pass without modification

---

## Risks / Rollback / Monitoring

### Risks

- **Risk 1:** Subtle behavior difference between sync and async paths
  - **Mitigation:** Careful line-by-line comparison; run both test suites
- **Risk 2:** Plugin startup timing changes
  - **Mitigation:** Keep startup logic in same relative position

### Rollback Plan

- Revert commit
- No data migration; pure refactor

### Success Metrics

- Combined factory function code reduced from ~260 lines to ~80 lines
- All tests pass
- No new issues after merge

---

## Related Documents

- [5.0 Series Overview](./5.0-series-overview.md)
- [Human Understandability Audit Report](#) - P1 recommendation #1
- [Story 5.25: Extract Config Builders](./5.25.extract-config-builders-from-init.md)

---

## Change Log

| Date       | Change                 | Author |
| ---------- | ---------------------- | ------ |
| 2026-01-14 | Initial story creation | Claude |
