# Story 10.21: Enable Redaction by Default in FastAPI Preset

**Status:** Ready for Code Review
**Priority:** High
**Depends on:** Story 10.1 (Configuration Presets) - Complete

---

## Context / Background

The `fastapi` preset in `src/fapilog/core/presets.py:79-90` currently disables all redactors:

```python
"fastapi": {
    "core": {
        ...
        "redactors": [],  # Explicit opt-out for API debugging
    },
    ...
}
```

This creates a security gap. The preset's other configuration choices signal production-like usage:
- `log_level: INFO` (not DEBUG)
- `batch_max_size: 50` (optimized for throughput, not immediate debugging)
- Stdout-only output (container deployment pattern)

Users selecting `preset="fastapi"` for their production FastAPI deployments will unknowingly disable PII redaction. Container logs typically flow to centralized systems (CloudWatch, Datadog, Splunk) where leaked credentials and PII create compliance risks.

The `dev` preset already exists for debugging scenarios where full visibility is needed. There's no reason the `fastapi` preset should compromise on security.

---

## Scope (In / Out)

### In Scope

- Enable redactors in the `fastapi` preset matching `production` preset defaults
- Update preset documentation to reflect the change
- Update tests to verify redaction is enabled
- Add migration note for users relying on current behavior

### Out of Scope

- Creating a separate `fastapi_dev` preset (can be considered in future story if demand exists)
- Changing redaction patterns themselves (covered by other stories)
- Performance optimization of redactors (separate concern)

---

## Acceptance Criteria

### AC1: FastAPI Preset Enables Redactors

**Description:** The `fastapi` preset must enable the same redactors as the `production` preset.

**Validation:**
```python
from fapilog.core.presets import get_preset

fastapi_config = get_preset("fastapi")
production_config = get_preset("production")

# FastAPI preset enables redactors
assert fastapi_config["core"]["redactors"] == ["field_mask", "regex_mask", "url_credentials"]

# Redactor config matches production
assert "redactor_config" in fastapi_config
assert fastapi_config["redactor_config"] == production_config["redactor_config"]
```

### AC2: Sensitive Data is Redacted in FastAPI Preset Logs

**Description:** Logs produced using the `fastapi` preset must redact sensitive fields.

**Validation:**
```python
from fapilog import get_logger
import json

logger = get_logger(preset="fastapi")

# Capture log output
output = capture_stdout(lambda: logger.info("login", password="secret123", api_key="key456"))
log_entry = json.loads(output)

# Sensitive fields are redacted
assert log_entry["metadata"]["password"] == "[REDACTED]"
assert log_entry["metadata"]["api_key"] == "[REDACTED]"
```

### AC3: URL Credentials Redacted

**Description:** URLs containing credentials in query parameters or userinfo must be redacted.

**Validation:**
```python
logger = get_logger(preset="fastapi")

output = capture_stdout(lambda: logger.info("request", url="https://user:pass@api.example.com/data?token=abc123"))
log_entry = json.loads(output)

# Credentials in URL are redacted
assert "pass" not in log_entry["metadata"]["url"]
assert "abc123" not in log_entry["metadata"]["url"]
```

### AC4: Documentation Updated

**Description:** Preset documentation reflects that `fastapi` preset now includes redaction.

**Validation:**
- `docs/user-guide/configuration.md` preset table shows redaction enabled for `fastapi`
- `docs/integrations/fastapi.md` mentions redaction is enabled by default
- Comment in `presets.py` updated to remove "opt-out" language

### AC5: Backwards Compatibility Note

**Description:** Users relying on disabled redaction have a clear migration path.

**Validation:**
- CHANGELOG entry documents the breaking change
- Documentation shows how to disable redaction if needed:
```python
# If you need to disable redaction (not recommended for production)
from fapilog import get_logger, Settings

settings = Settings(
    core={"log_level": "INFO", "redactors": []},
    # ... other fastapi-like settings
)
logger = get_logger(settings=settings)
```

---

## Implementation Notes

### File Changes

```
src/fapilog/core/presets.py (MODIFIED - enable redactors in fastapi preset)
tests/unit/test_presets.py (MODIFIED - update assertions)
tests/unit/test_redaction_defaults.py (MODIFIED - add fastapi preset test)
docs/user-guide/configuration.md (MODIFIED - update preset table)
docs/integrations/fastapi.md (MODIFIED - note redaction enabled)
CHANGELOG.md (MODIFIED - document breaking change)
```

### Key Code Change

```python
# src/fapilog/core/presets.py

"fastapi": {
    "core": {
        "log_level": "INFO",
        "batch_max_size": 50,
        "sinks": ["stdout_json"],
        "enrichers": ["context_vars"],
        "redactors": ["field_mask", "regex_mask", "url_credentials"],  # Security by default
    },
    "enricher_config": {
        "context_vars": {},
    },
    "redactor_config": {
        "field_mask": {
            "fields_to_mask": [
                "metadata.password",
                "metadata.api_key",
                "metadata.token",
                "metadata.secret",
                "metadata.authorization",
                "metadata.api_secret",
                "metadata.private_key",
                "metadata.ssn",
                "metadata.credit_card",
            ],
        },
        "regex_mask": {
            "patterns": [
                r"(?i).*password.*",
                r"(?i).*passwd.*",
                r"(?i).*api[_-]?key.*",
                r"(?i).*apikey.*",
                r"(?i).*secret.*",
                r"(?i).*token.*",
                r"(?i).*authorization.*",
                r"(?i).*private[_-]?key.*",
                r"(?i).*ssn.*",
                r"(?i).*credit[_-]?card.*",
            ],
        },
        "url_credentials": {},
    },
},
```

---

## Tasks

### Phase 1: Core Implementation

- [ ] Update `fastapi` preset in `src/fapilog/core/presets.py` to enable redactors
- [ ] Copy `redactor_config` from `production` preset to `fastapi` preset
- [ ] Update inline comment to reflect security posture

### Phase 2: Testing

- [ ] Update `tests/unit/test_presets.py` - fastapi preset structure assertions
- [ ] Add test in `tests/unit/test_redaction_defaults.py` for fastapi preset
- [ ] Remove `fastapi` from `test_preset_explicitly_opts_out` parametrized list in `test_redaction_defaults.py`
- [ ] Add integration test verifying redaction works with fastapi preset
- [ ] Verify no regression in other preset tests

### Phase 3: Documentation

- [ ] Update preset comparison table in `docs/user-guide/configuration.md`
- [ ] Update `docs/integrations/fastapi.md` to mention redaction
- [ ] Add CHANGELOG entry documenting the breaking change
- [ ] Add migration guidance for users needing to disable redaction

---

## Tests

### Unit Tests

- `tests/unit/test_presets.py`
  - `test_fastapi_preset_enables_redactors` - verify redactors list
  - `test_fastapi_preset_has_redactor_config` - verify config present
  - `test_fastapi_preset_redactor_config_matches_production` - parity check

### Integration Tests

- `tests/integration/test_preset_integration.py`
  - `test_fastapi_preset_redacts_password` - end-to-end redaction
  - `test_fastapi_preset_redacts_url_credentials` - URL credential handling

---

## Definition of Done

### Code Complete

- [ ] `fastapi` preset enables `["field_mask", "regex_mask", "url_credentials"]`
- [ ] `redactor_config` added to fastapi preset matching production
- [ ] Inline comment updated

### Quality Assurance

- [ ] Unit tests written and passing
- [ ] Integration tests written and passing
- [ ] `ruff check` passes
- [ ] `mypy` passes
- [ ] `vulture` passes (no dead code)
- [ ] No regression in existing tests

### Documentation

- [ ] Preset comparison table updated
- [ ] FastAPI integration docs updated
- [ ] CHANGELOG entry added with migration note
- [ ] Breaking change clearly documented

---

## Risks / Rollback

### Risks

1. **Risk:** Breaking change for users relying on disabled redaction
   - **Mitigation:** Clear CHANGELOG entry and migration documentation
   - **Mitigation:** Users can easily override via Settings if needed

2. **Risk:** Performance regression from added redaction processing
   - **Mitigation:** Redaction overhead is minimal (<1ms per log entry)
   - **Mitigation:** Can benchmark before/after if concerned

3. **Risk:** Over-redaction masking legitimate debug data
   - **Mitigation:** Same patterns as production preset (already validated)
   - **Mitigation:** Users needing full visibility should use `dev` preset

### Rollback Plan

If issues occur:
1. Revert the preset change in `presets.py`
2. Update tests back to previous assertions
3. Remove CHANGELOG entry or mark as reverted

---

## Related Stories

- **Depends on:** Story 10.1 (Configuration Presets) - introduced preset system
- **Related:** Story 3.7 (Secure Defaults URL Credential Redaction) - redaction patterns
- **Related:** Story 4.47 (Redaction Defaults Alignment) - redaction configuration

---

## Change Log

| Date | Change | Author |
|------|--------|--------|
| 2026-01-19 | Initial draft | Claude |
