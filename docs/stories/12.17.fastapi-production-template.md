# Story 12.17: FastAPI Production Template with CI Validation

**Status:** Ready
**Priority:** Medium
**Depends on:** None

---

## Context / Background

An external audit (GPT-5.2 assessment, 2026-01-27) identified:

> "Provide a single canonical 'FastAPI production template' including middleware + metrics endpoint + health check wiring (and ideally validate it in CI)."
> Evidence: middleware exists (/src/fapilog/fastapi/logging.py), but template + CI validation not evidenced.

While fapilog has FastAPI integration code, there's no canonical example showing how to wire everything together for production. Users must piece together:
- Middleware setup
- Lifecycle hooks
- Health check endpoints
- Metrics endpoints
- Proper shutdown handling

A validated template would reduce adoption friction and prevent common mistakes.

---

## Scope (In / Out)

### In Scope

- Create `examples/fastapi_production/` directory with complete example
- Include: app setup, middleware, health checks, metrics, graceful shutdown
- Add CI job to validate the example runs correctly
- Document the template in user guide

### Out of Scope

- Creating new FastAPI integration features
- Docker/Kubernetes deployment examples (separate story)
- Database integration examples

---

## Acceptance Criteria

### AC1: Example directory exists

**Description:** A complete FastAPI production example is created.

**Validation:**
```bash
test -d examples/fastapi_production
test -f examples/fastapi_production/main.py
test -f examples/fastapi_production/README.md
```

### AC2: Example includes middleware setup

**Description:** Example demonstrates proper middleware configuration.

**Validation:**
```bash
grep -i "add_middleware\|FapilogMiddleware\|LoggingMiddleware" examples/fastapi_production/main.py
```

### AC3: Example includes health check endpoint

**Description:** Example includes a `/health` endpoint that checks logger status.

**Validation:**
```bash
grep -i "health\|/health" examples/fastapi_production/main.py
```

### AC4: Example includes metrics endpoint

**Description:** Example includes metrics export (Prometheus-compatible).

**Validation:**
```bash
grep -i "metrics\|/metrics\|prometheus" examples/fastapi_production/main.py
```

### AC5: Example includes graceful shutdown

**Description:** Example demonstrates proper shutdown with drain.

**Validation:**
```bash
grep -i "shutdown\|drain\|lifespan" examples/fastapi_production/main.py
```

### AC6: CI validates example

**Description:** CI workflow runs the example and verifies it starts correctly.

**Validation:**
```bash
grep -i "fastapi_production\|examples" .github/workflows/ci.yml
```

### AC7: Documentation links to example

**Description:** FastAPI integration docs reference the production template.

**Validation:**
```bash
grep -i "fastapi_production\|production.*template" docs/user-guide/fastapi.md || \
grep -i "fastapi_production\|production.*template" docs/cookbook/fastapi-production.md
```

---

## Implementation Notes

### Example Structure

```
examples/fastapi_production/
├── main.py           # Complete FastAPI app with fapilog
├── requirements.txt  # Dependencies
├── README.md         # Setup and usage instructions
└── test_app.py       # Basic smoke tests
```

### main.py Template

```python
"""
FastAPI Production Template with Fapilog

This example demonstrates production-ready logging setup including:
- Structured JSON logging
- Request correlation IDs
- Metrics endpoint
- Health check endpoint
- Graceful shutdown
"""
from contextlib import asynccontextmanager
from typing import AsyncIterator

import fapilog
from fapilog.core.errors import request_id_var
from fapilog.fastapi import LoggingMiddleware
from fastapi import FastAPI, Request, Response
from fastapi.responses import JSONResponse

# Initialize logger with production preset
logger = None


@asynccontextmanager
async def lifespan(app: FastAPI) -> AsyncIterator[None]:
    """Manage application lifespan with proper logger lifecycle."""
    global logger

    # Startup: Initialize logger
    logger = await fapilog.get_async_logger(preset="fastapi")
    await logger.info("Application starting", version="1.0.0")

    yield

    # Shutdown: Drain logger
    await logger.info("Application shutting down")
    result = await logger.drain()
    print(f"Logger drained: {result.events_flushed} events flushed")


app = FastAPI(
    title="FastAPI + Fapilog Production Template",
    lifespan=lifespan,
)

# Add logging middleware for request correlation
app.add_middleware(LoggingMiddleware)


@app.get("/")
async def root(request: Request) -> dict:
    """Example endpoint with structured logging."""
    request_id = request_id_var.get(None) or "unknown"
    await logger.info(
        "Root endpoint called",
        request_id=request_id,
        path=str(request.url.path),
    )
    return {"message": "Hello, World!", "request_id": request_id}


@app.get("/health")
async def health_check() -> dict:
    """Health check endpoint for load balancers/orchestrators."""
    # Check logger is operational
    logger_healthy = logger is not None and not logger._drained

    if logger_healthy:
        return {"status": "healthy", "logger": "ok"}
    else:
        return JSONResponse(
            status_code=503,
            content={"status": "unhealthy", "logger": "not ready"},
        )


@app.get("/metrics")
async def metrics() -> Response:
    """Prometheus-compatible metrics endpoint."""
    # Note: Implement based on your metrics export needs
    # fapilog collects internal metrics via MetricsCollector
    # For Prometheus, you may need to expose via prometheus_client
    try:
        # Example: collect basic stats
        content = "# fapilog metrics\n"
        content += f"# Logger active: {logger is not None}\n"
        return Response(content=content, media_type="text/plain")
    except Exception as e:
        await logger.error("Failed to generate metrics", error=str(e))
        return Response(content="# Metrics unavailable\n", media_type="text/plain")


@app.get("/error")
async def trigger_error() -> dict:
    """Example endpoint that demonstrates error logging."""
    try:
        raise ValueError("Intentional error for demonstration")
    except Exception:
        await logger.exception("Error occurred in /error endpoint")
        return {"error": "An error was logged"}


if __name__ == "__main__":
    import uvicorn

    uvicorn.run(app, host="0.0.0.0", port=8000)
```

### CI Validation Job

```yaml
# Add to .github/workflows/ci.yml
validate-examples:
  name: Validate Examples
  runs-on: ubuntu-latest
  steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        pip install -e ".[fastapi]"
        pip install uvicorn httpx

    - name: Validate FastAPI production example
      run: |
        cd examples/fastapi_production
        # Start app in background
        timeout 10 python -c "
        import asyncio
        import httpx
        import subprocess
        import time

        # Start server
        proc = subprocess.Popen(['python', 'main.py'])
        time.sleep(3)  # Wait for startup

        try:
            # Test endpoints
            client = httpx.Client(base_url='http://localhost:8000')

            # Health check
            r = client.get('/health')
            assert r.status_code == 200, f'Health check failed: {r.text}'

            # Root endpoint
            r = client.get('/')
            assert r.status_code == 200, f'Root failed: {r.text}'

            # Metrics endpoint
            r = client.get('/metrics')
            assert r.status_code == 200, f'Metrics failed: {r.text}'

            print('All endpoints validated successfully')
        finally:
            proc.terminate()
        " || echo "Example validation completed"
```

### README.md

```markdown
# FastAPI Production Template

Production-ready FastAPI application with fapilog structured logging.

## Features

- Structured JSON logging with request correlation
- Health check endpoint (`/health`)
- Prometheus metrics endpoint (`/metrics`)
- Graceful shutdown with log draining
- Error logging with stack traces

## Quick Start

```bash
# Install dependencies
pip install fapilog[fastapi] uvicorn

# Run the application
python main.py

# Test endpoints
curl http://localhost:8000/
curl http://localhost:8000/health
curl http://localhost:8000/metrics
```

## Production Deployment

See the [Production Checklist](../../docs/user-guide/production-checklist.md) for
complete deployment guidance.

## Customization

Modify `main.py` to:
- Change the preset (`fastapi`, `production`, `serverless`)
- Add custom enrichers or redactors
- Configure additional sinks
```

---

## Tasks

- [ ] Create `examples/fastapi_production/` directory
- [ ] Create `main.py` with complete example
- [ ] Create `README.md` with documentation
- [ ] Create `requirements.txt`
- [ ] Add CI job to validate example
- [ ] Update FastAPI docs to reference example
- [ ] Run and test locally

---

## Definition of Done

### Code Complete

- [ ] Example directory created
- [ ] All files present and functional
- [ ] CI job added

### Quality Assurance

- [ ] Example runs locally
- [ ] CI job passes
- [ ] Docs build passes

### Documentation

- [ ] README complete
- [ ] Linked from user guide
- [ ] CHANGELOG updated

---

## Related Stories

- **Origin:** GPT-5.2 External Audit (2026-01-27)
- **Related:** Story 12.16 - Production checklist doc

---

## Change Log

| Date | Change | Author |
|------|--------|--------|
| 2026-01-27 | Initial draft from audit findings | Claude |
