# Story 4.41: Sink Failure Signaling and Fallback Policy

**Status:** Draft  
**Priority:** High  
**Depends on:** Story 10.6 (Enhanced Default Behaviors)  
**Effort:** 2-3 days

---

## Context / Background

Story 10.6 introduced stderr fallback on sink write failures. Today, most built-in
sinks **swallow write errors**, so the core rarely sees failures and fallback
doesn't activate. This prevents reliable log-loss mitigation and makes circuit
breaker behavior less effective.

We need a **best-in-class sink contract** that surfaces failures to the core
without breaking user applications.

---

## Scope (In / Out)

### In Scope

- Define explicit sink failure signaling (exception and/or return value).
- Update BaseSink documentation and protocol to reflect the new contract.
- Update built-in sinks to signal failures (not swallow).
- Core should treat signaled failures as failures for fallback/circuit breaker.
- Add tests for failure signaling and fallback integration.
- Document migration guidance for third-party sink authors.

### Out of Scope

- New sink types or new destinations.
- Changing fallback policy behavior (stderr fallback remains the same).
- Changes to unrelated plugin types (enrichers, processors, redactors).

---

## Acceptance Criteria

1. **Explicit failure signaling contract**
   - A sink **signals failure** by raising a `SinkWriteError` (preferred).
   - For compatibility, a sink may return `False` from `write`/`write_serialized`
     to indicate failure (core treats it as failure).
   - Sinks should not swallow write failures silently.

2. **Core handles failures safely**
   - Core catches sink failures, emits diagnostics, and triggers fallback.
   - No sink failure propagates to user code.
   - Circuit breaker counts a signaled failure as a failure.

3. **Built-in sinks comply**
   - `stdout_json`, `stdout_pretty`, `rotating_file`, `http`, `webhook`, and
     contrib sinks are updated to signal failures.
   - On impossible-to-detect failures, sinks emit diagnostics and return `False`.

4. **Tests**
   - Unit tests cover:
     - `SinkWriteError` handling in fanout and routing writers.
     - `False` return value handling.
     - Updated sink error paths (at least stdout + rotating file).
   - Integration tests confirm fallback triggers on signaled failures.

5. **Docs**
   - Update plugin author docs with the new contract and examples.
   - Add migration guidance for third-party sinks.

---

## Implementation Notes

- Introduce `SinkWriteError` (new exception) in `src/fapilog/core/errors.py`
  or `src/fapilog/plugins/sinks/errors.py`.
- Update BaseSink docstring in `src/fapilog/plugins/sinks/__init__.py`:
  - Replace "errors must be contained" with "errors must be signaled to core".
  - Clarify that core contains exceptions to protect user code.
- Update `_fanout_writer` and `RoutingSinkWriter` to treat `False` return values
  as failures (trigger diagnostics + fallback).
- Built-in sinks:
  - Replace blanket `except Exception: return None` with `raise SinkWriteError`
    (include sink name + underlying error).
  - Where a sink cannot reliably detect errors, emit diagnostics and return `False`.
- Keep the stderr fallback policy from Story 10.6.

---

## Tasks

- [ ] Add `SinkWriteError` class and exports.
- [ ] Update BaseSink documentation and protocol signature (`-> bool | None`).
- [ ] Update core writers to treat `False` as failure.
- [ ] Update built-in sinks to signal failures:
  - [ ] stdout_json
  - [ ] stdout_pretty
  - [ ] rotating_file
  - [ ] http
  - [ ] webhook
  - [ ] contrib sinks (cloudwatch, loki, postgres, audit)
- [ ] Add unit tests for signaled failures (raise + return False).
- [ ] Add integration tests for fallback on signaled failures.
- [ ] Update plugin author docs (`docs/plugins/error-handling.md` or similar).
- [ ] Update CHANGELOG for the new contract.

---

## Tests

### Unit Tests

- `tests/unit/test_sink_failure_signaling.py`
  - fanout writer handles `SinkWriteError`
  - fanout writer handles `False` return values
  - routing writer handles `SinkWriteError`
  - routing writer handles `False` return values

- Update existing sink tests to assert failures signal `SinkWriteError`.

### Integration Tests

- `tests/integration/test_sink_fallback_signaling.py`
  - `get_logger` with a sink that raises `SinkWriteError` triggers fallback
  - `get_logger` with a sink returning `False` triggers fallback

---

## Risks / Rollback / Monitoring

### Risks

- **Breaking behavior for third-party sinks** that swallow errors.
- **Behavioral change** in how sink failures are surfaced to diagnostics.

### Mitigation

- Allow `False` return values as a compatibility path.
- Clear migration guidance for sink authors.

### Rollback

- Revert BaseSink doc changes and built-in sink updates; core handling can stay
  permissive without breaking existing sinks.
