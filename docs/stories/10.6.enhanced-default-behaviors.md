# Story 10.6: Enhanced Default Behaviors

## Status: Planned

## Priority: High

## Estimated Effort: Medium (2-3 days)

## Dependencies

- **Depends on:** Story 10.1 (Configuration Presets) - Builds on preset system
- **Depends on:** Story 10.2 (Pretty Console Output) - Uses format detection
- **Depends on:** Story 10.8 (Smart Environment Auto-Detection) - Uses environment detection

## Epic / Series

Part of Epic 10: Developer Experience and Ergonomics / Series 10.x

---

## Context / Background

Users should get sensible logging defaults without configuration. Defaults should adapt to common environments while staying predictable and safe.

## Scope (In / Out)

### In Scope

- Smart defaults for log level, output format, and enrichment.
- Environment-sensitive behaviors (dev, production, CI, container).
- Graceful sink fallback behavior on failure.
- Security defaults for redaction in production.

### Out of Scope

- Full environment auto-detection and configuration overrides (see Story 10.8).
- New sink types or external integrations.

## Acceptance Criteria

1. Log level defaults to DEBUG for interactive TTY, INFO for production and CI.
2. Output format defaults to pretty for TTY and JSON for non-TTY.
3. Context enrichment includes baseline fields; production adds host/pid/env/version.
4. Docker or Kubernetes environments add container metadata when detected.
5. Sink failures fall back to stderr or file with a warning and without data loss.
6. Security defaults redact common sensitive fields in production preset.
7. Tests validate default selection and fallback behavior.

## Implementation Notes

- Add a default selection helper in `src/fapilog/core/defaults.py` or similar.
- Detect environment using env vars and lightweight filesystem checks.
- Assumption: explicit settings always override defaults.

## Tasks

- [ ] Implement default selection helpers for level, format, and enrichment.
- [ ] Add environment detection helpers (TTY, CI vars, Docker/K8s hints).
- [ ] Add fallback handling in sink write path with warnings (likely `src/fapilog/plugins/sinks/routing.py`).
- [ ] Update Settings defaults and documentation references.
- [ ] Add tests in `tests/unit/test_logger_setup.py` and `tests/unit/test_sink_routing.py`.

## Tests

- Unit: TTY vs non-TTY default format selection.
- Unit: CI environment forces INFO and JSON.
- Unit: Docker/K8s metadata enrichment when detected.
- Integration: sink failure triggers fallback without exceptions.

## Definition of Done

Story is complete when ALL of the following are true:

### Code Complete
- [ ] All acceptance criteria met and verified
- [ ] All tasks completed
- [ ] Code follows project style guide
- [ ] No linting errors or warnings
- [ ] Type checking passes (mypy strict)

### Quality Assurance
- [ ] Unit tests: >90% coverage of new code
- [ ] Integration tests: all scenarios passing
- [ ] Regression tests: no existing functionality broken
- [ ] Performance tests: no regression vs baseline
- [ ] Manual testing completed (if applicable)

### Documentation
- [ ] User-facing docs updated
- [ ] API reference updated (if applicable)
- [ ] Code examples added/updated
- [ ] CHANGELOG.md updated
- [ ] Inline code documentation complete

### Review & Release
- [ ] Code review approved
- [ ] Documentation reviewed for clarity
- [ ] CI/CD pipeline passing
- [ ] Ready for merge to main branch

### Backwards Compatibility
- [ ] No breaking changes OR breaking changes documented with migration guide
- [ ] Existing tests still pass
- [ ] Deprecation warnings added (if applicable)

---

## Risks / Rollback / Monitoring

### Risks

- **Risk:** Environment detection misclassifies and changes output unexpectedly
  - **Mitigation:** Conservative detection, allow opt-out, clear documentation

- **Risk:** Fallback behavior causes confusion
  - **Mitigation:** Clear warnings, document fallback behavior

### Rollback Plan

- Keep helper isolated
- Allow opt-out via explicit settings
- Defaults can be reverted easily

### Success Metrics / Monitoring

- Track warnings emitted for fallback paths
- Monitor environment detection accuracy
- User feedback on default behavior

---

## Related Documents

- [Story 10.0: Series Overview](./10.0-series-overview.md)
- [Story 10.1: Configuration Presets](./10.1.configuration-presets.md)
- [Story 10.2: Pretty Console Output](./10.2.pretty-console-output.md)
- [Story 10.8: Smart Environment Auto-Detection](./10.8.smart-environment-auto-detection.md)
- [Epic 10: Developer Experience](../prd/epic-10-DX-Experience.md)

---

## Change Log

| Date       | Change                    | Author |
| ---------- | ------------------------- | ------ |
| 2025-01-10 | Migrated to new format    | System |
