# Story 10.5: Simplified File Rotation API

## Status: Planned

## Priority: Medium

## Estimated Effort: Medium (2-3 days)

## Dependencies

- **Depends on:** Story 10.4 (Human-Readable Config Strings) - Uses parsing for rotation/retention

## Epic / Series

Part of Epic 10: Developer Experience and Ergonomics / Series 10.x

---

## Context / Background

Adding file rotation requires Settings objects and sink wiring. A simple `logger.add_file` method should cover the most common use cases while remaining compatible with Settings-based configuration.

## Scope (In / Out)

### In Scope

- `logger.add_file()` helper with rotation, retention, compression, level, and format options.
- Support for multiple file sinks and sink removal by ID.
- Validation of rotation and retention arguments before registering sinks.

### Out of Scope

- Replacing Settings-based sink configuration.
- New sink types beyond rotating file.

## Acceptance Criteria

1. `logger.add_file(path, rotation=..., retention=..., compression=..., level=..., format=...)` registers a file sink.
2. Multiple file sinks can be added independently.
3. Rotation supports size-based and time-based options (daily, hourly, weekly, monthly, or specific time).
4. `add_file` returns a sink ID and `remove_sink(id)` unregisters it.
5. Invalid rotation or retention formats return clear errors.
6. Works alongside Settings-based sinks without re-creating the logger.
7. Tests cover add, remove, multiple sinks, and error paths.

## Implementation Notes

- Add `add_file` and `remove_sink` to the logger facade in `src/fapilog/core/logger.py`.
- Use `RotatingFileSink` in `src/fapilog/plugins/sinks/rotating_file.py` and existing routing logic to attach new sinks.
- Assumption: dynamic sink registration can reuse the existing sink write path without restarting the logger.

## Tasks

- [ ] Implement `add_file` and `remove_sink` in the logger facade (`src/fapilog/core/logger.py`).
- [ ] Add a lightweight registry for dynamic sinks (UUIDs) and integrate with routing/fanout writer.
- [ ] Reuse human-readable parsing from Story 10.4 for rotation and retention inputs.
- [ ] Update docs with examples in README and settings guide.
- [ ] Add tests in `tests/unit/test_logger_sinks.py` and `tests/unit/test_rotating_file_sink.py`.

## Tests

- Unit: `add_file` creates a sink with expected config.
- Unit: multiple file sinks route at correct levels.
- Unit: `remove_sink` stops and unregisters the sink.
- Unit: invalid rotation/retention raises clear errors.

## Definition of Done

Story is complete when ALL of the following are true:

### Code Complete
- [ ] All acceptance criteria met and verified
- [ ] All tasks completed
- [ ] Code follows project style guide
- [ ] No linting errors or warnings
- [ ] Type checking passes (mypy strict)

### Quality Assurance
- [ ] Unit tests: >90% coverage of new code
- [ ] Integration tests: all scenarios passing
- [ ] Regression tests: no existing functionality broken
- [ ] Performance tests: no regression vs baseline
- [ ] Manual testing completed (if applicable)

### Documentation
- [ ] User-facing docs updated
- [ ] API reference updated (if applicable)
- [ ] Code examples added/updated
- [ ] CHANGELOG.md updated
- [ ] Inline code documentation complete

### Review & Release
- [ ] Code review approved
- [ ] Documentation reviewed for clarity
- [ ] CI/CD pipeline passing
- [ ] Ready for merge to main branch

### Backwards Compatibility
- [ ] No breaking changes OR breaking changes documented with migration guide
- [ ] Existing tests still pass
- [ ] Deprecation warnings added (if applicable)

---

## Risks / Rollback / Monitoring

### Risks

- **Risk:** Dynamic sink changes introduce routing regressions
  - **Mitigation:** Comprehensive tests, isolate dynamic registry

- **Risk:** Thread safety issues with dynamic sink registration
  - **Mitigation:** Use locks, test concurrent access

### Rollback Plan

- Keep dynamic sink registry behind new API paths only
- Settings-based configuration remains unchanged
- Can disable dynamic registration if needed

### Success Metrics / Monitoring

- Track sink errors and ensure they are contained
- Monitor dynamic sink usage
- User feedback on API usability

---

## Related Documents

- [Story 10.0: Series Overview](./10.0-series-overview.md)
- [Story 10.4: Human-Readable Config Strings](./10.4.human-readable-config-strings.md)
- [Epic 10: Developer Experience](../prd/epic-10-DX-Experience.md)

---

## Change Log

| Date       | Change                    | Author |
| ---------- | ------------------------- | ------ |
| 2025-01-10 | Migrated to new format    | System |
