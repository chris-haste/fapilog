# Story 10.32: Production Safety Defaults Hardening

**Status:** Ready for Code Review
**Priority:** Low
**Depends on:** None

---

## Context / Background

An external audit (GPT-5.2 assessment, 2026-01-27) identified several default values that may surprise users in production environments:

### Issue 1: Postgres sink auto-creates tables by default

```python
# src/fapilog/plugins/sinks/contrib/postgres.py:62
create_table: bool = Field(default=True)
```

In regulated environments, DDL execution at runtime may violate change management policies or fail due to restricted permissions. Users discovering this behavior in production is undesirable.

### Issue 2: Plugin metadata helper uses wrong version default

```python
# src/fapilog/plugins/metadata.py:204
compatibility=PluginCompatibility(min_fapilog_version="3.0.0")
```

The project is at version 0.7.x, but the helper defaults to requiring version 3.0.0. This is confusing for plugin authors and will cause compatibility check failures.

### Issue 3: Worker loop uses fixed 1ms sleep

```python
# src/fapilog/core/worker.py:227
await asyncio.sleep(0.001)
```

While not a correctness issue, this causes unnecessary CPU wakeups when the queue is empty. An event-based approach would be more efficient.

---

## Scope (In / Out)

### In Scope

- Document Postgres `create_table` behavior prominently with warning
- Disable `create_table` by default in production preset sink config
- Fix plugin metadata helper to use sensible default version
- Replace fixed sleep with event-based wakeup in worker loop

### Out of Scope

- Changing Postgres sink global default (only preset default)
- Major worker loop redesign
- Adding plugin marketplace features

---

## Acceptance Criteria

### AC1: Postgres create_table documented with warning

**Description:** The Postgres sink documentation clearly warns about auto-DDL behavior.

**Validation:**
```bash
# Docs should contain a warning about create_table
grep -i "warning\|caution\|note" docs/plugins/sinks/postgres.md | grep -i "create_table\|ddl\|schema"
```

### AC2: Production preset disables auto table creation

**Description:** The `production` preset sets `create_table=False` for Postgres sink config.

**Validation:**
```python
from fapilog.core.presets import get_preset

preset = get_preset("production")
# Check that sink_config.postgres.create_table is False
postgres_config = preset.get("sink_config", {}).get("postgres", {})
assert postgres_config.get("create_table") is False
```

### AC3: Production preset documentation updated

**Description:** Documentation notes that production preset disables Postgres auto-DDL.

**Validation:**
```bash
# Configuration docs should mention the production preset Postgres behavior
grep -A10 "production" docs/user-guide/configuration.md | grep -i "create_table\|postgres\|ddl"
```

### AC4: Plugin metadata helper uses reasonable default

**Description:** `create_plugin_metadata()` defaults to a minimum version that makes sense for 0.x releases.

**Validation:**
```python
from fapilog.plugins.metadata import create_plugin_metadata

metadata = create_plugin_metadata(
    name="test",
    version="1.0.0",
    plugin_type="sink",
    entry_point="test:TestSink",
)
# Should NOT require fapilog 3.0.0
assert metadata.compatibility.min_fapilog_version != "3.0.0"
# Should use a sensible default like "0.1.0"
assert metadata.compatibility.min_fapilog_version == "0.1.0"
```

### AC5: Worker loop uses event-based wakeup

**Description:** The worker loop waits on an asyncio.Event instead of fixed sleep when queue is empty.

**Validation:**
```python
# Worker should have an _enqueue_event that gets set on enqueue
# and cleared after wakeup
from fapilog.core.worker import LoggerWorker

# Verify the worker accepts an enqueue_event parameter
import inspect
sig = inspect.signature(LoggerWorker.__init__)
assert "enqueue_event" in sig.parameters
```

### AC6: Worker wakes immediately on enqueue

**Description:** When an item is enqueued, the worker wakes up immediately instead of waiting up to 1ms.

**Validation:**
```python
import asyncio
import time

# Create worker with event
event = asyncio.Event()
# ... setup worker with event ...

# Measure time from enqueue to worker seeing item
# Should be < 1ms (previously could be up to 1ms)
```

---

## Implementation Notes

### File Changes

```
src/fapilog/plugins/sinks/contrib/postgres.py (MODIFIED - add docstring warning)
src/fapilog/core/presets.py (MODIFIED - production preset postgres defaults)
src/fapilog/plugins/metadata.py (MODIFIED - fix default version)
src/fapilog/core/worker.py (MODIFIED - event-based wakeup)
src/fapilog/core/logger.py (MODIFIED - pass enqueue event to worker)
docs/plugins/sinks/postgres.md (MODIFIED - document create_table warning)
docs/user-guide/configuration.md (MODIFIED - document production preset postgres behavior)
```

### Key Code Changes

#### Fix plugin metadata default

```python
# metadata.py - change line 204
def create_plugin_metadata(...) -> PluginMetadata:
    return PluginMetadata(
        ...
        compatibility=PluginCompatibility(min_fapilog_version="0.1.0"),  # Was "3.0.0"
        ...
    )
```

#### Production preset postgres config

```python
# presets.py - add to production preset
PRODUCTION_PRESET = {
    # ... existing config ...
    "sink_config": {
        "postgres": {
            "create_table": False,  # Require explicit table creation in production
        },
    },
}
```

#### Event-based worker wakeup

```python
# worker.py
class LoggerWorker:
    def __init__(
        self,
        *,
        # ... existing params ...
        enqueue_event: asyncio.Event | None = None,
    ):
        # ... existing init ...
        self._enqueue_event = enqueue_event

    async def run(self, *, in_thread_mode: bool = False) -> None:
        batch: list[dict[str, Any]] = []
        next_flush_deadline: float | None = None
        try:
            while True:
                # ... existing stop/flush checks ...

                ok, item = self._queue.try_dequeue()
                if ok and item is not None:
                    batch.append(item)
                    # ... existing batch logic ...
                    continue

                # Check batch timeout
                now = time.perf_counter()
                if next_flush_deadline is not None and now >= next_flush_deadline:
                    await self._flush_batch(batch)
                    next_flush_deadline = None
                    continue

                # Wait for enqueue signal OR batch timeout
                if self._enqueue_event is not None:
                    timeout = None
                    if next_flush_deadline is not None:
                        timeout = max(0, next_flush_deadline - now)
                    elif batch:
                        timeout = self._batch_timeout_seconds

                    try:
                        await asyncio.wait_for(
                            self._enqueue_event.wait(),
                            timeout=timeout or self._batch_timeout_seconds,
                        )
                        self._enqueue_event.clear()
                    except asyncio.TimeoutError:
                        pass  # Timeout expired, check batch
                else:
                    # Fallback to polling (backwards compatibility)
                    await asyncio.sleep(0.001)
```

```python
# logger.py - signal event on enqueue
class _LoggerMixin:
    def __init__(self, ...):
        # ... existing init ...
        self._enqueue_event = asyncio.Event()

    def _create_worker(self, ...) -> LoggerWorker:
        return LoggerWorker(
            # ... existing params ...
            enqueue_event=self._enqueue_event,
        )

    async def _enqueue(self, payload: dict[str, Any]) -> bool:
        # ... existing enqueue logic ...
        if success:
            self._enqueue_event.set()  # Wake worker immediately
        return success
```

#### Postgres documentation warning

```markdown
<!-- docs/plugins/sinks/postgres.md -->

## Configuration

### Auto Table Creation

> **Warning:** By default, `create_table=True` causes the sink to execute DDL
> (CREATE TABLE, CREATE INDEX) at startup. In production environments with
> restricted permissions or change management policies, set `create_table=False`
> and provision tables via migrations.
>
> The `production` preset automatically sets `create_table=False`.

| Setting | Default | Production Preset |
|---------|---------|-------------------|
| `create_table` | `True` | `False` |
```

---

## Tasks

### Phase 1: Documentation and Postgres Preset

- [ ] Add warning to Postgres sink docstring about `create_table`
- [ ] Add warning section to `docs/plugins/sinks/postgres.md`
- [ ] Add `sink_config.postgres.create_table=False` to production preset
- [ ] Document production preset Postgres behavior in `docs/user-guide/configuration.md`

### Phase 2: Fix Plugin Metadata

- [ ] Change default `min_fapilog_version` from "3.0.0" to "0.1.0" in `metadata.py`
- [ ] Update any tests that check the old default

### Phase 3: Worker Event-Based Wakeup

- [ ] Add `enqueue_event: asyncio.Event | None` parameter to `LoggerWorker.__init__`
- [ ] Replace `await asyncio.sleep(0.001)` with event wait + timeout
- [ ] Pass event from logger facade to worker
- [ ] Signal event on successful enqueue
- [ ] Maintain backwards compatibility (event is optional)

### Phase 4: Testing

- [ ] Add tests for production preset Postgres config
- [ ] Add tests for plugin metadata version default
- [ ] Add tests for worker event-based wakeup
- [ ] Update CHANGELOG

---

## Tests

### Unit Tests

- `tests/unit/test_presets.py`
  - test_production_preset_disables_postgres_create_table

- `tests/unit/test_plugin_metadata_defaults.py`
  - test_create_plugin_metadata_reasonable_version_default
  - test_create_plugin_metadata_version_is_valid

- `tests/unit/test_worker_event_wakeup.py`
  - test_worker_accepts_enqueue_event_parameter
  - test_worker_wakes_on_event_set
  - test_worker_respects_batch_timeout_with_event
  - test_worker_falls_back_to_polling_without_event

### Integration Tests

- `tests/integration/test_worker_efficiency.py`
  - test_enqueue_wakes_worker_immediately

---

## Definition of Done

### Code Complete

- [ ] All acceptance criteria implemented
- [ ] Code follows project patterns
- [ ] No new linting errors

### Quality Assurance

- [ ] Unit tests written and passing
- [ ] `ruff check` passes
- [ ] `mypy` passes
- [ ] No regression in existing tests

### Documentation

- [ ] Postgres sink docs updated with warning
- [ ] Configuration docs updated with production Postgres behavior
- [ ] CHANGELOG updated

---

## Risks / Rollback

### Risks

1. **Risk:** Changing production preset `create_table` default may surprise users upgrading
   - **Mitigation:** Document in CHANGELOG; only affects production preset, not global default

2. **Risk:** Event-based wakeup may have subtle timing differences
   - **Mitigation:** Extensive testing; keep backwards-compatible polling fallback

3. **Risk:** Plugin metadata change may affect existing plugins
   - **Mitigation:** The old default (3.0.0) would fail anyway on 0.x; this is a fix

### Rollback Plan

If issues occur:
1. Revert individual changes as needed
2. Each fix is independent and can be reverted separately

---

## Related Stories

- **Related:** Story 4.54 - Redaction fail-closed mode (also improves production safety)
- **Related:** Story 4.55 - Lazy signal handler installation (also improves defaults)

---

## Change Log

| Date | Change | Author |
|------|--------|--------|
| 2026-01-27 | Initial draft from audit findings | Claude |
| 2026-01-27 | Revised: fixed docs path, added documentation AC for preset change | Claude |
| 2026-01-27 | Review: fixed presets.md → configuration.md, line 225 → 227 | Claude |
