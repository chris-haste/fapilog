# Story 4.61: Redaction Fail-Closed Defaults Audit

**Status:** Ready for Code Review
**Priority:** High
**Depends on:** 4.58 (on_guardrail_exceeded option)
**Breaking Change:** Yes

---

## Context / Background

Redaction exists to prevent sensitive data from reaching logs. If redaction is configured but cannot complete (due to guardrails, exceptions, or unparseable values), the secure default should be to **not emit potentially unredacted data**.

Currently, several redaction settings default to fail-open behavior:

| Setting | Current Default | Behavior | Risk |
|---------|-----------------|----------|------|
| `on_guardrail_exceeded` | `"warn"` | Emit warning, pass unredacted data | PII leaks if payload exceeds depth/key limits |
| `block_on_unredactable` | `False` | Pass original value if can't redact | Secrets leak if value format unexpected |
| `redaction_fail_mode` | `"open"` (presets: `"warn"`) | Pass original event on exception | Data leaks on redactor bugs |

### Security Principle

For security controls, **fail-closed** is the standard:
- A firewall that fails open isn't a firewall
- Encryption that fails open isn't encryption
- Redaction that fails open isn't redaction

### Risk Asymmetry

- **Dropped/masked log**: Operationally visible (gaps in logs), recoverable
- **Leaked PII**: Often invisible until breach/audit, compliance violations (GDPR/HIPAA), not recoverable

---

## Scope (In / Out)

### In Scope

- Audit all redaction-related config defaults
- Change defaults to fail-closed behavior
- Ensure presets align with new defaults
- Provide migration guide for users relying on fail-open behavior
- Document explicit opt-in for fail-open (for debugging/dev)

### Out of Scope

- Adding new redaction mechanisms
- Content-based PII detection
- Changes to redactor plugin architecture

---

## Proposed Default Changes

| Setting | Current | Proposed | Rationale |
|---------|---------|----------|-----------|
| `on_guardrail_exceeded` | `"warn"` | `"replace_subtree"` | Masks unscanned data without dropping entire event |
| `block_on_unredactable` | `False` | `True` | If configured field can't be redacted, drop event |
| `redaction_fail_mode` | `"open"` | `"warn"` | At minimum emit diagnostic; consider `"closed"` |

### Why `replace_subtree` over `drop` for guardrails?

- `drop` loses the entire event - significant availability impact
- `replace_subtree` preserves event structure, masks only unscanned portion
- Balanced tradeoff: security (unscanned data masked) + availability (event preserved)

### Why `True` for `block_on_unredactable`?

If a user configured redaction for `password` field and the redactor encounters a value it can't process:
- Current: silently passes original value (password leaks)
- Proposed: drops event (password never logged)

Users who explicitly want fail-open can set `block_on_unredactable=False`.

---

## Acceptance Criteria

### AC1: `on_guardrail_exceeded` defaults to `replace_subtree`

**Description:** FieldMaskConfig default changes from `"warn"` to `"replace_subtree"`.

**Validation:**
```python
from fapilog.plugins.redactors.field_mask import FieldMaskConfig

config = FieldMaskConfig(fields_to_mask=["password"])
assert config.on_guardrail_exceeded == "replace_subtree"
```

### AC2: `block_on_unredactable` defaults to `True`

**Description:** FieldMaskConfig default changes from `False` to `True`.

**Validation:**
```python
from fapilog.plugins.redactors.field_mask import FieldMaskConfig

config = FieldMaskConfig(fields_to_mask=["password"])
assert config.block_on_unredactable is True
```

### AC3: `redaction_fail_mode` base default changes

**Description:** CoreSettings default changes from `"open"` to `"warn"`. This ensures diagnostics are emitted on redaction failures while preserving availability (events still pass through).

**Validation:**
```python
from fapilog.core.settings import Settings

settings = Settings()  # No preset
assert settings.core.redaction_fail_mode == "warn"
```

### AC4: Presets align with secure defaults

**Description:** All presets use fail-closed redaction defaults.

**Validation:**
```python
from fapilog.core.presets import get_preset

for preset_name in ("dev", "production", "fastapi", "serverless", "minimal"):
    preset = get_preset(preset_name)
    # Verify redaction settings are secure
```

### AC5: Migration guide documents changes

**Description:** CHANGELOG and migration guide explain:
- What changed
- Why (security rationale)
- How to opt back into fail-open behavior for debugging

### AC6: Documentation updated

**Description:** All redaction docs reflect new defaults and explain fail-closed rationale.

---

## Implementation Notes

### File Changes

```
src/fapilog/plugins/redactors/field_mask.py (MODIFIED - change defaults)
src/fapilog/core/settings.py (MODIFIED - change redaction_fail_mode default)
src/fapilog/core/presets.py (MODIFIED - align presets)
docs/redaction/behavior.md (MODIFIED - update defaults documentation)
CHANGELOG.md (MODIFIED - add breaking change migration section)
CHANGELOG.md (MODIFIED - document breaking changes)
tests/unit/test_redaction_defaults.py (MODIFIED - update expected defaults)
```

### Key Changes

```python
# field_mask.py - FieldMaskConfig
class FieldMaskConfig(BaseModel):
    # ...
    block_on_unredactable: bool = True  # Changed from False
    on_guardrail_exceeded: Literal["warn", "drop", "replace_subtree"] = "replace_subtree"  # Changed from "warn"

# settings.py - CoreSettings
class CoreSettings(BaseModel):
    # ...
    redaction_fail_mode: Literal["open", "closed", "warn"] = "warn"  # Changed from "open"
```

---

## Tasks

### Phase 1: Default Changes

- [ ] Change `on_guardrail_exceeded` default to `"replace_subtree"`
- [ ] Change `block_on_unredactable` default to `True`
- [ ] Change `redaction_fail_mode` base default to `"warn"`
- [ ] Update PLUGIN_METADATA default_config

### Phase 2: Preset Alignment

- [ ] Verify all presets use secure defaults
- [ ] Remove redundant preset overrides if base defaults are now secure

### Phase 3: Test Updates

- [ ] Update `test_redaction_defaults.py` for new expected values
- [ ] Add tests verifying fail-closed behavior is default
- [ ] Verify existing tests still pass (may need adjustment)

### Phase 4: Documentation

- [ ] Update `docs/redaction/behavior.md` with new defaults
- [ ] Create migration section in CHANGELOG
- [ ] Document how to opt into fail-open for debugging

---

## Tests

### Unit Tests

- `tests/unit/test_redaction_defaults.py`
  - `test_on_guardrail_exceeded_default_is_replace_subtree`
  - `test_block_on_unredactable_default_is_true`
  - `test_redaction_fail_mode_default_is_warn`
  - `test_all_presets_use_secure_redaction_defaults`

---

## Definition of Done

### Code Complete

- [ ] All acceptance criteria implemented
- [ ] Defaults changed to fail-closed
- [ ] Presets aligned

### Quality Assurance

- [ ] Tests updated and passing
- [ ] `ruff check` passes
- [ ] `mypy` passes
- [ ] No regression in existing tests

### Documentation

- [ ] Redaction docs updated
- [ ] Migration guide written
- [ ] CHANGELOG updated with breaking change notice

---

## Risks / Rollback

### Risks

1. **Risk:** Users relying on fail-open may experience dropped logs
   - **Mitigation:** Clear migration guide; explicit opt-out documented

2. **Risk:** `block_on_unredactable=True` may drop events with unexpected data shapes
   - **Mitigation:** This is the intended behavior; document clearly

### Rollback Plan

Users can restore previous behavior:
```python
Settings(
    core=CoreSettings(redaction_fail_mode="open"),
    redactor_config=RedactorConfig(
        field_mask=FieldMaskConfig(
            block_on_unredactable=False,
            on_guardrail_exceeded="warn",
        )
    )
)
```

---

## Related Stories

- **Depends on:** Story 4.58 - Added `on_guardrail_exceeded` option
- **Related:** Story 4.47 - Redaction defaults alignment (docs/presets)
- **Related:** Story 4.54 - Redaction fail-closed mode (added `redaction_fail_mode`)

---

## Change Log

| Date | Change | Author |
|------|--------|--------|
| 2026-01-28 | Initial draft | Claude |
| 2026-01-28 | Story review: clarified AC3, fixed migration docs path | Claude |
