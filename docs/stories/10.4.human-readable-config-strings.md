# Story 10.4: Human-Readable Configuration Strings

## Status: Planned

## Priority: Medium

## Estimated Effort: Small (1 day)

## Dependencies

- **Depends on:** Story 10.1 (Configuration Presets) - Enhances configuration system

## Epic / Series

Part of Epic 10: Developer Experience and Ergonomics / Series 10.x

---

## Context / Background

Configuration often requires numeric byte and duration values. Allowing strings like "10 MB" and "7 days" lowers friction and reduces errors.

## Scope (In / Out)

### In Scope

- Size parsing (KB, MB, GB, TB), case-insensitive.
- Duration parsing (s, m, h, d, w) with multi-unit support.
- Retention parsing for count, age, size, and combined dicts.
- Pydantic validators to convert strings to numeric values.

### Out of Scope

- Localization of units or natural language parsing beyond the specified formats.
- Changes to existing integer or float inputs.

## Acceptance Criteria

1. Size strings parse to bytes; invalid formats return clear errors.
2. Duration strings parse to seconds; invalid formats return clear errors.
3. Retention supports count, age, size, and combined dicts.
4. Integer/float inputs remain supported with no behavioral change.
5. Pydantic validators convert and preserve original error context.
6. Documentation includes examples for each format.
7. Tests cover common formats and edge cases.

## Implementation Notes

- Add helpers like `parse_size`, `parse_duration`, `parse_retention` in `src/fapilog/core/validation.py` or a new module.
- Update `RotatingFileSettings` in `src/fapilog/core/settings.py` to accept `str | int | float` where appropriate.
- Assumption: validation errors should include the original input string.

## Tasks

- [ ] Implement parsers and unit mappings for size and duration formats.
- [ ] Add retention parsing logic with dict support.
- [ ] Add Pydantic field validators in `src/fapilog/core/settings.py` for rotation and retention fields.
- [ ] Update type hints and docstrings for Settings models.
- [ ] Update docs (settings guide and config reference) with examples.
- [ ] Add tests in `tests/unit/test_settings_serialization.py` and `tests/unit/test_rotating_file_sink.py`.

## Tests

- Unit: size parsing (valid and invalid cases).
- Unit: duration parsing with single and multiple units.
- Unit: retention parsing for count, age, size, and combined dict.
- Regression: integer inputs still accepted.

## Definition of Done

Story is complete when ALL of the following are true:

### Code Complete
- [ ] All acceptance criteria met and verified
- [ ] All tasks completed
- [ ] Code follows project style guide
- [ ] No linting errors or warnings
- [ ] Type checking passes (mypy strict)

### Quality Assurance
- [ ] Unit tests: >90% coverage of new code
- [ ] Integration tests: all scenarios passing
- [ ] Regression tests: no existing functionality broken
- [ ] Performance tests: no regression vs baseline
- [ ] Manual testing completed (if applicable)

### Documentation
- [ ] User-facing docs updated
- [ ] API reference updated (if applicable)
- [ ] Code examples added/updated
- [ ] CHANGELOG.md updated
- [ ] Inline code documentation complete

### Review & Release
- [ ] Code review approved
- [ ] Documentation reviewed for clarity
- [ ] CI/CD pipeline passing
- [ ] Ready for merge to main branch

### Backwards Compatibility
- [ ] No breaking changes OR breaking changes documented with migration guide
- [ ] Existing tests still pass
- [ ] Deprecation warnings added (if applicable)

---

## Risks / Rollback / Monitoring

### Risks

- **Risk:** Ambiguous parsing for mixed inputs
  - **Mitigation:** Clear parsing rules, comprehensive error messages

- **Risk:** Performance impact from string parsing
  - **Mitigation:** Cache parsed values, optimize parsing logic

### Rollback Plan

- Keep parsers isolated
- Validators can be removed cleanly
- Integer/float inputs remain supported

### Success Metrics / Monitoring

- Watch for configuration errors in user reports
- Monitor parsing success rate
- User feedback on readability

---

## Related Documents

- [Story 10.0: Series Overview](./10.0-series-overview.md)
- [Story 10.1: Configuration Presets](./10.1.configuration-presets.md)
- [Epic 10: Developer Experience](../prd/epic-10-DX-Experience.md)

---

## Change Log

| Date       | Change                    | Author |
| ---------- | ------------------------- | ------ |
| 2025-01-10 | Migrated to new format    | System |
