# Story 12.22: Known-Good Dependency Constraints File

**Status:** Complete
**Priority:** Low
**Depends on:** None

---

## Context / Background

An external audit (GPT-5.2 assessment, 2026-01-27) identified:

> "Range-based dependency constraints increase exposure window to upstream supply-chain issues (e.g., a compromised minor release)."
> Evidence: /pyproject.toml uses >= ranges for runtime deps; lockfile exists only for repo.
> Mitigation: pin upper bounds (at least for critical deps like httpx, fastapi, pydantic) or provide a "known-good constraints" file for production deployments.

Current state:
- `pyproject.toml` uses `>=` ranges: `pydantic>=2.11.0`, `httpx>=0.24.0`
- `uv.lock` exists for development but isn't distributed
- Production users get whatever versions pip resolves

Providing a `constraints.txt` file with tested version combinations would help security-conscious users pin to known-good versions.

---

## Scope (In / Out)

### In Scope

- Create `constraints.txt` with pinned versions
- Document usage in installation guide
- Add CI job to test with constraints file
- Update constraints on each release

### Out of Scope

- Changing `pyproject.toml` to use upper bounds (would break compatibility)
- Automated constraints updates (manual per release)
- SBOM generation (separate story)

---

## Acceptance Criteria

### AC1: Constraints file exists

**Description:** A constraints file with pinned dependency versions is provided.

**Validation:**
```bash
test -f constraints.txt
```

### AC2: Contains critical dependencies

**Description:** File pins versions for security-critical dependencies.

**Validation:**
```bash
grep -E "pydantic|httpx|orjson" constraints.txt
```

### AC3: Documented in installation guide

**Description:** Installation docs explain how to use the constraints file.

**Validation:**
```bash
grep -i "constraints" docs/user-guide/installation.md
```

### AC4: CI tests with constraints

**Description:** CI validates that fapilog works with the pinned versions.

**Validation:**
```bash
grep -i "constraints" .github/workflows/ci.yml
```

### AC5: Version matches release

**Description:** Constraints file is updated for each release.

**Validation:**
```bash
# Constraints should be in sync with tested versions
head -1 constraints.txt | grep -i "fapilog"
```

---

## Implementation Notes

### constraints.txt

```txt
# Known-good dependency versions for fapilog
# Generated for fapilog v0.7.x
# Last updated: 2026-01-27
#
# Usage:
#   pip install fapilog -c constraints.txt
#
# These versions have been tested together and are known to work.
# For maximum security, use these exact versions in production.

# Core dependencies
pydantic==2.11.0
pydantic-settings==2.7.0
httpx==0.28.0
orjson==3.10.12
packaging==24.2

# Optional: FastAPI integration
fastapi==0.115.6
starlette==0.41.3

# Optional: AWS integration
boto3==1.35.0
botocore==1.35.0

# Optional: Metrics
prometheus-client==0.21.0

# Optional: PostgreSQL
asyncpg==0.30.0
```

### Installation Docs Update

```markdown
## Production Installation

For production deployments, we recommend using our constraints file to pin
dependencies to tested versions:

```bash
# Download constraints for your fapilog version
curl -O https://raw.githubusercontent.com/chris-haste/fapilog/v0.7.0/constraints.txt

# Install with constraints
pip install fapilog -c constraints.txt

# Or with extras
pip install "fapilog[fastapi]" -c constraints.txt
```

### Why Use Constraints?

- **Supply chain security**: Pin to versions we've tested
- **Reproducibility**: Same versions across environments
- **Stability**: Avoid unexpected behavior from dependency updates

### Updating Constraints

Check for updated constraints when upgrading fapilog:

```bash
# Get constraints for new version
curl -O https://raw.githubusercontent.com/chris-haste/fapilog/v0.8.0/constraints.txt
pip install --upgrade fapilog -c constraints.txt
```
```

### CI Job

```yaml
# Add to .github/workflows/ci.yml
test-with-constraints:
  name: Test with Constraints File
  runs-on: ubuntu-latest
  steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install with constraints
      run: |
        pip install -e ".[dev,fastapi]" -c constraints.txt

    - name: Run tests
      run: pytest tests/ -m "not slow"
```

### Release Checklist Addition

Add to release process:
1. Update `constraints.txt` with current tested versions
2. Verify CI passes with constraints
3. Include constraints.txt in release

---

## Tasks

- [ ] Create `constraints.txt` with current versions
- [ ] Add CI job to test with constraints
- [ ] Update installation documentation
- [ ] Add to release checklist

---

## Definition of Done

- [x] Constraints file created
- [x] CI job added and passing
- [x] Docs updated
- [x] CHANGELOG updated

---

## Risks / Rollback

### Risks

1. **Risk:** Constraints become stale between releases
   - **Mitigation:** Document that constraints are per-release; update process

2. **Risk:** Users may not find/use constraints
   - **Mitigation:** Document prominently in installation guide

### Rollback

Constraints file is optional; users can always install without it.

---

## Related Stories

- **Origin:** GPT-5.2 External Audit (2026-01-27)
- **Follow-up:** SBOM generation for releases

---

## Code Review

**Date:** 2026-01-27
**Reviewer:** Claude
**Verdict:** OK to PR

### Summary

Reviewed implementation of known-good dependency constraints file with CI validation and installation documentation.

### AC Verification

| Criterion | Evidence |
|-----------|----------|
| AC1: Constraints file exists | `constraints.txt:1-30` - File created |
| AC2: Contains critical deps | `constraints.txt:12-15` - pydantic, httpx, orjson pinned |
| AC3: Documented in installation guide | `docs/getting-started/installation.md:186-214` - Production Installation section |
| AC4: CI tests with constraints | `.github/workflows/ci.yml:326-345` - test-with-constraints job |
| AC5: Version matches release | `constraints.txt:1-2` - Header identifies fapilog v0.7.x |

### Quality Gates

- [x] No Python code changes (docs/infra only)
- [x] CI job syntax valid
- [x] Constraints file validated with pip dry-run

---

## Change Log

| Date | Change | Author |
|------|--------|--------|
| 2026-01-27 | Initial draft from audit findings | Claude |
