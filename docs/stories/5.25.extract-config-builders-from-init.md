# Story 5.25: Extract Config Builder Functions from __init__.py

## Status: Planned

## Priority: Critical

## Estimated Effort: Medium (2-3 days)

## Dependencies

- **Depends on:** None
- **Prerequisite for:** Story 5.28 (Unify Logger Factories)
- **Related to:** Story 5.26 (DRY Env Alias Validators)

## Epic / Series

Part of Series 5.x: Plugin System Completion & Enhancement

---

## Context / Background

The `src/fapilog/__init__.py` file has grown to 1,308 lines, making it a "mystery meat" entry point that's hard to navigate and reason about. The file contains:

- **30+ functions**, many exceeding 50 lines
- Configuration builder functions (`_sink_configs`, `_enricher_configs`, `_redactor_configs`, etc.)
- Plugin loading logic
- Sink writer creation with nested closures
- Logger factory functions (`get_logger`, `get_async_logger`)

This creates several problems:

1. **Discoverability:** Developers can't quickly find specific functionality
2. **Change risk:** High probability of merge conflicts when multiple developers work on different features
3. **Onboarding burden:** New developers see a "wall of code" and don't know where to start
4. **Testing:** Difficult to unit test individual components in isolation

The Human Understandability Audit identified this as a **P0 issue** requiring immediate attention.

---

## User Story

**As a** fapilog maintainer
**I want** the `__init__.py` file to contain only public API exports
**So that** I can find and modify specific functionality quickly without risking unrelated breakage

---

## Scope (In / Out)

### In Scope

- Extract `_sink_configs()`, `_enricher_configs()`, `_redactor_configs()`, `_filter_configs()`, `_processor_configs()` to a new `core/config_builders.py` module
- Extract `_build_pipeline()` to the same module
- Extract `_default_sink_names()`, `_default_env_sink_cfg()` to the config builders module
- Keep `__init__.py` as a thin facade with only public API exports
- Maintain 100% backward compatibility for public API
- Update all internal imports

### Out of Scope

- Extracting sink writer functions (`_fanout_writer`, `_routing_or_fanout_writer`) - covered in Story 5.29
- Extracting logger factory functions - covered in Story 5.28
- Refactoring the extracted functions themselves - future stories

---

## Acceptance Criteria

### AC1: Config Builders Extracted

- [ ] New module `src/fapilog/core/config_builders.py` exists
- [ ] All `_*_configs()` functions moved to new module
- [ ] `_build_pipeline()` moved to new module
- [ ] `_default_sink_names()` and `_default_env_sink_cfg()` moved to new module
- [ ] Functions remain internal (underscore prefix) but are importable

### AC2: __init__.py Reduced

- [ ] `__init__.py` reduced by at least 200 lines
- [ ] `__init__.py` imports from `core/config_builders.py` for internal use
- [ ] All public exports (`__all__`) remain unchanged
- [ ] No new public API surface introduced

### AC3: Tests Pass

- [ ] All existing tests pass without modification
- [ ] New unit tests added for `config_builders.py` module
- [ ] Coverage for new module >= 90%

### AC4: Documentation Updated

- [ ] Architecture docs mention the new module structure
- [ ] Inline docstrings explain module purpose

---

## Technical Design / Implementation Notes

### Architecture Decisions

1. **Single extraction target:** All config-building logic goes to one module (`config_builders.py`) rather than multiple small files, to avoid over-fragmentation
2. **Keep functions private:** Functions remain prefixed with `_` to indicate internal use
3. **Minimal signature changes:** Extract as-is first, refactor later

### Implementation Approach

1. Create `src/fapilog/core/config_builders.py`
2. Move functions with their imports
3. Update `__init__.py` to import from new module
4. Run tests to verify no breakage
5. Add targeted unit tests for the new module

### Code Locations

- Primary file to modify:
  - `src/fapilog/__init__.py` (remove ~200 lines)
- New file to create:
  - `src/fapilog/core/config_builders.py`
- Test file to create:
  - `tests/unit/core/test_config_builders.py`

### Functions to Extract

```python
# From __init__.py to core/config_builders.py:
_sink_configs()           # Lines 173-297 (~125 lines)
_enricher_configs()       # Lines 300-308 (~9 lines)
_redactor_configs()       # Lines 311-321 (~11 lines)
_filter_configs()         # Lines 324-335 (~12 lines)
_processor_configs()      # Lines 338-351 (~14 lines)
_default_sink_names()     # Lines 354-359 (~6 lines)
_default_env_sink_cfg()   # Lines 407-436 (~30 lines)
_build_pipeline()         # Lines 468-535 (~68 lines)
```

Total: ~275 lines to extract

### Dependencies & Constraints

- Must maintain backward compatibility
- Must not change public API
- Must not affect runtime performance

---

## Tasks

### Phase 1: Extraction
- [ ] Create `src/fapilog/core/config_builders.py` with module docstring
- [ ] Move `_sink_configs()` with required imports
- [ ] Move `_enricher_configs()`, `_redactor_configs()`, `_filter_configs()`, `_processor_configs()`
- [ ] Move `_default_sink_names()` and `_default_env_sink_cfg()`
- [ ] Move `_build_pipeline()`
- [ ] Add `__all__` to new module listing internal exports

### Phase 2: Integration
- [ ] Update `__init__.py` imports to use new module
- [ ] Remove moved code from `__init__.py`
- [ ] Run full test suite
- [ ] Fix any import issues

### Phase 3: Testing & Docs
- [ ] Create `tests/unit/core/test_config_builders.py`
- [ ] Add unit tests for each extracted function
- [ ] Update architecture documentation
- [ ] Add inline docstrings explaining module purpose

---

## Tests

### Unit Tests

- [ ] Test `_sink_configs()` returns expected structure for each sink type
- [ ] Test `_enricher_configs()` returns expected structure
- [ ] Test `_build_pipeline()` constructs correct plugin lists
- [ ] Test `_default_sink_names()` respects environment variables
- [ ] Test `_default_env_sink_cfg()` parses rotating file settings

### Integration Tests

- [ ] Existing logger creation tests continue to pass
- [ ] Preset-based logger creation works
- [ ] Environment variable configuration works

### Manual Verification

- [ ] Verify `get_logger()` works in REPL
- [ ] Verify `get_async_logger()` works in async context

---

## Documentation Updates

- [ ] Add docstring to `config_builders.py` explaining purpose
- [ ] Update `docs/architecture/` if module structure diagram exists
- [ ] No CHANGELOG entry (internal refactor, no public API change)

---

## Definition of Done

### Code Complete
- [ ] All acceptance criteria met and verified
- [ ] All tasks completed
- [ ] Code follows project style guide
- [ ] No linting errors or warnings
- [ ] Type checking passes (mypy strict)

### Quality Assurance
- [ ] Unit tests: >90% coverage of new code
- [ ] Integration tests: all scenarios passing
- [ ] Regression tests: no existing functionality broken
- [ ] `__init__.py` reduced by >= 200 lines

### Documentation
- [ ] Module docstring added
- [ ] Inline documentation complete

### Review & Release
- [ ] Code review approved
- [ ] CI/CD pipeline passing
- [ ] Ready for merge to main branch

### Backwards Compatibility
- [ ] No breaking changes
- [ ] All existing tests pass unchanged
- [ ] Public API (`__all__`) unchanged

---

## Risks / Rollback / Monitoring

### Risks

- **Risk 1:** Circular import issues when extracting
  - **Mitigation:** Carefully order imports; use lazy imports if needed
- **Risk 2:** Missing import in new module causes runtime error
  - **Mitigation:** Run full test suite; test in REPL before merge

### Rollback Plan

- Revert the commit; no data migration needed
- Single atomic change makes rollback simple

### Success Metrics

- `__init__.py` line count reduced from ~1,308 to ~1,100 or less
- All tests pass
- No new issues reported after merge

---

## Related Documents

- [5.0 Series Overview](./5.0-series-overview.md)
- [Human Understandability Audit Report](#) - P0 recommendation #1
- [Story 5.26: DRY Env Alias Validators](./5.26.dry-env-alias-validators.md)
- [Story 5.28: Unify Logger Factories](./5.28.unify-logger-factory-functions.md)

---

## Change Log

| Date       | Change                 | Author |
| ---------- | ---------------------- | ------ |
| 2026-01-14 | Initial story creation | Claude |
