# Story 3.6: fapilog-audit Ecosystem Fixes

**Status:** Ready
**Priority:** Critical
**Depends on:** Story 3.5 (Plugin allowlist secure default - completed)

---

## Context / Background

An external audit identified two blocking issues with the fapilog-audit add-on package that prevent it from being installed or used:

1. **Version constraint mismatch**: `packages/fapilog-audit/pyproject.toml:29` requires `fapilog>=0.3.6`:
   ```toml
   dependencies = [
       "fapilog>=0.3.6",
   ]
   ```
   But `CHANGELOG.md` shows the latest released version is **0.3.5**. This means `pip install fapilog-audit` fails immediately because the dependency cannot be satisfied.

2. **Auto-discovery claim is misleading**: `packages/fapilog-audit/README.md:16-17` claims:
   ```python
   # Use with fapilog pipeline (auto-discovered via entry point)
   # Just install fapilog-audit and configure in settings
   ```
   But Story 3.5 changed the default to block external plugins. `src/fapilog/core/settings.py:1011-1013`:
   ```python
   allow_external: bool = Field(
       default=False,
       description="Allow loading plugins from entry points (security risk)",
   )
   ```
   Users who follow the README will get a `PluginNotFoundError` because external plugins are blocked by default.

These issues mean the advertised ecosystem doesn't work out of the box, damaging Capability Maturity (weight 20), DX, and Maintenance/Health scores.

---

## Scope (In / Out)

### In Scope

- Fix version constraint to `fapilog>=0.3.5` (current release)
- Update fapilog-audit README with explicit plugin allowlist instructions
- Add working example showing correct configuration
- Add CI check to prevent version constraint drift

### Out of Scope

- Releasing fapilog 0.3.6 to satisfy current constraint (requires release process)
- Changing default plugin security policy (already decided in Story 3.5)
- Auto-detection of installed packages to suggest allowlist entries (future enhancement)

---

## Acceptance Criteria

### AC1: Version Constraint Allows Installation

**Description:** fapilog-audit can be installed against the current fapilog release.

**Validation:**
```bash
# Create fresh venv
python -m venv test-venv && source test-venv/bin/activate

# Install current fapilog release
pip install fapilog==0.3.5

# Install fapilog-audit (should succeed)
pip install packages/fapilog-audit/
echo $?  # Should be 0
```

### AC2: README Documents Plugin Allowlist

**Description:** The fapilog-audit README clearly explains how to enable the plugin.

**Validation:**
```markdown
# README.md should include:
## Configuration

fapilog-audit is an external plugin. To use it, add it to your plugin allowlist:

```python
from fapilog import Settings, get_logger

settings = Settings(
    plugins={"allowlist": ["audit"]},
    core={"sinks": ["audit"]},
)
logger = get_logger(settings=settings)
```

Or via environment variables:
```bash
export FAPILOG_PLUGINS__ALLOWLIST='["audit"]'
export FAPILOG_CORE__SINKS='["audit"]'
```
```

### AC3: Working Example in README

**Description:** README includes a complete, working example that users can copy-paste.

**Validation:**
```python
# Example from README should work when executed
from fapilog import Settings, get_logger
from fapilog_audit import AuditTrail, CompliancePolicy, ComplianceLevel

settings = Settings(
    plugins={"allowlist": ["audit"]},
    core={"sinks": ["audit"]},
)
logger = get_logger(settings=settings)
logger.info("Audit logging configured")
# No errors raised
```

### AC4: CI Prevents Version Drift

**Description:** CI checks that fapilog-audit's version constraint is satisfiable.

**Validation:**
```yaml
# .github/workflows/ci.yml should include:
- name: Validate fapilog-audit constraints
  run: |
    CORE_VERSION=$(grep 'version =' pyproject.toml | head -1 | cut -d'"' -f2)
    AUDIT_MIN=$(grep 'fapilog>=' packages/fapilog-audit/pyproject.toml | grep -oP '\d+\.\d+\.\d+')
    python -c "from packaging.version import Version; assert Version('$CORE_VERSION') >= Version('$AUDIT_MIN')"
```

---

## Implementation Notes

### File Changes

```
packages/fapilog-audit/pyproject.toml (MODIFIED - fix version constraint)
packages/fapilog-audit/README.md (MODIFIED - add allowlist docs)
.github/workflows/ci.yml (MODIFIED - add constraint validation)
```

### Version Constraint Fix

```toml
# Before
dependencies = [
    "fapilog>=0.3.6",
]

# After
dependencies = [
    "fapilog>=0.3.5",
]
```

### README Update

```markdown
# fapilog-audit

Enterprise compliance audit trail add-on for fapilog.

## Installation

```bash
pip install fapilog-audit
```

## Configuration

**Important:** fapilog-audit is an external plugin. External plugins are disabled by default for security. You must explicitly allow it:

### Option 1: Plugin Allowlist (Recommended)

```python
from fapilog import Settings, get_logger

settings = Settings(
    plugins={"allowlist": ["audit"]},
    core={"sinks": ["audit"]},
)
logger = get_logger(settings=settings)
```

### Option 2: Environment Variables

```bash
export FAPILOG_PLUGINS__ALLOWLIST='["audit"]'
export FAPILOG_CORE__SINKS='["audit"]'
```

### Option 3: Allow All External Plugins (Less Secure)

```python
settings = Settings(
    plugins={"allow_external": True},
    core={"sinks": ["audit"]},
)
```

## Direct Usage

You can also use AuditTrail directly without the plugin system:

```python
from fapilog_audit import AuditTrail, CompliancePolicy, ComplianceLevel

trail = AuditTrail(policy=CompliancePolicy(level=ComplianceLevel.HIPAA))
await trail.start()
await trail.log_security_event(...)
await trail.stop()
```
```

---

## Tasks

### Phase 1: Fix Blocking Issues

- [ ] Update version constraint in `packages/fapilog-audit/pyproject.toml`
- [ ] Rewrite README with allowlist documentation
- [ ] Add complete working example to README

### Phase 2: CI Protection

- [ ] Add version constraint validation to CI
- [ ] Test installation in clean environment

### Phase 3: Verification

- [ ] Test full workflow: install fapilog, install fapilog-audit, run example
- [ ] Update CHANGELOG

---

## Tests

### Manual Verification

```bash
# Full installation test
python -m venv test-env
source test-env/bin/activate
pip install fapilog
pip install packages/fapilog-audit/

# Test import and basic usage
python -c "
from fapilog import Settings, get_logger
from fapilog_audit import AuditSink

settings = Settings(plugins={'allowlist': ['audit']})
print('fapilog-audit installed and importable')
"
```

### CI Integration

- Version constraint check prevents future drift
- Installation smoke test in CI

---

## Definition of Done

### Code Complete

- [ ] Version constraint allows installation with current release
- [ ] README documents plugin allowlist requirement
- [ ] Working example provided

### Quality Assurance

- [ ] Manual installation test passes
- [ ] CI constraint validation passes
- [ ] No regression in existing tests

### Documentation

- [ ] README fully updated
- [ ] CHANGELOG updated

---

## Risks / Rollback

### Risks

1. **Risk:** Lowering version constraint may expose incompatibilities
   - **Mitigation:** 0.3.5 to 0.3.6 is minor; API should be stable

2. **Risk:** Users may not read updated README
   - **Mitigation:** Error message from PluginNotFoundError already suggests allowlist; can improve message

### Rollback Plan

If issues occur:
1. Version constraint change is trivial to revert
2. README changes are documentation-only

---

## Related Stories

- **Depends on:** Story 3.5 - Plugin allowlist secure default (cause of breaking change)
- **Related:** Story 4.44 - Extract audit to separate package (created the package)

---

## Change Log

| Date | Change | Author |
|------|--------|--------|
| 2026-01-18 | Initial draft from audit findings | Claude |
