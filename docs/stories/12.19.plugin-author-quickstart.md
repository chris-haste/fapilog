# Story 12.19: Plugin Author Quickstart Guide

**Status:** Ready
**Priority:** Medium
**Depends on:** None

---

## Context / Background

An external audit (GPT-5.2 assessment, 2026-01-27) identified:

> "Provide a minimal 'plugin author quickstart' with validation mode usage (warn/strict), plus security guidance for external plugins."
> Evidence: plugins.validation_mode exists (/src/fapilog/__init__.py), but may not be prominent.

Current plugin documentation:
- `docs/plugin-guide.md` - Auto-generated catalog of built-in plugins (not a development guide)
- `docs/architecture/high-level-architecture.md` - Technical architecture (not a quickstart)

Plugin authors need:
- Step-by-step guide to create a plugin
- Explanation of plugin types (sink, enricher, processor, etc.)
- Validation mode usage (`disabled`, `warn`, `strict`)
- Security considerations for external plugins
- Testing utilities

---

## Scope (In / Out)

### In Scope

- Create `docs/plugin-development/quickstart.md`
- Document plugin types and protocols
- Document validation modes
- Include security guidance
- Provide minimal working examples

### Out of Scope

- Comprehensive plugin API reference (separate doc)
- Plugin marketplace/registry features
- Automated plugin scaffolding tools

---

## Acceptance Criteria

### AC1: Quickstart document exists

**Description:** A plugin author quickstart guide is created.

**Validation:**
```bash
test -f docs/plugin-development/quickstart.md
```

### AC2: Plugin types documented

**Description:** Document explains the different plugin types (sink, enricher, processor, redactor, filter).

**Validation:**
```bash
grep -i "sink\|enricher\|processor\|redactor\|filter" docs/plugin-development/quickstart.md | wc -l
# Should be > 5
```

### AC3: Minimal sink example

**Description:** Document includes a minimal working sink plugin example.

**Validation:**
```bash
grep -A20 "class.*Sink" docs/plugin-development/quickstart.md | grep -i "async def write"
```

### AC4: Validation modes documented

**Description:** Document explains `validation_mode` settings and their effects.

**Validation:**
```bash
grep -i "validation_mode\|disabled\|warn\|strict" docs/plugin-development/quickstart.md
```

### AC5: Security guidance included

**Description:** Document includes security considerations for plugin authors.

**Validation:**
```bash
grep -i "security\|trust\|allowlist\|external" docs/plugin-development/quickstart.md
```

### AC6: Entry points documented

**Description:** Document explains how to register plugins via entry points.

**Validation:**
```bash
grep -i "entry.point\|pyproject\|fapilog.sinks" docs/plugin-development/quickstart.md
```

### AC7: Added to navigation

**Description:** Document is accessible from docs navigation.

**Validation:**
```bash
test -f docs/plugin-development/index.md && grep -i "quickstart" docs/plugin-development/index.md
```

---

## Implementation Notes

### Directory Structure

```
docs/plugin-development/
├── index.md        # Overview and links
├── quickstart.md   # This story
├── protocols.md    # Detailed protocol reference (future)
└── testing.md      # Testing plugins (future)
```

### Document Structure

```markdown
# Plugin Author Quickstart

Create custom fapilog plugins in 10 minutes.

## Overview

Fapilog supports five plugin types:

| Type | Purpose | Protocol |
|------|---------|----------|
| **Sink** | Output destinations (file, HTTP, cloud) | `write()`, `write_serialized()` |
| **Enricher** | Add context/metadata to events | `enrich()` |
| **Processor** | Transform serialized data | `process()` |
| **Redactor** | Mask sensitive data | `redact()` |
| **Filter** | Drop/pass events | `filter()` |

## Minimal Sink Plugin

Here's a complete sink plugin in ~20 lines:

```python
# my_sink.py
from typing import Any

class MySink:
    """Minimal sink that prints events."""

    name = "my_sink"  # Required: unique plugin name

    async def start(self) -> None:
        """Called when logger starts."""
        print("MySink started")

    async def stop(self) -> None:
        """Called when logger stops."""
        print("MySink stopped")

    async def write(self, entry: dict[str, Any]) -> None:
        """Write a log event."""
        print(f"LOG: {entry.get('message', entry)}")
```

### Using Your Plugin

```python
import fapilog
from my_sink import MySink

logger = fapilog.get_logger(sinks=[MySink()])
logger.info("Hello from my sink!")
```

## Registering via Entry Points

For distributable plugins, register via `pyproject.toml`:

```toml
[project]
name = "fapilog-my-sink"
version = "1.0.0"
dependencies = ["fapilog>=0.7.0"]

[project.entry-points."fapilog.sinks"]
my_sink = "my_sink:MySink"
```

### Entry Point Groups

| Plugin Type | Entry Point Group |
|-------------|-------------------|
| Sink | `fapilog.sinks` |
| Enricher | `fapilog.enrichers` |
| Processor | `fapilog.processors` |
| Redactor | `fapilog.redactors` |
| Filter | `fapilog.filters` |

## Plugin Validation Modes

Fapilog validates plugins at load time. Configure validation strictness:

```python
from fapilog import Settings

# Modes: "disabled", "warn", "strict"
settings = Settings(plugins={"validation_mode": "warn"})
```

| Mode | Invalid Plugin Behavior |
|------|------------------------|
| `disabled` | Load anyway, may fail at runtime |
| `warn` | Load with diagnostic warning |
| `strict` | Reject plugin, raise error |

### What Gets Validated

- Required attributes (`name`)
- Required methods (`start`, `stop`, `write`/`enrich`/etc.)
- Method signatures (async, correct parameters)
- Plugin metadata compatibility

## Plugin Protocols

### Sink Protocol

```python
from typing import Any, Protocol
from fapilog.core.serialization import SerializedView

class SinkProtocol(Protocol):
    name: str

    async def start(self) -> None: ...
    async def stop(self) -> None: ...
    async def write(self, entry: dict[str, Any]) -> None: ...

    # Optional: fast path for pre-serialized data
    async def write_serialized(self, view: SerializedView) -> None: ...

    # Optional: health check
    async def health_check(self) -> bool: ...
```

### Enricher Protocol

```python
class EnricherProtocol(Protocol):
    name: str

    async def start(self) -> None: ...
    async def stop(self) -> None: ...
    async def enrich(self, entry: dict[str, Any]) -> dict[str, Any]: ...
```

### Redactor Protocol

```python
class RedactorProtocol(Protocol):
    name: str

    async def start(self) -> None: ...
    async def stop(self) -> None: ...
    async def redact(self, entry: dict[str, Any]) -> dict[str, Any]: ...
```

## Security Considerations

### For Plugin Authors

1. **Never log secrets** - Don't log API keys, tokens, or credentials
2. **Validate inputs** - Don't trust event data blindly
3. **Handle errors gracefully** - Don't crash the logger
4. **Document dependencies** - Declare all requirements in `pyproject.toml`
5. **Pin fapilog version** - Use `fapilog>=X.Y.Z,<X+1.0.0`

### For Plugin Users

1. **Use allowlist for external plugins**:
   ```python
   settings = Settings(plugins={
       "allow_external": True,
       "allowlist": ["trusted-plugin"],
   })
   ```

2. **Review plugin code** before installing third-party plugins

3. **Use strict validation** in production:
   ```python
   settings = Settings(plugins={"validation_mode": "strict"})
   ```

## Testing Your Plugin

Use fapilog's testing utilities:

```python
import pytest
from fapilog.testing import MockSink, validate_sink

@pytest.mark.asyncio
async def test_my_sink_protocol():
    """Validate your sink follows the protocol."""
    from my_sink import MySink

    sink = MySink()
    result = validate_sink(sink)
    assert result.valid, f"Protocol violations: {result.violations}"

@pytest.mark.asyncio
async def test_my_sink_writes():
    """Test your sink receives events."""
    from my_sink import MySink

    sink = MySink()
    await sink.start()

    # Write a test event
    await sink.write({"message": "Test", "level": "INFO"})

    await sink.stop()
```

## Example: HTTP Webhook Sink

A more complete example:

```python
from typing import Any
import httpx

class WebhookSink:
    """Send logs to a webhook endpoint."""

    name = "webhook"

    def __init__(self, url: str, timeout: float = 5.0):
        self.url = url
        self.timeout = timeout
        self._client: httpx.AsyncClient | None = None

    async def start(self) -> None:
        self._client = httpx.AsyncClient(timeout=self.timeout)

    async def stop(self) -> None:
        if self._client:
            await self._client.aclose()

    async def write(self, entry: dict[str, Any]) -> None:
        if self._client:
            try:
                await self._client.post(self.url, json=entry)
            except httpx.HTTPError as e:
                # Log errors via diagnostics, don't raise
                from fapilog.core.diagnostics import warn
                warn("webhook-sink", "delivery failed", error=str(e))

    async def health_check(self) -> bool:
        return self._client is not None
```

## Next Steps

- [Plugin Protocols Reference](protocols.md) - Detailed protocol documentation
- [Testing Plugins](testing.md) - Comprehensive testing guide
- [Built-in Plugins](../plugin-guide.md) - Reference implementations
```

---

## Tasks

- [ ] Create `docs/plugin-development/` directory
- [ ] Create `docs/plugin-development/index.md`
- [ ] Create `docs/plugin-development/quickstart.md`
- [ ] Add to main docs navigation
- [ ] Verify code examples work
- [ ] Run docs build

---

## Definition of Done

### Code Complete

- [ ] Directory created
- [ ] Quickstart document complete
- [ ] Index created
- [ ] Added to navigation

### Quality Assurance

- [ ] Docs build passes
- [ ] Code examples tested
- [ ] Protocols match actual implementation

### Documentation

- [ ] CHANGELOG updated

---

## Related Stories

- **Origin:** GPT-5.2 External Audit (2026-01-27)
- **Related:** Story 12.16 - Production checklist
- **Follow-up:** Plugin protocols reference doc
- **Follow-up:** Plugin testing guide

---

## Change Log

| Date | Change | Author |
|------|--------|--------|
| 2026-01-27 | Initial draft from audit findings | Claude |
