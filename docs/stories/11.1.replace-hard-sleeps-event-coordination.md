# Story 11.1: Replace Hard Sleeps with Event-Based Coordination

**Status:** Draft
**Priority:** Critical
**Depends on:** None

---

## Context / Background

Integration tests use fixed `asyncio.sleep()` calls to wait for async operations to complete:

| File | Line | Sleep Duration | Purpose |
|------|------|----------------|---------|
| `tests/integration/test_loki_sink.py` | 37 | 1.0 second | Wait for Loki push |
| `tests/integration/test_rotating_file_sink_integration.py` | 99 | 1.2 seconds | Wait for rotation |

These fixed sleeps assume consistent CI runner performance. On slower or loaded runners, the sleep may complete before the async operation finishes, causing race conditions and intermittent failures.

**Current pattern (problematic):**
```python
await sink.write(record)
await asyncio.sleep(1.0)  # Hope this is enough time
assert sink.push_count == 1  # May fail if push not complete
```

**Target pattern (reliable):**
```python
await sink.write(record)
await asyncio.wait_for(sink.flushed.wait(), timeout=5.0)
assert sink.push_count == 1  # Guaranteed complete
```

---

## Scope (In / Out)

### In Scope

- Replace hard sleeps in `test_loki_sink.py` with event-based waits
- Replace hard sleeps in `test_rotating_file_sink_integration.py` with event-based waits
- Add `asyncio.Event` or similar coordination primitives to sink implementations if needed
- Ensure tests have reasonable timeouts (5-10s) for CI safety

### Out of Scope

- Refactoring production sink code beyond adding coordination events
- Addressing smaller sleeps (< 0.5s) — covered in Story 11.5
- Unit test timing issues — covered in Story 11.2

---

## Acceptance Criteria

### AC1: Loki Sink Test Uses Event Coordination

**Description:** `test_loki_sink.py` uses event-based waiting instead of fixed sleep.

**Validation:**
```python
# Before: await asyncio.sleep(1.0)
# After:
async def test_loki_push_completes():
    sink = LokiSink(...)
    await sink.write(record)
    # Wait for actual completion, not arbitrary time
    await asyncio.wait_for(sink.flush(), timeout=5.0)
    assert sink.push_count == 1
```

### AC2: Rotating File Sink Test Uses Event Coordination

**Description:** `test_rotating_file_sink_integration.py` uses event-based waiting.

**Validation:**
```python
# Before: await asyncio.sleep(1.2)
# After:
async def test_file_rotation_completes():
    sink = RotatingFileSink(...)
    # Trigger rotation
    await sink.write(large_record)
    # Wait for rotation to complete
    await asyncio.wait_for(sink.rotation_complete.wait(), timeout=5.0)
    assert rotated_file.exists()
```

### AC3: Tests Pass Consistently

**Description:** Tests pass 100% of the time on both fast local machines and slow CI runners.

**Validation:**
```bash
# Run 10 times to verify no flakiness
for i in {1..10}; do
    pytest tests/integration/test_loki_sink.py -v || exit 1
    pytest tests/integration/test_rotating_file_sink_integration.py -v || exit 1
done
```

### AC4: Reasonable Timeouts

**Description:** All event waits have explicit timeouts between 5-10 seconds.

**Validation:**
- No `await event.wait()` without timeout wrapper
- All timeouts use `asyncio.wait_for(..., timeout=...)`

---

## Implementation Notes

### Option A: Add Flush Events to Sinks

Add `asyncio.Event` to sink classes that signals when operations complete:

```python
class LokiSink:
    def __init__(self):
        self._push_complete = asyncio.Event()

    async def push(self):
        # ... push logic ...
        self._push_complete.set()

    async def wait_for_push(self, timeout: float = 5.0):
        await asyncio.wait_for(self._push_complete.wait(), timeout=timeout)
        self._push_complete.clear()
```

### Option B: Use Existing Flush Methods

If sinks already have `flush()` methods, use those for synchronization:

```python
await sink.write(record)
await sink.flush()  # Blocks until all pending writes complete
assert sink.push_count == 1
```

### Option C: Polling with Backoff

If events aren't feasible, use polling with exponential backoff:

```python
async def wait_for_condition(predicate, timeout=5.0, interval=0.1):
    deadline = time.monotonic() + timeout
    while time.monotonic() < deadline:
        if predicate():
            return True
        await asyncio.sleep(interval)
        interval = min(interval * 1.5, 1.0)  # Backoff
    raise TimeoutError("Condition not met")

await wait_for_condition(lambda: sink.push_count == 1)
```

### File Changes

```
tests/integration/test_loki_sink.py (MODIFIED - replace sleep with event wait)
tests/integration/test_rotating_file_sink_integration.py (MODIFIED - replace sleep with event wait)
src/fapilog/sinks/loki.py (POSSIBLY MODIFIED - add flush event if needed)
src/fapilog/sinks/rotating_file.py (POSSIBLY MODIFIED - add rotation event if needed)
```

---

## Tasks

### Phase 1: Loki Sink

- [ ] Read `test_loki_sink.py` and identify all hard sleeps
- [ ] Check if `LokiSink` has existing flush/wait mechanisms
- [ ] Add event coordination to sink if needed
- [ ] Replace sleep with event-based wait in test
- [ ] Verify test passes 10x in a row

### Phase 2: Rotating File Sink

- [ ] Read `test_rotating_file_sink_integration.py` and identify all hard sleeps
- [ ] Check if `RotatingFileSink` has existing flush/wait mechanisms
- [ ] Add rotation complete event to sink if needed
- [ ] Replace sleep with event-based wait in test
- [ ] Verify test passes 10x in a row

### Phase 3: Validation

- [ ] Run full integration test suite
- [ ] Verify no new test failures introduced
- [ ] Update test documentation if patterns changed

---

## Tests

### Verification Tests

The existing integration tests serve as verification — they should pass consistently after this change.

### Stability Tests

```bash
# Run each test 10 times to verify stability
pytest tests/integration/test_loki_sink.py --count=10
pytest tests/integration/test_rotating_file_sink_integration.py --count=10
```

---

## Definition of Done

### Code Complete

- [ ] All sleeps > 0.5s replaced with event-based coordination
- [ ] All event waits have explicit timeouts
- [ ] No new production code complexity beyond coordination events

### Quality Assurance

- [ ] Tests pass 10x in a row locally
- [ ] `ruff check` passes
- [ ] `mypy` passes
- [ ] No regression in existing tests

### Documentation

- [ ] Code comments explain event coordination pattern
- [ ] CHANGELOG updated

---

## Risks / Rollback

### Risks

1. **Risk:** Adding events to sinks changes their behavior
   - **Mitigation:** Events are only for test coordination, not production logic

2. **Risk:** Timeouts too short for very slow CI
   - **Mitigation:** Use 5-10s timeouts, configurable via `CI_TIMEOUT_MULTIPLIER` (Story 11.4)

### Rollback Plan

If issues occur:
1. Revert to original sleep-based tests
2. Increase sleep durations as temporary fix
3. Investigate root cause before re-attempting

---

## Related Stories

- **Enables:** Story 11.2 - patterns established here apply to flaky test fixes
- **Related:** Story 11.4 - CI timeout multipliers complement this work
- **Related:** Story 11.5 - addresses smaller sleep instances

---

## Change Log

| Date | Change | Author |
|------|--------|--------|
| 2026-01-14 | Initial draft | Claude |
