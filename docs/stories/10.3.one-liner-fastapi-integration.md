# Story 10.3: One-Liner FastAPI Integration

## Status: Planned

## Priority: High

## Estimated Effort: Medium (2-3 days)

## Dependencies

- **Depends on:** Story 10.1 (Configuration Presets) - Uses preset system
- **Depends on:** Story 10.2 (Pretty Console Output) - May use format options

## Epic / Series

Part of Epic 10: Developer Experience and Ergonomics / Series 10.x

---

## Context / Background

FastAPI users must currently wire multiple middleware and lifecycle hooks manually. A single helper should configure common logging defaults and provide dependency injection for per-request logging.

## Scope (In / Out)

### In Scope

- `setup_logging(app, ...)` helper in `fapilog.fastapi`.
- Auto-configured `RequestContextMiddleware` and `LoggingMiddleware`.
- Lifecycle hooks to stop and drain the logger on shutdown.
- Optional configuration for sampling, redaction, and body logging.

### Out of Scope

- Breaking changes to existing manual FastAPI integration.
- Framework support beyond FastAPI/Starlette.

## Acceptance Criteria

1. `setup_logging(app)` registers request context and logging middleware.
2. `setup_logging` accepts optional parameters (preset, sample_rate, skip_paths, redact_headers, include_request_body, include_response_body).
3. `get_logger` dependency helper is available for `Depends` usage.
4. Lifespan integration ensures logger cleanup on shutdown.
5. No breaking changes to manual middleware use.
6. Documentation includes a before/after code comparison.
7. Tests verify middleware wiring and request context propagation.

## Implementation Notes

- Use existing middleware in `src/fapilog/fastapi/context.py` and `src/fapilog/fastapi/logging.py`.
- Provide `setup_logging` in `src/fapilog/fastapi/__init__.py` or a new `setup.py` module.
- Assumption: the logger can be created at setup time and reused via dependency injection.

## Tasks

- [ ] Implement `setup_logging` and `get_logger` dependency helpers in `src/fapilog/fastapi/`.
- [ ] Register `RequestContextMiddleware` and `LoggingMiddleware` via `app.add_middleware`.
- [ ] Add lifespan handler to call logger stop/drain.
- [ ] Add optional configuration parameters and defaults.
- [ ] Update docs in `docs/guides/` or `docs/getting-started/` with a quickstart example.
- [ ] Add FastAPI tests in `tests/unit/test_fastapi_simple.py` and `tests/unit/test_fastapi_request_context.py`.

## Tests

- Integration: `setup_logging` registers both middleware classes.
- Integration: request_id is propagated and returned in response header.
- Unit: skip_paths and sample_rate behavior.
- Unit: dependency injection returns a logger bound to request context.

## Definition of Done

Story is complete when ALL of the following are true:

### Code Complete
- [ ] All acceptance criteria met and verified
- [ ] All tasks completed
- [ ] Code follows project style guide
- [ ] No linting errors or warnings
- [ ] Type checking passes (mypy strict)

### Quality Assurance
- [ ] Unit tests: >90% coverage of new code
- [ ] Integration tests: all scenarios passing
- [ ] Regression tests: no existing functionality broken
- [ ] Performance tests: no regression vs baseline
- [ ] Manual testing completed (if applicable)

### Documentation
- [ ] User-facing docs updated
- [ ] API reference updated (if applicable)
- [ ] Code examples added/updated
- [ ] CHANGELOG.md updated
- [ ] Inline code documentation complete

### Review & Release
- [ ] Code review approved
- [ ] Documentation reviewed for clarity
- [ ] CI/CD pipeline passing
- [ ] Ready for merge to main branch

### Backwards Compatibility
- [ ] No breaking changes OR breaking changes documented with migration guide
- [ ] Existing tests still pass
- [ ] Deprecation warnings added (if applicable)

---

## Risks / Rollback / Monitoring

### Risks

- **Risk:** Lifecycle integration conflicts with user-provided lifespan handlers
  - **Mitigation:** Use lifespan context manager pattern, allow user handlers to coexist

- **Risk:** Dependency injection complexity
  - **Mitigation:** Keep API simple, provide clear examples

### Rollback Plan

- Keep setup helper optional
- Users can revert to manual wiring
- No breaking changes to existing APIs

### Success Metrics / Monitoring

- Track support questions
- Monitor examples usage
- User feedback on ease of use

---

## Related Documents

- [Story 10.0: Series Overview](./10.0-series-overview.md)
- [Story 10.1: Configuration Presets](./10.1.configuration-presets.md)
- [Story 10.2: Pretty Console Output](./10.2.pretty-console-output.md)
- [Epic 10: Developer Experience](../prd/epic-10-DX-Experience.md)
- [FastAPI Integration Docs](../fastapi-logging.md)

---

## Change Log

| Date       | Change                    | Author |
| ---------- | ------------------------- | ------ |
| 2025-01-10 | Migrated to new format    | System |
