# Story 4.51: Secure Header Redaction Defaults

**Status:** Ready
**Priority:** High (P1 - Security)
**Depends on:** None

---

## Context / Background

The `LoggingMiddleware` in `src/fapilog/fastapi/logging.py:163-171` uses an opt-in redaction model when `include_headers=True` is enabled. Only headers explicitly listed in `redact_headers` are maskedâ€”all others are logged in plaintext.

This is a security footgun: if a user enables header logging without carefully configuring `redact_headers`, sensitive headers like `Authorization`, `Cookie`, `X-API-Key`, and others will be written to logs in cleartext.

**Current behavior:**
```python
if self._include_headers:
    headers = {}
    for key, value in request.headers.items():
        lk = key.lower()
        if lk in self._redact_headers:  # Only explicit redactions
            headers[lk] = "***"
        else:
            headers[lk] = value  # Everything else logged in plaintext
```

**Problem:** Common sensitive headers are logged unless users remember to add them to `redact_headers`.

---

## Scope (In / Out)

### In Scope

- Add default redaction list for common sensitive headers
- Make redaction opt-out (redact by default) rather than opt-in
- Add `additional_redact_headers` parameter for extending defaults
- Add `allow_headers` parameter for explicit allowlist approach
- Documentation and migration guide

### Out of Scope

- Automatic PII detection in header values (future ML/regex work)
- Body content redaction (separate concern)
- Retroactive log scrubbing

---

## Acceptance Criteria

### AC1: Default Sensitive Headers Redacted

**Description:** When `include_headers=True`, common sensitive headers are redacted by default without explicit configuration.

**Default redaction list:**
- `authorization`
- `cookie`
- `set-cookie`
- `x-api-key`
- `x-auth-token`
- `x-csrf-token`
- `x-forwarded-authorization`
- `proxy-authorization`
- `www-authenticate`

**Validation:**
```python
middleware = LoggingMiddleware(app, include_headers=True)
# Authorization header should be redacted without explicit config
assert "authorization" in middleware._default_redact_headers
```

### AC2: Extend Default Redactions

**Description:** Users can add to the default list without replacing it.

**Validation:**
```python
middleware = LoggingMiddleware(
    app,
    include_headers=True,
    additional_redact_headers=["x-custom-secret"]
)
# Both defaults and custom headers redacted
```

### AC3: Explicit Allowlist Mode

**Description:** Users can switch to allowlist mode where only specified headers are logged.

**Validation:**
```python
middleware = LoggingMiddleware(
    app,
    include_headers=True,
    allow_headers=["content-type", "accept", "user-agent"]
)
# Only these three headers logged, all others excluded
```

### AC4: Override Default Redactions

**Description:** Users can disable default redactions if they have a legitimate need (with warning).

**Validation:**
```python
middleware = LoggingMiddleware(
    app,
    include_headers=True,
    redact_headers=[],  # Explicit empty list
    disable_default_redactions=True  # Must be explicit
)
# Logs warning about security implications
```

### AC5: Documentation Updated

**Description:** Security implications documented with examples.

**Validation:**
- README security section mentions header redaction
- Docstrings explain default behavior
- Migration guide for existing users

---

## Implementation Notes

### File Changes

```
src/fapilog/fastapi/logging.py (MODIFIED - add default redactions)
tests/unit/test_logging_middleware.py (MODIFIED - add security tests)
docs/user-guide/security.md (NEW or MODIFIED)
```

### Key Code

```python
DEFAULT_REDACT_HEADERS = frozenset({
    "authorization",
    "cookie",
    "set-cookie",
    "x-api-key",
    "x-auth-token",
    "x-csrf-token",
    "x-forwarded-authorization",
    "proxy-authorization",
    "www-authenticate",
})

def __init__(
    self,
    app: Any,
    *,
    include_headers: bool = False,
    redact_headers: Iterable[str] | None = None,
    additional_redact_headers: Iterable[str] | None = None,
    allow_headers: Iterable[str] | None = None,
    disable_default_redactions: bool = False,
    ...
) -> None:
    # Build effective redaction set
    if allow_headers is not None:
        # Allowlist mode: only log specified headers
        self._allow_headers = {h.lower() for h in allow_headers}
        self._redact_headers = set()
    else:
        # Redaction mode (default)
        self._allow_headers = None
        base = set() if disable_default_redactions else set(DEFAULT_REDACT_HEADERS)
        if redact_headers:
            base = {h.lower() for h in redact_headers}
        if additional_redact_headers:
            base.update(h.lower() for h in additional_redact_headers)
        self._redact_headers = base

        if disable_default_redactions:
            warnings.warn(
                "Default header redactions disabled. Sensitive headers may be logged.",
                SecurityWarning,
                stacklevel=2,
            )
```

---

## Tasks

### Phase 1: Core Implementation

- [ ] Add `DEFAULT_REDACT_HEADERS` constant
- [ ] Add `additional_redact_headers` parameter
- [ ] Add `allow_headers` parameter for allowlist mode
- [ ] Add `disable_default_redactions` parameter with warning
- [ ] Update `_log_completion` to use new logic

### Phase 2: Testing

- [ ] Add tests for default redaction behavior
- [ ] Add tests for extending defaults
- [ ] Add tests for allowlist mode
- [ ] Add tests for override with warning
- [ ] Add security-focused test cases

### Phase 3: Documentation

- [ ] Update docstrings with security notes
- [ ] Add security section to user guide
- [ ] Add migration guide for existing users
- [ ] Update CHANGELOG

---

## Tests

### Unit Tests

- `tests/unit/test_logging_middleware.py`
  - `test_default_headers_redacted_without_config`
  - `test_authorization_header_redacted_by_default`
  - `test_cookie_header_redacted_by_default`
  - `test_additional_redact_headers_extends_defaults`
  - `test_allow_headers_excludes_unlisted`
  - `test_disable_default_redactions_warns`
  - `test_empty_redact_headers_uses_defaults`

### Integration Tests

- `tests/integration/test_middleware_security.py`
  - End-to-end test with real FastAPI app
  - Verify sensitive headers never appear in log output

---

## Definition of Done

### Code Complete

- [ ] All acceptance criteria implemented
- [ ] Code follows project patterns
- [ ] No new linting errors

### Quality Assurance

- [ ] Unit tests written and passing
- [ ] Integration tests written and passing
- [ ] `ruff check` passes
- [ ] `mypy` passes
- [ ] No regression in existing tests

### Documentation

- [ ] Code has docstrings where needed
- [ ] Security guide updated
- [ ] CHANGELOG updated

---

## Risks / Rollback

### Risks

1. **Risk:** Breaking change for users who rely on seeing all headers
   - **Mitigation:** Provide `disable_default_redactions=True` escape hatch with warning

2. **Risk:** Incomplete default list misses sensitive headers
   - **Mitigation:** Research common header names, allow easy extension

### Rollback Plan

If issues occur:
1. Revert to previous opt-in behavior
2. Keep new parameters but default `disable_default_redactions=True`

---

## Related Stories

- **Related:** Story 4.47 - Redaction defaults alignment
- **Related:** Story 4.46 - Fallback sink PII protection

---

## Change Log

| Date | Change | Author |
|------|--------|--------|
| 2025-01-23 | Initial draft from security audit | Claude |
