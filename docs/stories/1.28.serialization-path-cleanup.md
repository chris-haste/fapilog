# Story 1.28: Serialization Path Cleanup

**Status:** Ready for Code Review
**Priority:** High
**Depends on:** Story 1.26 (Canonical Log Schema v1.1), Story 1.27 (Enricher Pipeline Alignment)

---

## Context / Background

After Stories 1.26 and 1.27, the pipeline produces log events in the v1.1 canonical schema:
- `build_envelope()` outputs `{timestamp, level, message, logger, context, diagnostics, data}`
- Enrichers deep-merge into `context` and `diagnostics`
- `serialize_envelope()` expects this exact structure

**Current problematic code patterns:**

1. **Sinks try/except fallback** (stdout_json.py:44-62, rotating_file.py:140-154):
   ```python
   try:
       view = serialize_envelope(entry)
   except Exception as e:
       # Fallback - THIS WAS THE NORMAL PATH!
       view = serialize_mapping_to_json_bytes(entry)
   ```

2. **Worker try/except fallback** (worker.py:421-447):
   ```python
   async def _try_serialize(self, entry):
       try:
           return serialize_envelope(entry), False
       except Exception:
           # Fallback to raw serialization
           return serialize_mapping_to_json_bytes(entry), False
   ```

**After 1.26 + 1.27:** These exceptions should never occur in normal operation. The fallback becomes a true safety net for edge cases (non-serializable objects, corruption), not the default path.

This story cleans up the serialization path to:
1. Remove exception as the expected flow
2. Simplify `serialize_envelope()` validation
3. Add metrics/logging for actual failures (which are now exceptional)
4. Update tests that explicitly relied on the failure path

---

## Scope (In / Out)

### In Scope

- Simplify `serialize_envelope()` to trust input schema
- Update sink serialization code (remove try/except as normal flow)
- Update worker `_try_serialize()` method
- Add metrics for actual serialization failures
- Update tests that expected schema mismatch
- Verify `strict_envelope_mode` now works correctly
- Performance validation (no more exceptions in hot path)
- Update serialization documentation

### Out of Scope

- New serialization formats (future)
- Compression/encryption processors (existing)
- New sink types (future)

---

## Acceptance Criteria

### AC1: serialize_envelope() Trusts Input Schema

**Description:** `serialize_envelope()` performs minimal validation since input is now guaranteed to be v1.1 compliant from `build_envelope()` + enrichers.

**Validation:**
```python
from fapilog.core.envelope import build_envelope
from fapilog.core.serialization import serialize_envelope
import json

# Normal flow - no exception
envelope = build_envelope(level="INFO", message="test")
view = serialize_envelope(envelope)  # No exception!

parsed = json.loads(view.data)
assert parsed["schema_version"] == "1.0"  # or "1.1"
assert "log" in parsed
assert parsed["log"]["context"] is not None
assert parsed["log"]["diagnostics"] is not None
```

### AC2: Sinks Use Direct Serialization

**Description:** Sinks call `serialize_envelope()` directly without defensive try/except for schema errors. The fallback is retained only for truly exceptional cases (non-JSON-serializable objects).

**Validation:**
```python
# In StdoutJsonSink.write():
# - serialize_envelope() succeeds for all valid log entries
# - Fallback only triggers for non-serializable data (rare)
# - Diagnostics warn only logged for actual failures

# Test: Normal log entries serialize without fallback
from fapilog.plugins.sinks.stdout_json import StdoutJsonSink
from fapilog.core.envelope import build_envelope
import io, sys

sink = StdoutJsonSink()
await sink.start()

# Capture output
envelope = build_envelope(level="INFO", message="test")
# This should NOT trigger diagnostics.warn() for schema errors
await sink.write(envelope)
```

### AC3: Worker _try_serialize() Simplified

**Description:** The worker's `_try_serialize()` method is simplified. Schema validation errors no longer expected.

**Validation:**
```python
# In LoggerWorker._try_serialize():
# - serialize_envelope() expected to succeed
# - Exception path is for edge cases only
# - Metrics recorded for actual failures

from fapilog.core.worker import LoggerWorker
# Worker processes events without schema-related exceptions
```

### AC4: strict_envelope_mode Works Correctly

**Description:** With schema alignment, `strict_envelope_mode=True` now works as intended - only dropping events with actual serialization issues (non-JSON-serializable data), not ALL events.

**Validation:**
```python
from fapilog.core.logger import AsyncLoggerFacade

# With strict mode, normal events are NOT dropped
logger = AsyncLoggerFacade(
    name="test",
    strict_envelope_mode=True,  # Was broken, now works
    ...
)
logger.start()

await logger.info("normal event")  # NOT dropped
await logger.info("bad event", obj=NonSerializable())  # Dropped (correct)

result = await logger.stop_and_drain()
assert result.processed >= 1  # Normal events processed
assert result.dropped >= 1    # Only bad events dropped
```

### AC5: Serialization Failure Metrics

**Description:** Actual serialization failures (now rare) are tracked via metrics.

**Validation:**
```python
# When a serialization failure occurs (non-JSON-serializable object):
# - metrics.record_serialization_error() called
# - diagnostics.warn() emitted with details
# - Event falls back or drops based on strict_mode

# Verify metrics are recorded for actual failures only
```

### AC6: Test Updates for Schema Alignment

**Description:** Tests that explicitly expected schema mismatch or manually worked around it are updated.

**Files requiring updates (comments acknowledging mismatch):**
- `tests/integration/test_serialization_recovery.py:17` - comment: "fails for LogEvent"
- `tests/integration/test_worker_lifecycle.py:481,496` - comments about missing context/diagnostics
- `tests/unit/test_stdout_json_sink_strict.py` - may test fallback behavior

**Files requiring updates (manual `"context": {}` workarounds):**
- `tests/unit/test_core_log_level_wiring.py:79,82` - manually adds context/diagnostics to test data
- `tests/unit/envelope/test_envelope_modes.py:34,49` - manually adds context/diagnostics
- `tests/unit/envelope/test_envelope_properties.py:25` - manually adds context/diagnostics

**Validation:**
- All tests pass with new schema-aligned behavior
- Test comments updated to reflect new behavior (schema now aligned)
- Tests use `build_envelope()` to generate test data instead of manual dicts where appropriate
- Tests verify actual error cases (non-serializable data), not schema mismatch

### AC7: Performance Validation

**Description:** Serialization path no longer incurs exception overhead on every event.

**Validation:**
```python
# Benchmark: serialize 10,000 events
# Before: Exception on every event (~X ms)
# After: No exceptions (~Y ms, Y < X)

# Run: pytest tests/benchmark/test_perf_benchmarks.py -v
# Verify serialization benchmarks show improvement
```

### AC8: Documentation Updated

**Description:** Serialization documentation reflects the cleaned-up behavior.

**Validation:**
- `serialization.py` module docstring updated
- `serialize_envelope()` docstring updated
- Developer docs explain when fallback triggers
- CHANGELOG documents the behavioral change

---

## Implementation Notes

### File Changes

```
src/fapilog/core/serialization.py (MODIFIED - simplify validation)
src/fapilog/core/worker.py (MODIFIED - simplify _try_serialize)
src/fapilog/plugins/sinks/stdout_json.py (MODIFIED - remove defensive try/except)
src/fapilog/plugins/sinks/rotating_file.py (MODIFIED - remove defensive try/except)
tests/integration/test_serialization_recovery.py (MODIFIED - update comments, use build_envelope())
tests/integration/test_worker_lifecycle.py (MODIFIED - update comments)
tests/unit/test_stdout_json_sink_strict.py (MODIFIED)
tests/unit/test_core_log_level_wiring.py (MODIFIED - use build_envelope() instead of manual dicts)
tests/unit/envelope/test_envelope_modes.py (MODIFIED - use build_envelope())
tests/unit/envelope/test_envelope_properties.py (MODIFIED - use build_envelope())
tests/benchmark/test_perf_benchmarks.py (MODIFIED - add serialization benchmark)
```

### Simplified serialize_envelope()

```python
def serialize_envelope(log: Mapping[str, Any]) -> SerializedView:
    """Build a schema-versioned envelope {"schema_version":"1.1","log":{...}}.

    Expects input from build_envelope() + enrichers pipeline, which guarantees
    the v1.1 schema structure. Validation is minimal since schema compliance
    is enforced upstream.

    Raises FapilogError only for truly unserializable data (edge cases).
    """
    # Minimal validation - trust upstream schema compliance
    if "timestamp" not in log or "level" not in log or "message" not in log:
        raise ValueError("missing required fields in log payload")

    # Normalize timestamp if needed
    ts = ensure_rfc3339_utc(log["timestamp"])

    # Build envelope - context/diagnostics/data already present from pipeline
    norm_log: dict[str, Any] = {
        "timestamp": ts,
        "level": str(log["level"]),
        "message": str(log["message"]),
        "context": dict(log.get("context", {})),
        "diagnostics": dict(log.get("diagnostics", {})),
        "data": dict(log.get("data", {})),
    }

    # Copy optional fields
    if "logger" in log:
        norm_log["logger"] = log["logger"]

    envelope = {"schema_version": "1.1", "log": norm_log}
    return serialize_mapping_to_json_bytes(envelope)
```

### Simplified Sink Write

```python
# In StdoutJsonSink.write():
async def write(self, entry: dict[str, Any]) -> None:
    try:
        view = serialize_envelope(entry)
    except Exception as e:
        # This is now an actual error (non-serializable data), not expected
        diagnostics.warn(
            "sink",
            "serialization error (non-serializable data)",
            reason=type(e).__name__,
            detail=str(e),
        )
        if self._strict_envelope_mode:
            return None  # Drop event
        # Best-effort fallback for edge cases
        view = serialize_mapping_to_json_bytes(entry)

    # Continue with write...
```

### Simplified _try_serialize()

```python
async def _try_serialize(
    self, entry: dict[str, Any]
) -> tuple[SerializedView | None, bool]:
    """Serialize entry to envelope format.

    With v1.1 schema alignment, this should succeed for all valid log entries.
    Failures indicate actual issues (non-serializable objects) not schema mismatch.
    """
    try:
        return serialize_envelope(entry), False
    except Exception as exc:
        # This is now exceptional - log and handle
        strict_mode = self._strict_envelope_mode_provider()

        warn(
            "sink",
            "serialization error",
            mode="strict" if strict_mode else "best-effort",
            reason=type(exc).__name__,
            detail=str(exc),
        )

        if strict_mode:
            return None, True  # Drop event

        # Best-effort fallback for edge cases
        try:
            return serialize_mapping_to_json_bytes(entry), False
        except Exception:
            return None, False  # Give up, let dict path handle it
```

---

## Tasks

### Phase 1: Serialization Simplification

- [ ] Update `serialize_envelope()` to expect v1.1 schema input
- [ ] Remove strict `context`/`diagnostics` mapping validation (trust upstream)
- [ ] Add `data` field handling
- [ ] Update schema version to "1.1"

### Phase 2: Sink Cleanup

- [ ] Simplify `StdoutJsonSink.write()` exception handling
- [ ] Simplify `RotatingFileSink.write()` exception handling
- [ ] Update diagnostic messages to indicate actual errors

### Phase 3: Worker Cleanup

- [ ] Simplify `LoggerWorker._try_serialize()`
- [ ] Update comments to reflect new behavior
- [ ] Add metrics for actual serialization failures

### Phase 4: Test Updates

- [ ] Update `test_serialization_recovery.py` comments and assertions
- [ ] Update `test_worker_lifecycle.py` comments
- [ ] Update `test_stdout_json_sink_strict.py` for new behavior
- [ ] Update `test_core_log_level_wiring.py` to use `build_envelope()` instead of manual dicts
- [ ] Update `test_envelope_modes.py` to use `build_envelope()`
- [ ] Update `test_envelope_properties.py` to use `build_envelope()`
- [ ] Add benchmark test for serialization performance

### Phase 5: Documentation

- [ ] Update `serialization.py` module docstring
- [ ] Update `serialize_envelope()` docstring
- [ ] Update sink docstrings
- [ ] Update CHANGELOG

---

## Tests

### Unit Tests

- `tests/unit/test_serialization_cleanup.py` (NEW)
  - `test_serialize_envelope_accepts_v1_1_schema`
  - `test_serialize_envelope_rejects_non_serializable`
  - `test_fallback_only_for_edge_cases`

### Integration Tests

- `tests/integration/test_serialization_recovery.py` (MODIFIED)
  - Update to test actual error cases (non-serializable objects)
  - Remove references to schema mismatch as expected behavior

- `tests/integration/test_strict_mode_behavior.py` (NEW)
  - `test_strict_mode_processes_normal_events`
  - `test_strict_mode_drops_only_bad_events`

### Benchmark Tests

- `tests/benchmark/test_perf_benchmarks.py` (MODIFIED)
  - `test_serialization_throughput_no_exceptions`
  - Compare before/after exception elimination

---

## Definition of Done

### Code Complete

- [ ] All acceptance criteria implemented
- [ ] Exception path is truly exceptional
- [ ] strict_envelope_mode works correctly
- [ ] Code follows project patterns

### Quality Assurance

- [ ] Unit tests written and passing
- [ ] Integration tests updated and passing
- [ ] Benchmark shows performance improvement
- [ ] `ruff check` passes
- [ ] `mypy` passes
- [ ] No regression in existing tests

### Documentation

- [ ] Module docstrings updated
- [ ] Function docstrings updated
- [ ] CHANGELOG updated with behavioral change

---

## Risks / Rollback

### Risks

1. **Risk:** Some code path still produces old schema format
   - **Mitigation:** Comprehensive test coverage; CI catches regressions

2. **Risk:** Third-party code relies on fallback behavior
   - **Mitigation:** Fallback still exists for actual errors; document change

3. **Risk:** Performance benchmark shows no improvement
   - **Mitigation:** Profile to identify bottleneck; exception elimination is proven optimization

### Rollback Plan

If critical issues occur post-release:
1. Revert the PR in a patch release
2. Users can pin to previous version until fix available

---

## Related Stories

- **Depends on:** Story 1.26 - Canonical Log Schema v1.1 Definition
- **Depends on:** Story 1.27 - Enricher Pipeline Schema Alignment
- **Completes:** Epic - Schema Unification (all three stories together)
- **Fixes:** Issue identified in audit - exception-driven hot path

---

## Change Log

| Date | Change | Author |
|------|--------|--------|
| 2025-01-19 | Initial draft | Claude |
| 2025-01-19 | Simplified for breaking release - updated rollback plan | Claude |
