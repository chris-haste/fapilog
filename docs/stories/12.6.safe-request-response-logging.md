# Story 12.6: Logging Request/Response Bodies Without Hanging (Safe Patterns)

**Status:** Ready for Code Review
**Priority:** P1 (High)
**Depends on:** None
**Epic:** 12.0 Cookbook (SEO-Driven Documentation)

---

## Context / Background

Developers add middleware to log request/response bodies and their app "hangs" or breaks streaming responses. Reading the request body consumes it (can't be read twice), and logging large responses blocks the event loop.

fapilog provides safe patterns for body logging with built-in truncation and redaction.

**Target search queries:**

- "fastapi middleware log request body hangs"
- "starlette request body read twice"
- "fastapi log response body"
- "python async request body logging"

**Why fapilog is the answer:** Safe body capture with automatic truncation, redaction, and proper stream handling.

---

## Scope (In / Out)

### In Scope

- Cookbook page explaining the pitfalls
- What NOT to do (anti-patterns)
- Safe body capture pattern
- Truncation and redaction for bodies

### Out of Scope

- Full middleware implementation
- Streaming response handling
- File upload logging

---

## Acceptance Criteria

### AC1: Page Exists with Correct Title

**Description:** Cookbook page created with SEO-optimized title.

**Validation:**
```
docs/cookbook/safe-request-response-logging.md exists
H1: "Logging request/response bodies without hanging (safe patterns)"
```

### AC2: Anti-Patterns Documented

**Description:** Shows what causes hangs.

**Validation:**
- Code example of the wrong way
- Explanation of why it fails (body consumed, blocking I/O)
- Common error symptoms

### AC3: Safe Pattern Shown

**Description:** Working solution that doesn't break the app.

**Validation:**

Note: The `log_request_body` and `log_response_body` parameters need to be verified against current `setup_logging` implementation. Current signature supports:
```python
from fapilog.fastapi import setup_logging

lifespan = setup_logging(
    preset="fastapi",
    skip_paths=["/health"],
    sample_rate=1.0,
    redact_headers=["authorization", "x-api-key"],
)
```

Body logging may require custom middleware or additional configuration. Verify feature availability before documenting.

### AC4: Truncation Explained

**Description:** How to handle large bodies.

**Validation:**
- Default truncation limit
- How to adjust limit
- What truncated output looks like

### AC5: Redaction for Bodies Mentioned

**Description:** Sensitive data in bodies is still redacted.

**Validation:**
- Bodies go through same redaction pipeline
- Example of redacted body in log

---

## Implementation Notes

### File Path

`docs/cookbook/safe-request-response-logging.md`

### Page Structure

```markdown
# Logging request/response bodies without hanging (safe patterns)

Want to log request bodies for debugging? Here's how to do it safely...

## The Problem: Why Body Logging Breaks

### Don't Do This

```python
# This will hang or break your app
@app.middleware("http")
async def log_body(request, call_next):
    body = await request.body()  # Consumed! Can't read again
    ...
```

### What Goes Wrong

- Request body consumed (can't be read by route)
- Large bodies block event loop
- Streaming responses break

## The Solution

```python
# fapilog handles this safely
```

## Truncation for Large Bodies

{Configuration and output example}

## Bodies Are Redacted Too

{Sensitive data example}

## Going Deeper

- [Middleware Reference](/api-reference/middleware)
- [Redaction Guide](/cookbook/redacting-secrets-pii)
```

---

## Tasks

- [ ] Create `docs/cookbook/safe-request-response-logging.md`
- [ ] Write anti-pattern section with examples
- [ ] Document safe pattern
- [ ] Add truncation configuration
- [ ] Mention redaction integration
- [ ] Test code examples
- [ ] Add cross-links

---

## Tests

- Anti-pattern example demonstrates the problem
- Safe pattern works correctly
- Truncation works as documented

---

## Definition of Done

### Content Complete

- [ ] All sections written
- [ ] Anti-patterns clearly explained
- [ ] Safe patterns tested

### SEO Optimized

- [ ] Keywords in H1 and first paragraph
- [ ] Under 1000 words

### Integrated

- [ ] Added to cookbook index
- [ ] Linked from middleware docs

---

## Risks / Rollback

### Risks

1. **Risk:** Body logging feature doesn't exist yet
   - **Mitigation:** Verify feature exists or note as future

### Rollback Plan

Revert commit.

---

## Change Log

| Date | Change | Author |
|------|--------|--------|
| 2026-01-21 | Initial draft | Claude |
