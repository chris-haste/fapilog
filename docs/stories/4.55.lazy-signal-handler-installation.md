# Story 4.55: Lazy Signal Handler Installation

**Status:** Complete
**Priority:** Medium
**Depends on:** None

---

## Context / Background

An external audit (GPT-5.2 assessment, 2026-01-27) identified that signal handlers are installed at module import time, which can conflict with host frameworks:

```python
# src/fapilog/core/shutdown.py:196-200
# Register atexit handler on module import
atexit.register(_atexit_handler)

# Install signal handlers (if enabled)
_install_signal_handlers()
```

This creates problems because:

1. **Framework conflicts:** FastAPI, Uvicorn, Gunicorn, and other frameworks manage their own signal handlers. Fapilog overriding them at import time can break graceful shutdown.

2. **Library etiquette:** Libraries should not install global handlers at import time. This is surprising behavior that violates the principle of least surprise.

3. **No opt-out before installation:** By the time user code runs, handlers are already installed. The `signal_handler_enabled` setting only affects whether new handlers are installed, not whether the import-time installation occurred.

4. **Testing interference:** Tests that import fapilog get signal handlers installed, which can interfere with test frameworks.

### Existing Code

There are currently **two** signal handler mechanisms:

1. **`shutdown.py`** - Global handlers installed at import time, drain all registered loggers
2. **`lifecycle.py`** - Per-logger `install_signal_handlers(logger)` function for explicit use

```python
# src/fapilog/core/lifecycle.py:10-72
def install_signal_handlers(
    logger: Any, *, timeout_seconds: float | None = None
) -> None:
    """Install SIGINT/SIGTERM handlers to drain the logger gracefully."""
    # ... installs handlers that drain a specific logger
```

This story consolidates these into a single, lazy-installation approach.

---

## Scope (In / Out)

### In Scope

- Remove import-time handler installation from `shutdown.py`
- Move handler installation to logger start-time (lazy)
- Consolidate `shutdown.py` global handlers and `lifecycle.py` per-logger handlers
- Add explicit `fapilog.install_shutdown_handlers()` for manual control
- Ensure handlers are only installed once (idempotent)
- Document the change and migration path

### Out of Scope

- Changes to the actual signal handling logic (drain behavior)
- Changes to the atexit drain behavior
- Automatic detection of framework signal handlers

---

## Acceptance Criteria

### AC1: No handlers installed at import time

**Description:** Importing fapilog should not install any signal handlers or atexit handlers.

**Validation:**
```python
import signal
import atexit

# Capture state before import
original_sigterm = signal.getsignal(signal.SIGTERM)
original_sigint = signal.getsignal(signal.SIGINT)
original_atexit_count = len(atexit._exithandlers) if hasattr(atexit, '_exithandlers') else 0

# Import fapilog
import fapilog

# Handlers should be unchanged
assert signal.getsignal(signal.SIGTERM) == original_sigterm
assert signal.getsignal(signal.SIGINT) == original_sigint
```

### AC2: Handlers installed on first logger start

**Description:** Signal and atexit handlers are installed when the first logger is started (via `get_logger()`, `runtime()`, etc.).

**Validation:**
```python
import signal
import fapilog

original_sigterm = signal.getsignal(signal.SIGTERM)

# Get a logger (this starts the pipeline)
logger = fapilog.get_logger()

# Now handlers should be installed (if enabled in settings)
# Note: May be SIG_DFL or a custom handler depending on platform
assert signal.getsignal(signal.SIGTERM) != original_sigterm
```

### AC3: Manual handler installation function

**Description:** Users can explicitly install handlers via `fapilog.install_shutdown_handlers()`.

**Validation:**
```python
import signal
import fapilog

original_sigterm = signal.getsignal(signal.SIGTERM)

# Explicitly install handlers before creating any loggers
fapilog.install_shutdown_handlers()

assert signal.getsignal(signal.SIGTERM) != original_sigterm
```

### AC4: Idempotent installation

**Description:** Calling install multiple times or starting multiple loggers only installs handlers once.

**Validation:**
```python
import fapilog

# Install multiple times - should not raise or double-install
fapilog.install_shutdown_handlers()
fapilog.install_shutdown_handlers()

# Start multiple loggers
logger1 = fapilog.get_logger("a")
logger2 = fapilog.get_logger("b")

# Should work without issues
```

### AC5: Opt-out via settings prevents installation

**Description:** Setting `signal_handler_enabled=False` prevents handler installation even on logger start.

**Validation:**
```python
import os
import signal
import fapilog

# Disable signal handlers via environment
os.environ["FAPILOG__CORE__SIGNAL_HANDLER_ENABLED"] = "false"

original_sigterm = signal.getsignal(signal.SIGTERM)

# Get logger - should NOT install signal handlers
logger = fapilog.get_logger()

# Handlers should NOT be installed
assert signal.getsignal(signal.SIGTERM) == original_sigterm

# Cleanup
del os.environ["FAPILOG__CORE__SIGNAL_HANDLER_ENABLED"]
```

### AC6: Lifecycle.install_signal_handlers deprecated

**Description:** `lifecycle.install_signal_handlers()` is deprecated in favor of `fapilog.install_shutdown_handlers()`.

**Validation:**
```python
import warnings
from fapilog.core.lifecycle import install_signal_handlers

with warnings.catch_warnings(record=True) as w:
    warnings.simplefilter("always")
    install_signal_handlers(logger)
    assert len(w) == 1
    assert "deprecated" in str(w[0].message).lower()
```

### AC7: Documentation updated

**Description:** User guide documents the lazy installation behavior and manual installation option.

**Validation:**
- `docs/user-guide/configuration.md` includes a "Shutdown Handler Installation" section
- Documents when/why to use `fapilog.install_shutdown_handlers()`
- Explains framework integration considerations (FastAPI, Uvicorn signal handling)

---

## Implementation Notes

### File Changes

```
src/fapilog/core/shutdown.py (MODIFIED - remove import-time installation, add install function)
src/fapilog/core/lifecycle.py (MODIFIED - deprecate install_signal_handlers)
src/fapilog/core/logger.py (MODIFIED - call lazy install in _LoggerMixin.start)
src/fapilog/__init__.py (MODIFIED - export install_shutdown_handlers)
docs/user-guide/configuration.md (MODIFIED - document handler installation)
```

### Key Code

```python
# shutdown.py
import threading

_handlers_installed: bool = False
_install_lock = threading.Lock()

def install_shutdown_handlers() -> bool:
    """Install signal and atexit handlers for graceful shutdown.

    Called automatically on first logger start. Can be called manually
    for early installation or in frameworks that need explicit control.

    Returns:
        True if handlers were installed, False if already installed or disabled.

    Example:
        # Install before creating loggers (optional)
        import fapilog
        fapilog.install_shutdown_handlers()

        # Or let it happen automatically
        logger = fapilog.get_logger()  # Installs handlers on first call
    """
    global _handlers_installed

    with _install_lock:
        if _handlers_installed:
            return False

        settings = _get_shutdown_settings()

        if settings["atexit_drain_enabled"]:
            atexit.register(_atexit_handler)

        if settings["signal_handler_enabled"]:
            _do_install_signal_handlers()

        _handlers_installed = True
        return True

# Remove import-time calls (DELETE these lines):
# atexit.register(_atexit_handler)
# _install_signal_handlers()
```

```python
# logger.py - in _LoggerMixin.start()
from .shutdown import install_shutdown_handlers

class _LoggerMixin:
    def start(self) -> None:
        # ... existing start logic ...

        # Lazy install shutdown handlers on first logger start
        install_shutdown_handlers()

        # ... rest of start logic ...
```

```python
# lifecycle.py - deprecate old function
import warnings

def install_signal_handlers(
    logger: Any, *, timeout_seconds: float | None = None
) -> None:
    """Install SIGINT/SIGTERM handlers to drain the logger gracefully.

    .. deprecated:: 0.8.0
        Use :func:`fapilog.install_shutdown_handlers` instead.
        This function will be removed in version 1.0.0.
    """
    warnings.warn(
        "install_signal_handlers() is deprecated. "
        "Use fapilog.install_shutdown_handlers() instead. "
        "Handlers are now installed automatically on first logger start.",
        DeprecationWarning,
        stacklevel=2,
    )
    # ... existing implementation for backwards compatibility ...
```

```python
# __init__.py
from .core.shutdown import install_shutdown_handlers

__all__ = [
    # ... existing exports ...
    "install_shutdown_handlers",
]
```

---

## Tasks

### Phase 1: Core Changes

- [ ] Add `_handlers_installed` flag and `_install_lock` to `shutdown.py`
- [ ] Rename internal `_install_signal_handlers()` to `_do_install_signal_handlers()`
- [ ] Create public `install_shutdown_handlers()` function with idempotency
- [ ] Remove import-time `atexit.register()` and `_install_signal_handlers()` calls
- [ ] Export `install_shutdown_handlers` from `fapilog.__init__`

### Phase 2: Integration

- [ ] Call `install_shutdown_handlers()` in `_LoggerMixin.start()`
- [ ] Verify `runtime()` and `runtime_async()` context managers work correctly
- [ ] Verify FastAPI lifespan integration still works

### Phase 3: Deprecation

- [ ] Add deprecation warning to `lifecycle.install_signal_handlers()`
- [ ] Update docstring with deprecation notice
- [ ] Keep backwards compatibility for now (function still works)

### Phase 4: Documentation

- [ ] Add "Shutdown Handler Installation" section to `docs/user-guide/configuration.md`
- [ ] Document `install_shutdown_handlers()` public API
- [ ] Add "Framework Integration" section explaining signal handler considerations
- [ ] Add migration note for users calling `lifecycle.install_signal_handlers()`
- [ ] Update CHANGELOG with behavior change notice

### Phase 5: Test Isolation

- [ ] Add `_reset_shutdown_state()` test helper for test isolation
- [ ] Update existing tests that depend on import-time installation

---

## Tests

### Unit Tests

- `tests/unit/test_shutdown_lazy_install.py`
  - test_import_does_not_install_handlers
  - test_get_logger_installs_handlers
  - test_install_shutdown_handlers_explicit
  - test_installation_is_idempotent
  - test_disabled_setting_prevents_installation
  - test_atexit_disabled_prevents_atexit_registration

- `tests/unit/test_lifecycle_deprecation.py`
  - test_install_signal_handlers_emits_deprecation_warning
  - test_deprecated_function_still_works

### Integration Tests

- `tests/integration/test_shutdown_integration.py`
  - test_fastapi_lifespan_with_lazy_handlers
  - test_multiple_loggers_single_handler_installation
  - test_runtime_context_manager_installs_handlers

---

## Definition of Done

### Code Complete

- [ ] All acceptance criteria implemented
- [ ] Code follows project patterns
- [ ] No new linting errors

### Quality Assurance

- [ ] Unit tests written and passing
- [ ] Integration tests written and passing
- [ ] `ruff check` passes
- [ ] `mypy` passes
- [ ] No regression in existing tests

### Documentation

- [ ] Code has docstrings where needed
- [ ] Configuration docs updated
- [ ] CHANGELOG updated with behavior change and migration note

---

## Risks / Rollback

### Risks

1. **Risk:** Users relying on import-time handler installation may experience different shutdown behavior
   - **Mitigation:** Document the change clearly; provide `install_shutdown_handlers()` for explicit early installation

2. **Risk:** Race condition if multiple threads start loggers simultaneously
   - **Mitigation:** Use threading lock for idempotent installation

3. **Risk:** Deprecation of `lifecycle.install_signal_handlers()` may break existing code
   - **Mitigation:** Keep function working with deprecation warning; remove in 1.0.0

### Rollback Plan

If issues occur:
1. Users can call `fapilog.install_shutdown_handlers()` immediately after import
2. Revert PR if fundamental issues discovered

---

## Related Stories

- **Related:** Story 6.13 - Graceful shutdown handling (original implementation)

---

## Code Review

**Date:** 2026-01-27
**Reviewer:** Claude
**Verdict:** OK to PR

### Summary

Reviewed lazy signal handler installation implementation. All 7 acceptance criteria verified with code evidence.

### AC Verification

| Criterion | Evidence |
|-----------|----------|
| AC1: No handlers at import | `shutdown.py:253-254` - No import-time calls |
| AC2: Handlers on logger start | `logger.py:196-201` - `install_shutdown_handlers()` in start() |
| AC3: Manual installation | `shutdown.py:202-237` - Public function with docstring |
| AC4: Idempotent | `shutdown.py:225-231` - Lock + flag pattern |
| AC5: Opt-out via settings | `shutdown.py:227-233` - Settings checks before install |
| AC6: Deprecation warning | `lifecycle.py:16-27` - DeprecationWarning with stacklevel=2 |
| AC7: Documentation | `configuration.md:337-416` - Full section added |

### Quality Gates

- [x] ruff check passed
- [x] ruff format passed
- [x] mypy passed
- [x] Coverage 95% (>90% threshold)
- [x] No weak assertions
- [x] No dead code

---

## Change Log

| Date | Change | Author |
|------|--------|--------|
| 2026-01-27 | Initial draft from audit findings | Claude |
| 2026-01-27 | Revised: addressed existing lifecycle.py function, fixed Settings API, updated implementation location | Claude |
| 2026-01-27 | Implementation complete, code review passed | Claude |
