# Story 1.22: Integrate or Document Compliance Validation

**Status:** Ready
**Priority:** Low
**Depends on:** None

---

## Context / Background

The GPT-5.2 audit noted that "enterprise" modules appear more aspirational than integrated. Investigation confirms that `compliance.py` validation functions are exported but never called in any runtime path.

**Current state in `src/fapilog/core/compliance.py`:**

```python
def validate_compliance_policy(policy: CompliancePolicy) -> ValidationResult:
    """Validate a CompliancePolicy against baseline enterprise rules."""
    # 70 lines of validation logic
    ...

def validate_data_handling(*, level: ComplianceLevel, settings: DataHandlingSettings) -> ValidationResult:
    """Validate data handling settings against a compliance level."""
    # 60 lines of validation logic
    ...
```

**Usage analysis:**

| Function | Exported | Called in Runtime |
|----------|----------|-------------------|
| `validate_compliance_policy` | Yes (`core/__init__.py:203`) | **No** |
| `validate_data_handling` | Yes (`core/__init__.py:204`) | **No** |
| `validate_security` | Yes | Yes (`settings.py:1281`) |

**Problem:**

- 185 lines of validation code that's never executed
- Maintenance burden without runtime value
- Confusing for users who expect it to be wired in
- `encrypt_audit_logs` validation requires `True` but encryption isn't implemented (related: Story 4.29)

---

## Scope (In / Out)

### In Scope

- Option A: Integrate compliance validation into `Settings.validate_async()`
- Option B: Document as opt-in utility and remove from `__all__`
- Update docstrings to clarify usage expectations
- Fix validation rules that reference unimplemented features

### Out of Scope

- Implementing actual encryption (Story 4.29 covers config accuracy)
- Adding new compliance frameworks
- Changing CompliancePolicy structure

---

## Acceptance Criteria

### AC1: Decision Documented

**Description:** A clear decision is made and documented on integration vs opt-in.

**Validation:**

```markdown
# In docs/architecture/compliance.md or similar
## Compliance Validation

The compliance validation utilities are [integrated/opt-in]...
```

### AC2: If Integrated - Validation Called at Startup

**Description:** `validate_compliance_policy` is called during settings validation when audit is enabled.

**Validation:**

```python
# In Settings.validate_async()
# Note: AuditSinkSettings has no 'enabled' field; check compliance_level instead
if self.sinks.audit.compliance_level != "none":
    from .compliance import validate_compliance_policy
    from .audit import ComplianceLevel, CompliancePolicy

    policy = CompliancePolicy(
        level=ComplianceLevel(self.sinks.audit.compliance_level),
        encrypt_audit_logs=self.sinks.audit.encrypt_logs,
        require_integrity_check=self.sinks.audit.require_integrity,
        retention_days=self.sinks.audit.retention_days,
    )
    result = validate_compliance_policy(policy)
    result.raise_if_error(plugin_name="compliance")
```

### AC3: If Opt-In - Exports Clarified

**Description:** Functions remain available but documentation clarifies they're utilities.

**Validation:**

```python
# Docstring updated
def validate_compliance_policy(policy: CompliancePolicy) -> ValidationResult:
    """
    Validate a CompliancePolicy against baseline enterprise rules.

    Note: This is an opt-in utility function. It is NOT automatically
    called during startup. Call it explicitly if you need compliance
    validation for your policies.

    Example:
        from fapilog.core import validate_compliance_policy, CompliancePolicy

        policy = CompliancePolicy(level=ComplianceLevel.HIPAA, ...)
        result = validate_compliance_policy(policy)
        if not result.ok:
            print(result.issues)
    """
```

### AC4: Validation Rules Updated

**Description:** Validation rules don't require unimplemented features.

**Validation:**

```python
# After Story 4.29, encrypt_audit_logs defaults to False
# Validation should warn, not error, if encryption is disabled
# Or skip encryption check entirely until implemented
```

---

## Implementation Notes

### Option A: Integration (Recommended)

**Pros:**

- Catches misconfigurations early
- Provides value for enterprise users
- Justifies the code's existence

**Cons:**

- May break existing configs that don't meet baseline
- Need to handle encrypt_audit_logs=False gracefully

**Implementation:**

```python
# settings.py - in Settings.validate_async()

# Validate compliance if audit sink is configured
if self.sinks.audit.compliance_level != "none":
    from .compliance import validate_compliance_policy
    from .audit import ComplianceLevel, CompliancePolicy

    policy = CompliancePolicy(
        level=ComplianceLevel(self.sinks.audit.compliance_level),
        enabled=True,
        encrypt_audit_logs=self.sinks.audit.encrypt_logs,
        require_integrity_check=self.sinks.audit.require_integrity,
        retention_days=self.sinks.audit.retention_days,
    )
    comp_result = validate_compliance_policy(policy)
    # Use warnings for non-critical issues
    for issue in comp_result.issues:
        if issue.severity == "error":
            comp_result.raise_if_error(plugin_name="compliance")
        else:
            import warnings
            warnings.warn(f"Compliance: {issue.field} - {issue.message}")
```

### Option B: Opt-In Documentation

**Pros:**

- No breaking changes
- Simpler implementation

**Cons:**

- Code remains unused
- Users may not discover it

**Implementation:**

- Update docstrings with usage examples
- Add to user guide as "Enterprise Utilities"
- Consider removing from `__all__` to reduce API surface

### File Changes

```text
src/fapilog/core/settings.py (MODIFIED - if integrating)
src/fapilog/core/compliance.py (MODIFIED - update docstrings/rules)
docs/user-guide/enterprise.md (NEW or MODIFIED)
```

---

## Tasks

### Phase 1: Decision

- [ ] Review with stakeholders: integrate vs opt-in
- [ ] Document decision rationale

### Phase 2: Implementation

If integrating:

- [ ] Add compliance validation to `Settings.validate_async()`
- [ ] Handle encrypt_audit_logs=False gracefully (warning, not error)
- [ ] Test with various compliance levels

If opt-in:

- [ ] Update function docstrings with examples
- [ ] Add to user documentation
- [ ] Consider removing from `__all__`

### Phase 3: Documentation

- [ ] Document compliance validation in user guide
- [ ] Update CHANGELOG

---

## Tests

### If Integrating

- `tests/unit/test_settings_compliance_validation.py`
  - Test validation called when audit enabled
  - Test warnings for non-critical issues
  - Test errors for critical issues

### If Opt-In

- Existing tests sufficient
- Add doctest examples to functions

---

## Definition of Done

### Code Complete

- [ ] Decision made and documented
- [ ] Implementation complete per decision
- [ ] Validation rules don't require unimplemented features

### Quality Assurance

- [ ] All tests pass
- [ ] `ruff check` passes
- [ ] `mypy` passes

### Documentation

- [ ] User guide updated
- [ ] CHANGELOG updated

---

## Risks / Rollback

### Risks

1. **Risk:** Integration breaks existing configurations
   - **Mitigation:** Use warnings for soft requirements; only error on critical

2. **Risk:** Validation rules are too strict
   - **Mitigation:** Start with warnings; tighten over time

### Rollback Plan

If issues occur:

1. Disable validation call in settings
2. Revert to opt-in approach
3. Document as utility only

---

## Related Stories

- **Related:** Story 4.29 - Audit encryption config accuracy
- **Related:** Story 3.4a - Compliance plugins framework

---

## Change Log

| Date       | Change        | Author |
|------------|---------------|--------|
| 2026-01-16 | Initial draft | Claude |
