# Story 5.x Series: Plugin System Completion & Enhancement

## Overview

This series addresses gaps identified in the plugin system audit, bringing fapilog's plugin architecture to enterprise-grade quality. Stories are ordered by implementation dependency and priority.

---

## Implementation Order

### Phase 1: Critical Foundation (Week 1-2)

| Story   | Title                                                                               | Priority | Effort | Dependencies |
| ------- | ----------------------------------------------------------------------------------- | -------- | ------ | ------------ |
| **5.0** | [Wire Processors into Pipeline](./5.0.wire-processors-into-pipeline.md)             | Critical | Medium | None         |
| **5.1** | [Fix PLUGIN_METADATA Inconsistencies](./5.1.fix-plugin-metadata-inconsistencies.md) | Critical | Small  | None         |

These stories fix fundamental issues where documented features don't work.

### Phase 2: High-Value Features (Week 2-4)

| Story    | Title                                                                                | Priority | Effort | Dependencies    |
| -------- | ------------------------------------------------------------------------------------ | -------- | ------ | --------------- |
| **5.2**  | [Add Filter Plugin Type](./5.2.add-filter-plugin-type.md)                            | High     | Medium | 5.0 (pattern)   |
| **5.3**  | [Enhanced Sampling & Rate Limiting](./5.3.add-sampling-and-rate-limiting-plugins.md) | High     | Medium | 5.2             |
| **5.4**  | [Plugin Testing Guide & Fixtures](./5.4.plugin-testing-guide.md)                     | High     | Medium | None (parallel) |
| **5.5**  | [Cloud Sink Examples](./5.5.cloud-sink-examples.md) (Epic)                           | High     | -      | See 5.14, 5.15  |
| **5.14** | [AWS CloudWatch Sink](./5.14.aws-cloudwatch-sink.md)                                 | High     | Medium | None            |
| **5.15** | [Grafana Loki Sink](./5.15.loki-sink.md)                                             | High     | Medium | None            |

These stories add missing functionality that enterprise users expect.

**Note:** Stories 5.14 and 5.15 implement the two official cloud sinks (SDK-based and HTTP-based patterns respectively). These are fully testable in CI via LocalStack (AWS) and Docker (Loki), providing reference implementations for users building their own cloud integrations.

### Phase 3: Performance & Observability (Week 4-5)

| Story   | Title                                                                  | Priority | Effort | Dependencies |
| ------- | ---------------------------------------------------------------------- | -------- | ------ | ------------ |
| **5.6** | [HTTP Sink Batching](./5.6.http-sink-batching.md)                      | Medium   | Small  | None         |
| **5.7** | [Plugin Observability Metrics](./5.7.plugin-observability-metrics.md)  | Medium   | Small  | 5.0          |
| **5.8** | [OpenTelemetry Integration](./5.8.opentelemetry-plugin-integration.md) | Medium   | Medium | 5.7          |

These stories improve performance and monitoring capabilities.

### Phase 4: Processor Value & API Refinement (Week 5-6)

| Story    | Title                                                                     | Priority | Effort | Dependencies |
| -------- | ------------------------------------------------------------------------- | -------- | ------ | ------------ |
| **5.9**  | [Add flush() to Plugin Protocols](./5.9.add-flush-to-plugin-protocols.md) | Low      | Small  | None         |
| **5.10** | [Plugin Dependency Declaration](./5.10.plugin-dependency-declaration.md)  | Low      | Medium | None         |
| **5.13** | [SizeGuardProcessor](./5.13.size-guard-processor.md)                      | Medium   | Small  | 5.0          |

These stories refine the plugin API and add practical processor functionality.

### Out of Scope

The following stories are **not currently in scope** for fapilog:

| Story    | Title                         | Reason                                                        |
| -------- | ----------------------------- | ------------------------------------------------------------- |
| ~~5.11~~ | ~~Plugin Hot-Reload~~         | Library focus: users implement their own runtime management   |
| ~~5.12~~ | ~~Plugin Marketplace Client~~ | Library focus: standard Python packaging (PyPI) is sufficient |

fapilog is designed as a **plugin-enabling library** — it provides the infrastructure for users to build their own plugins (Kafka, cloud sinks, custom processors, etc.) rather than bundling them.

---

## Dependency Graph

```
5.0 Wire Processors ─────────────────┬──► 5.2 Filter Plugins ──► 5.3 Sampling
                                     │
                                     └──► 5.13 SizeGuardProcessor
5.1 Fix Metadata ────────────────────────────────────────────► (parallel)

5.4 Testing Guide ───────────────────────────────────────────► (parallel)

5.5 Cloud Sink Examples (Epic)
├── 5.14 AWS CloudWatch Sink ────────────────────────────────► (SDK pattern)
└── 5.15 Grafana Loki Sink ──────────────────────────────────► (HTTP pattern)

5.6 HTTP Batching ───────────────────────────────────────────► (independent)

5.7 Metrics ─────────────────────────► 5.8 OpenTelemetry

5.9 flush() ─────────────────────────────────────────────────► (independent)

5.10 Dependencies ───────────────────────────────────────────► (independent)
```

---

## Total Effort Estimate

| Priority  | Story Count | Total Effort    |
| --------- | ----------- | --------------- |
| Critical  | 2           | ~4-6 days       |
| High      | 6           | ~16-22 days     |
| Medium    | 4           | ~8-10 days      |
| Low       | 2           | ~4-6 days       |
| **Total** | **14**      | **~32-44 days** |

_Note: Stories 5.11 (Hot-Reload) and 5.12 (Marketplace) are out of scope._
_Cloud sinks (5.14, 5.15) are fully CI-testable via LocalStack and Docker._

---

## Success Metrics

### Phase 1 Complete

- [ ] Processors execute in pipeline and appear in logs
- [ ] All PLUGIN_METADATA names match class `name` attributes
- [ ] Documentation matches implementation

### Phase 2 Complete

- [ ] Filter plugins can drop events before enrichment
- [ ] Adaptive sampling reduces log volume under load
- [ ] Plugin authors have pytest fixtures and testing guide
- [ ] AWS CloudWatch sink is production-ready with LocalStack CI tests
- [ ] Grafana Loki sink is production-ready with Docker CI tests
- [ ] Both cloud sinks serve as reference implementations for users

### Phase 3 Complete

- [ ] HTTP sink batches requests (configurable)
- [ ] Plugin load/start times visible in Prometheus
- [ ] OpenTelemetry spans created for plugin operations

### Phase 4 Complete

- [ ] `flush()` available on all buffering sinks
- [ ] Plugins can declare dependencies on other plugins
- [ ] `SizeGuardProcessor` enforces payload size limits
- [ ] Processor stage has a practical, useful built-in

---

## Parallel Work Tracks

For teams with multiple developers, these can be worked in parallel:

**Track A (Core Pipeline):** 5.0 → 5.2 → 5.3 → 5.13

**Track B (DX/Docs):** 5.1, 5.4 (independent)

**Track C (Cloud Sinks):** 5.14, 5.15 (parallel, both independent)

**Track D (Observability):** 5.6 → 5.7 → 5.8

**Track E (API Refinement):** 5.9, 5.10 (independent)

---

## Related Documents

- [Plugin Audit Report](./plugin-audit-report.md) - Original audit findings
- [Epic 3: Plugin Ecosystem Foundation](../prd/epic-3-plugin-ecosystem-foundation.md)
- [Plugin Development Guide](../plugins/index.md)

---

## Change Log

| Date       | Change                                                                   |
| ---------- | ------------------------------------------------------------------------ |
| 2026-01-05 | Added Stories 5.14 (AWS CloudWatch) and 5.15 (Loki) as official sinks    |
| 2026-01-05 | Added Story 5.13 (SizeGuardProcessor); marked 5.11, 5.12 as out of scope |
| 2026-01-03 | Initial creation from audit recommendations                              |
