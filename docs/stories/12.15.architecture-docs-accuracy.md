# Story 12.15: Architecture Documentation Accuracy

**Status:** Complete
**Priority:** Medium
**Depends on:** None

---

## Context / Background

An external audit (GPT-5.2 assessment, 2026-01-27) identified that architecture documentation contains historical/aspirational content that doesn't match the current implementation:

### Issue 1: Monolithic architecture.md is a historical blueprint

The root-level `docs/architecture.md` (2026 lines) is a "Fapilog v3 Architecture Document" dated 2024-01-XX. It describes components and patterns that were planned but either:
- Were never implemented (e.g., `ComplianceEngine`, `UniversalSettings`)
- Were implemented differently than described
- Have since evolved

This document was later split into `docs/architecture/` but the monolithic version remains, causing confusion.

### Issue 2: Split architecture docs contain stale references

The `docs/architecture/` directory contains 28 files, some of which are accurate (e.g., `pipeline-stages.md`, `high-level-architecture.md`) but others reference non-existent components:

**Verified non-existent in `src/`:**
- `ComplianceEngine`
- `UniversalSettings`
- `EventCategory` enum
- `AsyncLoggingContainer` (as described)

### Issue 3: Story-era phrasing in documentation

215 files in `docs/` and 70 files in `tests/` contain "Story X.Y" references which may confuse external readers who aren't familiar with the project's internal development methodology.

---

## Scope (In / Out)

### In Scope

- Delete `docs/architecture.md` (monolithic blueprint)
- Audit `docs/architecture/*.md` files for accuracy
- Remove or update references to non-existent components
- Add disclaimer to any intentionally aspirational content
- Document which architecture files are authoritative vs planning

### Out of Scope

- Removing "Story X.Y" references from all files (too broad)
- Rewriting architecture docs from scratch
- Creating new architecture documentation
- Auditing test files for story references

---

## Acceptance Criteria

### AC1: Monolithic architecture.md deleted

**Description:** The root-level `docs/architecture.md` file is removed since `docs/architecture/` contains its decomposed content.

**Validation:**
```bash
# File should not exist
test ! -f docs/architecture.md
```

### AC2: Architecture index updated

**Description:** `docs/architecture/index.md` is updated to only reference accurate, current documentation.

**Validation:**
```bash
# Should not reference ComplianceEngine or UniversalSettings
! grep -i "ComplianceEngine\|UniversalSettings" docs/architecture/index.md
```

### AC3: Non-existent components removed or marked

**Description:** References to `ComplianceEngine`, `UniversalSettings`, `EventCategory`, and `AsyncLoggingContainer` are either removed or clearly marked as "planned/future".

**Validation:**
```bash
# Count of unmarked references should be zero
# (marked = prefixed with "Planned:" or in a "Future Work" section)
grep -rn "ComplianceEngine\|UniversalSettings" docs/architecture/ | grep -v "Planned\|Future\|TODO" | wc -l
# Should output 0
```

### AC4: components.md accuracy

**Description:** `docs/architecture/components.md` only documents components that exist in `src/`.

**Validation:**
```python
# All component classes mentioned should exist
import ast
import pathlib

components_doc = pathlib.Path("docs/architecture/components.md").read_text()
# Extract class names mentioned
# Verify each exists in src/fapilog/
```

### AC5: data-models.md accuracy

**Description:** `docs/architecture/data-models.md` only documents models that exist in `src/`.

**Validation:**
```bash
# Settings should reference actual Settings class, not UniversalSettings
grep -c "UniversalSettings" docs/architecture/data-models.md
# Should output 0
```

### AC6: Build still passes

**Description:** Documentation build completes without errors after changes.

**Validation:**
```bash
sphinx-build -W -b html docs/ docs/_build/html
```

---

## Implementation Notes

### Files to Delete

```
docs/architecture.md (DELETE - replaced by docs/architecture/)
```

### Files to Audit and Update

```
docs/architecture/index.md (MODIFY - remove stale TOC entries)
docs/architecture/components.md (MODIFY - remove non-existent components)
docs/architecture/data-models.md (MODIFY - remove UniversalSettings, fix Settings reference)
docs/architecture/core-workflows.md (AUDIT - check workflow accuracy)
docs/architecture/built-in-core-features.md (AUDIT - verify feature claims)
```

### Files That Are Accurate (No Changes Needed)

Based on verification:
- `docs/architecture/high-level-architecture.md` - References real code paths
- `docs/architecture/pipeline-stages.md` - References `LoggerWorker._flush_batch()`
- `docs/architecture/async-sync-boundary.md` - Documents real patterns
- `docs/architecture/plugin-error-isolation.md` - Documents real behavior

### Key Changes

#### Remove from components.md

```markdown
<!-- DELETE these sections -->
### ComplianceEngine
### AsyncLoggingContainer (if describing non-existent version)
```

#### Update data-models.md

```markdown
<!-- CHANGE -->
### UniversalSettings â†’ ### Settings

<!-- UPDATE content to match actual Settings class -->
```

#### Update index.md

Remove TOC entries for deleted/non-existent sections.

---

## Tasks

### Phase 1: Delete Monolithic File

- [ ] Delete `docs/architecture.md`
- [ ] Verify docs build still works

### Phase 2: Audit Components and Models

- [ ] Review `docs/architecture/components.md` against `src/fapilog/`
- [ ] Remove `ComplianceEngine` section
- [ ] Update `AsyncLoggingContainer` to match reality or remove
- [ ] Review `docs/architecture/data-models.md`
- [ ] Replace `UniversalSettings` with `Settings`
- [ ] Update field descriptions to match actual implementation

### Phase 3: Update Index

- [ ] Update `docs/architecture/index.md` TOC
- [ ] Remove links to deleted sections
- [ ] Add note about which docs are authoritative

### Phase 4: Verification

- [ ] Run docs build
- [ ] Grep for removed component names
- [ ] Manual review of updated files

---

## Tests

### Validation Scripts

```bash
# Verify monolithic file deleted
test ! -f docs/architecture.md && echo "PASS: architecture.md deleted"

# Verify no unmarked stale references
if grep -rn "ComplianceEngine\|UniversalSettings" docs/architecture/ | grep -v "Planned\|Future\|TODO" | grep -q .; then
    echo "FAIL: Found unmarked stale references"
else
    echo "PASS: No unmarked stale references"
fi

# Verify docs build
sphinx-build -W -b html docs/ docs/_build/html && echo "PASS: Docs build"
```

---

## Definition of Done

### Code Complete

- [ ] Monolithic architecture.md deleted
- [ ] components.md updated
- [ ] data-models.md updated
- [ ] index.md updated
- [ ] No broken internal links

### Quality Assurance

- [ ] Docs build passes (`sphinx-build -W`)
- [ ] No stale component references
- [ ] Manual review of changes

### Documentation

- [ ] CHANGELOG updated

---

## Risks / Rollback

### Risks

1. **Risk:** Deleting architecture.md may break external links
   - **Mitigation:** File is in `docs/` not published API; redirect can be added if needed

2. **Risk:** Removing component docs may lose useful design context
   - **Mitigation:** Move to `docs/architecture/future/` or `docs/design/` if valuable

3. **Risk:** Missing something that actually exists
   - **Mitigation:** Grep verification before removing any section

### Rollback Plan

If issues occur:
1. Restore `docs/architecture.md` from git
2. Revert individual file changes as needed

---

## Related Stories

- **Origin:** GPT-5.2 External Audit (2026-01-27)
- **Related:** Story 10.18 - Documentation accuracy for redaction/envelope

---

## Code Review

**Date:** 2026-01-27
**Reviewer:** Claude
**Verdict:** OK to PR

### Summary

Reviewed documentation-only changes removing stale architecture references to non-existent components and deleting the outdated monolithic `docs/architecture.md` file.

### AC Verification

| Criterion | Evidence |
|-----------|----------|
| AC1: Monolithic architecture.md deleted | `git diff` shows file deletion (-2,025 lines) |
| AC2: Architecture index updated | `index.md` diff removes stale TOC entries |
| AC3: Non-existent components removed or marked | `grep -rn` returns 0 unmarked stale references |
| AC4: components.md accuracy | Documents AsyncLogger, AsyncLoggingContainer, Settings (all exist in `src/`) |
| AC5: data-models.md accuracy | `UniversalSettings` replaced with `Settings` |
| AC6: Build still passes | `sphinx-build -W` succeeds |

### Quality Gates

- [x] Docs build passes (`sphinx-build -W`)
- [x] No stale component references
- [x] Manual review of changes
- [x] CHANGELOG updated

### Issues Addressed

- [P1] Missing CHANGELOG entry - Fixed in `CHANGELOG.md:19`

---

## Change Log

| Date | Change | Author |
|------|--------|--------|
| 2026-01-27 | Initial draft from audit findings | Claude |
