# Story 5.26: DRY Environment Variable Alias Validators

## Status: Planned

## Priority: Critical

## Estimated Effort: Medium (2-3 days)

## Dependencies

- **Depends on:** None
- **Prerequisite for:** None
- **Related to:** Story 5.25 (Extract Config Builders)

## Epic / Series

Part of Series 5.x: Plugin System Completion & Enhancement

---

## Context / Background

The `src/fapilog/core/settings.py` file contains four nearly identical environment variable alias validators (lines 1003-1228):

1. `_apply_cloudwatch_env_aliases()` - ~52 lines
2. `_apply_loki_env_aliases()` - ~65 lines
3. `_apply_postgres_env_aliases()` - ~70 lines
4. `_apply_sink_routing_env_aliases()` - ~32 lines

Each validator follows the same pattern:
1. Build an `env_map` dict mapping field names to `os.getenv()` calls
2. Iterate over the map and call `setattr()` with type conversion
3. Handle special cases (booleans, durations, lists)

This repetition creates several problems:

1. **Maintenance debt:** ~200 lines of similar-but-different code
2. **Bug propagation risk:** Fixes in one validator may not be applied to others
3. **Cognitive load:** Developers must read through similar code to find differences
4. **Onboarding friction:** "Why are there 4 similar functions?" creates confusion
5. **Extension cost:** Adding a new sink config requires copying ~50 lines

The Human Understandability Audit identified this as a **P0 issue** - the second-ranked hotspot.

---

## User Story

**As a** fapilog maintainer
**I want** a single generic environment variable alias system
**So that** adding new sink configurations requires minimal boilerplate and bugs are fixed once

---

## Scope (In / Out)

### In Scope

- Create a generic `apply_env_aliases()` function that handles common patterns
- Refactor all four validators to use the generic function
- Support type conversions: `str`, `int`, `bool`, `float`, duration parsing, list parsing
- Reduce total validator code by at least 60%
- Maintain 100% backward compatibility for all environment variables

### Out of Scope

- Changing the environment variable names themselves
- Adding new environment variable support (future stories)
- Modifying how Pydantic settings work

---

## Acceptance Criteria

### AC1: Generic Validator Created

- [ ] New function `_apply_env_aliases()` or similar exists in `settings.py`
- [ ] Function accepts: target model, env prefix, field type mapping
- [ ] Function handles: `str`, `int`, `bool`, `float`, duration, list types
- [ ] Function is well-documented with docstring and examples

### AC2: Existing Validators Refactored

- [ ] `_apply_cloudwatch_env_aliases()` uses generic function
- [ ] `_apply_loki_env_aliases()` uses generic function
- [ ] `_apply_postgres_env_aliases()` uses generic function
- [ ] `_apply_sink_routing_env_aliases()` uses generic function
- [ ] Each validator is reduced to <15 lines (mapping + call)

### AC3: Line Count Reduced

- [ ] Total validator code reduced by at least 60% (from ~220 lines to <90 lines)
- [ ] Overall `settings.py` reduced by at least 130 lines

### AC4: All Env Vars Still Work

- [ ] All existing environment variables function identically
- [ ] Unit tests verify each env var is parsed correctly
- [ ] Integration tests confirm end-to-end behavior

---

## Technical Design / Implementation Notes

### Architecture Decisions

1. **Declarative field mapping:** Each validator declares a mapping of field names to (env_var, type) tuples
2. **Type handler registry:** Central registry of type converters (str, int, bool, duration, etc.)
3. **Single apply function:** One function handles iteration, getenv, conversion, setattr

### Proposed API

```python
# Field type definitions
class EnvFieldType(Enum):
    STRING = "string"
    INT = "int"
    BOOL = "bool"
    FLOAT = "float"
    DURATION = "duration"
    LIST = "list"

# Declarative mapping for a sink
CLOUDWATCH_ENV_FIELDS: dict[str, tuple[str, EnvFieldType]] = {
    "log_group_name": ("FAPILOG_CLOUDWATCH__LOG_GROUP_NAME", EnvFieldType.STRING),
    "log_stream_name": ("FAPILOG_CLOUDWATCH__LOG_STREAM_NAME", EnvFieldType.STRING),
    "region": ("FAPILOG_CLOUDWATCH__REGION", EnvFieldType.STRING),
    "batch_size": ("FAPILOG_CLOUDWATCH__BATCH_SIZE", EnvFieldType.INT),
    "batch_timeout_seconds": ("FAPILOG_CLOUDWATCH__BATCH_TIMEOUT_SECONDS", EnvFieldType.DURATION),
    "create_log_group": ("FAPILOG_CLOUDWATCH__CREATE_LOG_GROUP", EnvFieldType.BOOL),
    # ... etc
}

def _apply_env_aliases(
    target: BaseModel,
    field_map: dict[str, tuple[str, EnvFieldType]],
) -> None:
    """Apply environment variable overrides to a Pydantic model."""
    for field_name, (env_var, field_type) in field_map.items():
        value = os.getenv(env_var)
        if value is None:
            continue
        converted = _convert_env_value(value, field_type)
        if converted is not None:
            setattr(target, field_name, converted)
```

### Implementation Approach

1. Create type converter functions for each `EnvFieldType`
2. Create the generic `_apply_env_aliases()` function
3. Define field mappings for each sink as module-level constants
4. Refactor each `@model_validator` to use the new system
5. Remove old implementation code
6. Add comprehensive tests

### Code Locations

- Primary file to modify:
  - `src/fapilog/core/settings.py` (refactor lines 1003-1228)
- Test files to modify/create:
  - `tests/unit/core/test_settings.py`
  - `tests/unit/core/test_env_aliases.py` (new)

### Dependencies & Constraints

- Must maintain exact backward compatibility for all env vars
- Must not change public Settings API
- Type conversion must match existing behavior exactly

---

## Tasks

### Phase 1: Foundation
- [ ] Create `EnvFieldType` enum or similar type classification
- [ ] Implement type converter functions (`_parse_bool`, `_parse_duration`, `_parse_list`, etc.)
- [ ] Implement generic `_apply_env_aliases()` function
- [ ] Add unit tests for the generic function

### Phase 2: Migration
- [ ] Define `CLOUDWATCH_ENV_FIELDS` mapping
- [ ] Refactor `_apply_cloudwatch_env_aliases()` to use generic function
- [ ] Run CloudWatch-related tests
- [ ] Repeat for Loki, Postgres, SinkRouting validators
- [ ] Remove old implementation code

### Phase 3: Verification
- [ ] Run full test suite
- [ ] Add integration tests for each env var
- [ ] Verify line count reduction
- [ ] Update any documentation

---

## Tests

### Unit Tests

- [ ] Test `_apply_env_aliases()` with string fields
- [ ] Test `_apply_env_aliases()` with int fields
- [ ] Test `_apply_env_aliases()` with bool fields (true/false/1/0/yes/no)
- [ ] Test `_apply_env_aliases()` with duration fields ("5s", "1m", 30.0)
- [ ] Test `_apply_env_aliases()` with list fields (JSON and comma-separated)
- [ ] Test missing env vars are skipped
- [ ] Test invalid values don't crash (graceful fallback)

### Integration Tests

- [ ] Test `FAPILOG_CLOUDWATCH__LOG_GROUP_NAME` sets field correctly
- [ ] Test `FAPILOG_LOKI__URL` sets field correctly
- [ ] Test `FAPILOG_POSTGRES__HOST` sets field correctly
- [ ] Test `FAPILOG_SINK_ROUTING__ENABLED` sets field correctly
- [ ] Test boolean env vars accept "1", "true", "yes", "on" (case-insensitive)

### Regression Tests

- [ ] All existing settings tests pass unchanged
- [ ] Existing env var behavior is identical

---

## Documentation Updates

- [ ] Add docstring to `_apply_env_aliases()` with usage examples
- [ ] Document how to add new env var support for future sinks
- [ ] No CHANGELOG entry (internal refactor)

---

## Definition of Done

### Code Complete
- [ ] All acceptance criteria met and verified
- [ ] All tasks completed
- [ ] Code follows project style guide
- [ ] No linting errors or warnings
- [ ] Type checking passes (mypy strict)

### Quality Assurance
- [ ] Unit tests: >90% coverage of new code
- [ ] Integration tests: all env vars tested
- [ ] Regression tests: no existing functionality broken
- [ ] Line count reduced by >= 60%

### Documentation
- [ ] Docstrings added to new functions
- [ ] Pattern documented for future maintainers

### Review & Release
- [ ] Code review approved
- [ ] CI/CD pipeline passing
- [ ] Ready for merge to main branch

### Backwards Compatibility
- [ ] No breaking changes
- [ ] All env vars work identically
- [ ] All existing tests pass

---

## Risks / Rollback / Monitoring

### Risks

- **Risk 1:** Subtle type conversion differences break existing behavior
  - **Mitigation:** Exhaustive tests for each env var; compare old vs new behavior
- **Risk 2:** Edge cases in duration/list parsing differ
  - **Mitigation:** Extract existing parsing logic; don't rewrite

### Rollback Plan

- Revert the commit
- No data migration; pure code refactor

### Success Metrics

- `settings.py` reduced by >= 130 lines
- Each validator reduced to <15 lines
- All env var tests pass
- No new issues after merge

---

## Related Documents

- [5.0 Series Overview](./5.0-series-overview.md)
- [Human Understandability Audit Report](#) - P0 recommendation #2
- [Story 5.25: Extract Config Builders](./5.25.extract-config-builders-from-init.md)

---

## Change Log

| Date       | Change                 | Author |
| ---------- | ---------------------- | ------ |
| 2026-01-14 | Initial story creation | Claude |
