# Story 11.5: Replace Blocking time.sleep in Async Contexts

**Status:** Draft
**Priority:** Medium
**Depends on:** None

---

## Context / Background

The test suite has 28+ uses of `time.sleep()` in test files. Several are inside test functions that also use async operations (`asyncio.run()`), potentially blocking the event loop:

**Problem pattern:**
```python
async def test_async_operation():
    await start_async_task()
    time.sleep(0.3)  # BLOCKS the entire thread/event loop
    await check_result()
```

When `time.sleep()` is called in an async context, it blocks the thread running the event loop, preventing other coroutines from executing. This can cause:
- Timeouts in concurrent operations
- Deadlocks when waiting for async callbacks
- Slower test execution (no concurrency during sleep)

**Correct pattern:**
```python
async def test_async_operation():
    await start_async_task()
    await asyncio.sleep(0.3)  # Yields to event loop
    await check_result()
```

---

## Scope (In / Out)

### In Scope

- Audit all `time.sleep()` uses in test files
- Replace with `await asyncio.sleep()` in async test functions
- Keep `time.sleep()` in truly synchronous tests (threading tests, etc.)
- Add lint rule to catch future violations

### Out of Scope

- Production code changes
- Refactoring sync tests to async
- Removing sleeps entirely (covered in Stories 11.1, 11.2)

---

## Acceptance Criteria

### AC1: No Blocking Sleep in Async Tests

**Description:** `time.sleep()` is not used inside `async def` test functions.

**Validation:**
```bash
# Find async test functions with time.sleep
# This should return 0 matches after fix
grep -r "async def test_" tests/ -l | \
  xargs grep -l "time.sleep" | \
  xargs grep -B5 "time.sleep" | \
  grep -c "async def"
# Expected: 0
```

### AC2: Sync Tests Keep time.sleep

**Description:** Synchronous tests (threading, subprocess) still use `time.sleep()`.

**Validation:**
```python
# This is correct - threading test, not async
def test_thread_coordination():
    thread.start()
    time.sleep(0.1)  # OK - not in async context
    thread.join()
```

### AC3: Tests Still Pass

**Description:** All affected tests pass after migration.

**Validation:**
```bash
pytest tests/ -m "not slow and not integration"
```

### AC4: Lint Rule Catches Violations

**Description:** A lint rule warns when `time.sleep` is used in async functions.

**Validation:**
```python
# ruff.toml or custom lint script
# Flag: "ASYNC100: time.sleep in async function"
```

---

## Implementation Notes

### Files with time.sleep in Tests

Based on grep results, these files need review:

| File | Uses | Context |
|------|------|---------|
| `test_sink_circuit_breaker.py` | 4 | May be sync tests |
| `test_logger_pipeline.py` | 2 | Check if async |
| `test_public_api_runtime.py` | 3 | Likely async |
| `test_metrics.py` | 2 | Check context |
| `test_logger_errors.py` | 9 | Check context |
| `test_hanging_prevention.py` | 8 | Threading tests - likely OK |
| `test_logger_threading.py` | 1 | Threading test - likely OK |

### Migration Pattern

```python
# Before (blocking)
import time

@pytest.mark.asyncio
async def test_async_operation():
    await sink.write(record)
    time.sleep(0.3)
    assert sink.flushed

# After (non-blocking)
import asyncio

@pytest.mark.asyncio
async def test_async_operation():
    await sink.write(record)
    await asyncio.sleep(0.3)
    assert sink.flushed
```

### When to Keep time.sleep

Keep `time.sleep()` when:
1. Test is synchronous (`def test_...` not `async def test_...`)
2. Test explicitly tests threading behavior
3. Sleep is in a background thread, not the main async context

```python
# OK - sync test for threading
def test_thread_coordination():
    def worker():
        time.sleep(0.1)  # In separate thread
        queue.put(result)

    thread = Thread(target=worker)
    thread.start()
    time.sleep(0.2)  # Main thread, not async
    thread.join()
```

### Lint Rule (ruff)

Ruff has built-in async checks. Enable:

```toml
# pyproject.toml
[tool.ruff.lint]
select = ["ASYNC"]  # Includes ASYNC100, ASYNC101, etc.
```

`ASYNC100` specifically flags blocking calls (`time.sleep`, `open`, etc.) in async functions.

### File Changes

```
tests/unit/test_public_api_runtime.py (MODIFIED - replace time.sleep)
tests/unit/test_logger_pipeline.py (MODIFIED - replace time.sleep if async)
tests/unit/test_logger_errors.py (MODIFIED - replace time.sleep if async)
tests/unit/test_metrics.py (MODIFIED - replace time.sleep if async)
pyproject.toml (MODIFIED - enable ASYNC lint rules)
```

---

## Tasks

### Phase 1: Audit

- [ ] List all `time.sleep()` uses in tests
- [ ] Categorize each as: async context / sync context / thread context
- [ ] Create migration list for async context uses

### Phase 2: Migration

- [ ] Replace `time.sleep` with `await asyncio.sleep` in `test_public_api_runtime.py`
- [ ] Review and fix `test_logger_pipeline.py`
- [ ] Review and fix `test_logger_errors.py`
- [ ] Review and fix `test_metrics.py`
- [ ] Verify each file still passes tests

### Phase 3: Lint Rule

- [ ] Enable `ASYNC` rules in ruff configuration
- [ ] Run ruff to verify no new violations
- [ ] Document rule in test guidelines

### Phase 4: Validation

- [ ] Run full test suite
- [ ] Verify no regression
- [ ] Update CHANGELOG

---

## Tests

### Verification

```bash
# Verify no blocking sleep in async tests
grep -r "async def test_" tests/ -A20 | grep "time.sleep" | wc -l
# Should be 0

# Run all async tests
pytest tests/ -m "asyncio" -v
```

### Regression

```bash
pytest tests/ -m "not slow and not integration"
```

---

## Definition of Done

### Code Complete

- [ ] All `time.sleep()` in async contexts replaced with `await asyncio.sleep()`
- [ ] Sync/threading tests unchanged
- [ ] Lint rule enabled to catch future violations

### Quality Assurance

- [ ] All affected tests pass
- [ ] `ruff check` passes (including ASYNC rules)
- [ ] No regression in test suite

### Documentation

- [ ] Test guidelines updated
- [ ] CHANGELOG updated

---

## Risks / Rollback

### Risks

1. **Risk:** Changing sleep type affects test behavior
   - **Mitigation:** Run tests before and after, compare results

2. **Risk:** Some tests rely on blocking behavior
   - **Mitigation:** Review each change carefully, keep sync if needed

### Rollback Plan

If issues occur:
1. Revert individual file changes
2. Keep original `time.sleep()` with comment explaining why
3. Disable ASYNC lint rule for specific lines if needed

---

## Related Stories

- **Related:** Story 11.1 - hard sleeps should be events, not async sleep
- **Related:** Story 11.2 - flaky tests may have blocking sleep issues
- **Complements:** Story 11.4 - timeout multipliers apply to asyncio.sleep too

---

## Change Log

| Date | Change | Author |
|------|--------|--------|
| 2026-01-14 | Initial draft | Claude |
