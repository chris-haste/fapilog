# Story 12.20: Optional Drop/Dedupe Visibility in Normal Logs

**Status:** Ready
**Priority:** Low
**Depends on:** None

---

## Context / Background

An external audit (GPT-5.2 assessment, 2026-01-27) identified:

> "Make drop/dedupe behavior visible in normal logs optionally (e.g., emit summary events) to reduce reliance on diagnostics."
> Evidence: dedupe suppresses errors silently (except optional diagnostics) (/src/fapilog/core/logger.py).

Currently, when events are dropped (backpressure) or deduplicated (error dedupe), the information is only available via:
- Diagnostics system (stderr, requires opt-in)
- Metrics (requires metrics enablement)

Users who don't enable diagnostics or metrics may not realize events are being dropped. An optional feature to emit summary events in the normal log stream would improve visibility without requiring additional observability setup.

---

## Scope (In / Out)

### In Scope

- Add optional `emit_drop_summary` setting
- Emit periodic summary log events for drops/dedupe
- Document the feature

### Out of Scope

- Changing default behavior
- Real-time per-event drop notifications (too noisy)
- Metrics changes

---

## Acceptance Criteria

### AC1: Configuration option exists

**Description:** A setting controls whether drop/dedupe summaries are emitted.

**Validation:**
```python
from fapilog import Settings

settings = Settings(core={"emit_drop_summary": True})
assert settings.core.emit_drop_summary is True
```

### AC2: Drop summary emitted

**Description:** When drops occur and `emit_drop_summary=True`, a summary event is logged.

**Validation:**
```python
# After events are dropped due to backpressure
# A log event like this should appear:
{
    "level": "WARNING",
    "message": "Events dropped due to backpressure",
    "dropped_count": 42,
    "window_seconds": 60,
    "_fapilog_internal": True,
}
```

### AC3: Dedupe summary emitted

**Description:** When error dedupe suppresses messages and `emit_drop_summary=True`, a summary is logged.

**Validation:**
```python
# After dedupe window expires
# A log event like this should appear:
{
    "level": "INFO",
    "message": "Duplicate errors suppressed",
    "error_message": "Connection refused",
    "suppressed_count": 15,
    "_fapilog_internal": True,
}
```

### AC4: Default is disabled

**Description:** The feature is off by default to preserve current behavior.

**Validation:**
```python
from fapilog import Settings

settings = Settings()
assert settings.core.emit_drop_summary is False
```

### AC5: Summary is rate-limited

**Description:** Summaries are not emitted on every drop; they aggregate over a window.

**Validation:**
```python
# Dropping 1000 events should produce ~1 summary, not 1000
# Window should be configurable (default 60s)
```

### AC6: Documented

**Description:** Feature is documented in user guide.

**Validation:**
```bash
grep -i "emit_drop_summary\|drop.*summary" docs/user-guide/configuration.md
```

---

## Implementation Notes

### Settings Addition

```python
# core/settings.py
class CoreSettings(BaseModel):
    # ... existing fields ...

    # Drop/dedupe visibility
    emit_drop_summary: bool = Field(
        default=False,
        description="Emit summary log events when events are dropped or deduplicated",
    )
    drop_summary_window_seconds: float = Field(
        default=60.0,
        ge=1.0,
        description="Window for aggregating drop/dedupe summaries",
    )
```

### Worker Integration

```python
# core/worker.py

class LoggerWorker:
    def __init__(self, ...):
        # ... existing init ...
        self._drop_count: int = 0
        self._last_drop_summary: float = 0.0

    async def _record_drop(self, count: int = 1) -> None:
        """Record dropped events, emit summary if configured."""
        self._drop_count += count

        if not self._emit_drop_summary:
            return

        now = time.monotonic()
        if now - self._last_drop_summary >= self._drop_summary_window:
            if self._drop_count > 0:
                await self._emit_summary_event(
                    level="WARNING",
                    message="Events dropped due to backpressure",
                    dropped_count=self._drop_count,
                    window_seconds=self._drop_summary_window,
                )
                self._drop_count = 0
                self._last_drop_summary = now
```

### Dedupe Integration

```python
# core/logger.py (in dedupe logic)

# After window expires and count > 0:
if self._emit_drop_summary and count > 0:
    # Emit via diagnostics path that bypasses dedupe
    self._emit_internal_event(
        level="INFO",
        message="Duplicate errors suppressed",
        error_message=message[:100],  # Truncate
        suppressed_count=count,
    )
```

### Internal Event Marker

Internal summary events should be marked to:
1. Bypass dedupe (prevent infinite loop)
2. Be identifiable in logs

```python
event = {
    "level": "WARNING",
    "message": "Events dropped due to backpressure",
    "dropped_count": 42,
    "_fapilog_internal": True,  # Marker for internal events
}
```

---

## Tasks

- [ ] Add `emit_drop_summary` to CoreSettings
- [ ] Add `drop_summary_window_seconds` to CoreSettings
- [ ] Implement drop counting in worker
- [ ] Implement periodic drop summary emission
- [ ] Update dedupe logic to emit summaries
- [ ] Add `_fapilog_internal` marker
- [ ] Add tests
- [ ] Document in configuration guide

---

## Tests

### Unit Tests

```python
# tests/unit/test_drop_summary.py

@pytest.mark.asyncio
async def test_drop_summary_disabled_by_default():
    """Default settings should not emit drop summaries."""
    settings = Settings()
    assert settings.core.emit_drop_summary is False

@pytest.mark.asyncio
async def test_drop_summary_emitted_when_enabled():
    """With emit_drop_summary=True, summaries should appear in logs."""
    memory_sink = MemorySink()
    settings = Settings(core={"emit_drop_summary": True, "max_queue_size": 1})
    logger = get_logger(settings=settings, sinks=[memory_sink])

    # Overflow the queue to trigger drops
    for _ in range(100):
        logger.info("Test")

    await asyncio.sleep(0.1)  # Allow summary to emit

    # Check for summary event
    summaries = [e for e in memory_sink.events if e.get("_fapilog_internal")]
    assert len(summaries) >= 1
    assert "dropped" in summaries[0]["message"].lower()

@pytest.mark.asyncio
async def test_dedupe_summary_emitted():
    """Dedupe summaries should be emitted when enabled."""
    memory_sink = MemorySink()
    settings = Settings(core={
        "emit_drop_summary": True,
        "error_dedupe_window_seconds": 0.1,
    })
    logger = get_logger(settings=settings, sinks=[memory_sink])

    # Trigger dedupe
    for _ in range(10):
        logger.error("Same error message")

    await asyncio.sleep(0.2)  # Wait for window to expire

    # Trigger summary by logging again
    logger.error("Same error message")
    await logger.drain()

    # Check for summary
    summaries = [e for e in memory_sink.events if "suppressed" in e.get("message", "").lower()]
    assert len(summaries) >= 1
```

---

## Definition of Done

### Code Complete

- [ ] Settings added
- [ ] Drop summary implemented
- [ ] Dedupe summary implemented
- [ ] Internal marker added

### Quality Assurance

- [ ] Unit tests passing
- [ ] No regression in existing tests
- [ ] Manual testing completed

### Documentation

- [ ] Configuration docs updated
- [ ] CHANGELOG updated

---

## Risks / Rollback

### Risks

1. **Risk:** Summary events could themselves be dropped under extreme load
   - **Mitigation:** Use a separate high-priority path for internal events

2. **Risk:** Summary spam if window is too short
   - **Mitigation:** Minimum window of 1 second, default 60 seconds

3. **Risk:** Internal marker could confuse log aggregators
   - **Mitigation:** Document the marker; it's opt-in anyway

### Rollback

Feature is opt-in; disable by setting `emit_drop_summary=False`.

---

## Related Stories

- **Origin:** GPT-5.2 External Audit (2026-01-27)
- **Related:** Story 10.32 - Production safety defaults

---

## Change Log

| Date | Change | Author |
|------|--------|--------|
| 2026-01-27 | Initial draft from audit findings | Claude |
