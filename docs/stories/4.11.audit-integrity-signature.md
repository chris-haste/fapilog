# Story 4.11: Audit Integrity (HMAC/Signature)

## Status
Draft

## Story
**As a** compliance auditor,
**I want** optional HMAC/signature support for audit logs in core,
**so that** I can verify tamper-evidence without heavy dependencies; advanced key management lives in enterprise extras.

## Acceptance Criteria
1. Config-driven integrity: enable/disable and select mode (`none`, `hmac-sha256`).
2. When enabled, `AuditTrail` computes and stores a `checksum` per event; verification utility provided for offline checks.
3. Key sources: env var or file path in core; KMS/Sigstore deferred to extras.
4. No-op when disabled; existing performance characteristics preserved.
5. Unit tests: checksum present and verifiable; incorrect key fails verification; disabled mode writes no checksum.

## Tasks / Subtasks
- [ ] Add integrity settings to `CompliancePolicy` or a new integrity config
- [ ] Implement HMAC-SHA256 signing utility (pure stdlib `hmac`, `hashlib`)
- [ ] Integrate into `AuditTrail` before persistence
- [ ] Provide `verify_event(event, key)` helper
- [ ] Documentation updates: security.md, epic 4
- [ ] Unit tests for sign/verify paths

## Dev Notes
- Relevant Source Tree
  - `src/fapilog/core/audit.py`: `AuditTrail`, `AuditEvent.checksum`
  - `src/fapilog/core/compliance.py`: policy/config validation
- Patterns & Constraints
  - Keep optional and inexpensive; avoid blocking
  - Keys loaded once and kept in-memory; avoid logging keys
  - Consider including stable fields (event_id, timestamp, event_type, message) in canonical string for HMAC

## Testing
- Golden test: known event â†’ expected HMAC with test key
- Round-trip: sign then verify passes; wrong key fails
- Disabled: checksum None

## Change Log
| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| 2025-08-11 | 0.1 | Draft story created | QA Agent |


