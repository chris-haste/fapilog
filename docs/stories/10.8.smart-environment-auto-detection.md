# Story 10.8: Smart Environment Auto-Detection

## Status: Planned

## Priority: High

## Estimated Effort: Medium (2-3 days)

## Dependencies

- **Depends on:** Story 10.1 (Configuration Presets) - Uses preset system
- **Depends on:** Story 10.6 (Enhanced Default Behaviors) - Builds on default selection

## Epic / Series

Part of Epic 10: Developer Experience and Ergonomics / Series 10.x

---

## Context / Background

Default behavior should adapt to deployment context. Auto-detection can configure the logger for local, Docker, Kubernetes, Lambda, and CI environments without manual setup.

## Scope (In / Out)

### In Scope

- Detect environment (local, Docker, Kubernetes, AWS Lambda, CI).
- Apply environment-specific configuration profiles.
- Allow opt-out and explicit overrides.

### Out of Scope

- Deep platform integrations beyond metadata enrichment.
- External service calls during detection.

## Acceptance Criteria

1. `detect_environment()` identifies local, Docker, Kubernetes, Lambda, and CI contexts.
2. Auto-detected configuration applies level, format, and enrichers per environment.
3. `get_logger(auto_detect=False)` disables auto-detection.
4. `get_logger(environment="production")` overrides detection.
5. Kubernetes and Docker metadata are added when available.
6. Lambda configuration optimizes batching and flush behavior.
7. Tests mock each environment and validate resulting settings.

## Implementation Notes

- Implement detection in `src/fapilog/core/environment.py` or similar.
- Reuse presets and defaults from Stories 10.1 and 10.6 to avoid duplication.
- Assumption: explicit Settings or overrides always win over auto-detected values.

## Tasks

- [ ] Implement `detect_environment()` with filesystem and env var checks.
- [ ] Add `environment` and `auto_detect` parameters to `get_logger` and `get_async_logger`.
- [ ] Map detected environments to preset/defaults.
- [ ] Add metadata enrichers for Docker, Kubernetes, Lambda, and CI.
- [ ] Update docs with auto-detection examples and override controls.
- [ ] Add tests in `tests/unit/test_logger_setup.py` and new tests for environment detection.

## Tests

- Unit: detection for local, Docker, Kubernetes, Lambda, and CI.
- Unit: auto-detection can be disabled.
- Integration: detected environment applies correct format and level.
- Unit: metadata enrichment attaches expected fields.

## Definition of Done

Story is complete when ALL of the following are true:

### Code Complete
- [ ] All acceptance criteria met and verified
- [ ] All tasks completed
- [ ] Code follows project style guide
- [ ] No linting errors or warnings
- [ ] Type checking passes (mypy strict)

### Quality Assurance
- [ ] Unit tests: >90% coverage of new code
- [ ] Integration tests: all scenarios passing
- [ ] Regression tests: no existing functionality broken
- [ ] Performance tests: no regression vs baseline
- [ ] Manual testing completed (if applicable)

### Documentation
- [ ] User-facing docs updated
- [ ] API reference updated (if applicable)
- [ ] Code examples added/updated
- [ ] CHANGELOG.md updated
- [ ] Inline code documentation complete

### Review & Release
- [ ] Code review approved
- [ ] Documentation reviewed for clarity
- [ ] CI/CD pipeline passing
- [ ] Ready for merge to main branch

### Backwards Compatibility
- [ ] No breaking changes OR breaking changes documented with migration guide
- [ ] Existing tests still pass
- [ ] Deprecation warnings added (if applicable)

---

## Risks / Rollback / Monitoring

### Risks

- **Risk:** False positives causing unexpected output changes
  - **Mitigation:** Conservative detection, allow opt-out, clear documentation

- **Risk:** Environment detection is slow
  - **Mitigation:** Cache detection results, optimize checks

### Rollback Plan

- Gate auto-detection behind a flag
- Keep default off if needed
- Explicit settings always override

### Success Metrics / Monitoring

- Log detection decisions in debug mode for visibility
- Monitor false positive rate
- User feedback on detection accuracy

---

## Related Documents

- [Story 10.0: Series Overview](./10.0-series-overview.md)
- [Story 10.1: Configuration Presets](./10.1.configuration-presets.md)
- [Story 10.6: Enhanced Default Behaviors](./10.6.enhanced-default-behaviors.md)
- [Epic 10: Developer Experience](../prd/epic-10-DX-Experience.md)

---

## Change Log

| Date       | Change                    | Author |
| ---------- | ------------------------- | ------ |
| 2025-01-10 | Migrated to new format    | System |
