name: CI

on:
  push:
    branches: [main, "feature/**"]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  detect-docs-only:
    name: Detect Documentation-Only Changes
    runs-on: ubuntu-latest
    outputs:
      docs-only: ${{ steps.check.outputs.docs-only }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if PR is documentation-only
        id: check
        run: |
          if [ "${{ github.event_name }}" != "pull_request" ]; then
            echo "docs-only=false" >> $GITHUB_OUTPUT
            echo "Not a pull request, running all checks"
            exit 0
          fi
          
          # Get the list of changed files
          git diff --name-only origin/${{ github.base_ref }}...HEAD > changed_files.txt
          
          # Define documentation file patterns
          # Documentation files include:
          # - Any .md files (but NOT .rst files - we guard against those)
          # - Files in docs/ directory
          # - Root level docs: README*, CHANGELOG*, CONTRIBUTING*, LICENSE*
          # - Documentation in .github/ and .claude/ directories
          # - api-reference/ directory (if it exists at root)
          # Exclude: .py, .yml (workflow files), .toml, .json, .rst, etc.
          
          # Check if any non-documentation files changed
          # Note: .rst files are intentionally excluded - we guard against them being committed
          non_docs_changed=$(grep -v -E '\.md$|^docs/|^(README|CHANGELOG|CONTRIBUTING|LICENSE)(\.|$)|^\.github/.*\.md$|^\.claude/.*\.md$|^api-reference/.*\.md$' changed_files.txt || true)
          
          if [ -z "$non_docs_changed" ]; then
            echo "docs-only=true" >> $GITHUB_OUTPUT
            echo "âœ… PR contains only documentation changes"
          else
            echo "docs-only=false" >> $GITHUB_OUTPUT
            echo "ðŸ“ PR contains code changes:"
            echo "$non_docs_changed"
          fi

  lint:
    name: Build & Lint
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' || needs.detect-docs-only.outputs.docs-only != 'true'
    needs: [detect-docs-only]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Hatch
        run: |
          python -m pip install --upgrade pip
          pip install hatch

      - name: Run lint
        run: hatch run lint:lint

  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' || needs.detect-docs-only.outputs.docs-only != 'true'
    needs: [detect-docs-only]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Hatch
        run: |
          python -m pip install --upgrade pip
          pip install hatch

      - name: Run type check
        run: hatch run typecheck:typecheck

  test:
    name: Test & Coverage
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' || needs.detect-docs-only.outputs.docs-only != 'true'
    needs: [detect-docs-only]
    strategy:
      matrix:
        python-version: ["3.11"]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Hatch
        run: |
          python -m pip install --upgrade pip
          pip install hatch

      - name: Run quick tests with coverage (PR)
        if: github.event_name == 'pull_request'
        run: >
          hatch run test:test-cov --
          -m "((critical or security) and not flaky) or (not slow and not integration and not flaky)"

      - name: Run flaky tests (PR)
        if: github.event_name == 'pull_request'
        run: hatch run test:test -- -m flaky
        continue-on-error: true

      - name: Run full tests with coverage
        if: github.event_name != 'pull_request'
        run: hatch run test:test-cov

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Fetch base branch for diff coverage
        if: github.event_name == 'pull_request'
        run: git fetch origin ${{ github.base_ref }} --depth=1

      - name: Diff coverage (changed lines)
        if: github.event_name == 'pull_request'
        run: |
          python -m pip install diff-cover
          diff-cover coverage.xml --compare-branch=origin/${{ github.base_ref }} --fail-under=85

  tox:
    name: Tox (Compatibility)
    runs-on: ubuntu-latest
    needs: [detect-docs-only]
    strategy:
      matrix:
        python-version: ["3.11"]
    steps:
      - uses: actions/checkout@v4

      - name: Skip tox for docs-only PRs
        if: github.event_name == 'pull_request' && needs.detect-docs-only.outputs.docs-only == 'true'
        run: |
          echo "âœ… Skipping tox for documentation-only PR"
          echo "This PR only contains documentation changes, so compatibility tests are not needed."

      - name: Set up Python ${{ matrix.python-version }}
        if: github.event_name != 'pull_request' || needs.detect-docs-only.outputs.docs-only != 'true'
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Tox
        if: github.event_name != 'pull_request' || needs.detect-docs-only.outputs.docs-only != 'true'
        run: |
          python -m pip install --upgrade pip
          pip install tox

      - name: Run tox
        if: github.event_name != 'pull_request' || needs.detect-docs-only.outputs.docs-only != 'true'
        run: tox -q
