name: CI

on:
  push:
    branches: [main, "feature/**"]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  detect-docs-only:
    name: Detect Documentation-Only Changes
    runs-on: ubuntu-latest
    outputs:
      docs-only: ${{ steps.check.outputs.docs-only }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if PR is documentation-only
        id: check
        run: |
          if [ "${{ github.event_name }}" != "pull_request" ]; then
            echo "docs-only=false" >> $GITHUB_OUTPUT
            echo "Not a pull request, running all checks"
            exit 0
          fi
          
          # Get the list of changed files
          git diff --name-only origin/${{ github.base_ref }}...HEAD > changed_files.txt
          
          # Define documentation file patterns
          # Documentation files include:
          # - Any .md files (but NOT .rst files - we guard against those)
          # - Files in docs/ directory
          # - Root level docs: README*, CHANGELOG*, CONTRIBUTING*, LICENSE*
          # - Documentation in .github/ and .claude/ directories
          # - api-reference/ directory (if it exists at root)
          # Exclude: .py, .yml (workflow files), .toml, .json, .rst, etc.
          
          # Check if any non-documentation files changed
          # Note: .rst files are intentionally excluded - we guard against them being committed
          non_docs_changed=$(grep -v -E '\.md$|^docs/|^(README|CHANGELOG|CONTRIBUTING|LICENSE)(\.|$)|^\.github/.*\.md$|^\.claude/.*\.md$|^api-reference/.*\.md$' changed_files.txt || true)
          
          if [ -z "$non_docs_changed" ]; then
            echo "docs-only=true" >> $GITHUB_OUTPUT
            echo "âœ… PR contains only documentation changes"
          else
            echo "docs-only=false" >> $GITHUB_OUTPUT
            echo "ðŸ“ PR contains code changes:"
            echo "$non_docs_changed"
          fi

  lint:
    name: Build & Lint
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' || needs.detect-docs-only.outputs.docs-only != 'true'
    needs: [detect-docs-only]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Hatch
        run: |
          python -m pip install --upgrade pip
          pip install hatch

      - name: Run lint
        run: hatch run lint:lint

  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' || needs.detect-docs-only.outputs.docs-only != 'true'
    needs: [detect-docs-only]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Hatch
        run: |
          python -m pip install --upgrade pip
          pip install hatch

      - name: Run type check
        run: hatch run typecheck:typecheck

  contract-tests:
    name: Contract Tests (Schema Compatibility)
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' || needs.detect-docs-only.outputs.docs-only != 'true'
    needs: [detect-docs-only]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Hatch
        run: |
          python -m pip install --upgrade pip
          pip install hatch

      - name: Run contract tests
        run: |
          echo "ðŸ”— Running contract tests to verify schema compatibility..."
          echo "These tests catch schema drift between build_envelope() and serialize_envelope()."
          hatch run test:test -- tests/contract/ -v --tb=short
        env:
          CI_TIMEOUT_MULTIPLIER: "3"

  test:
    name: Test & Coverage
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' || needs.detect-docs-only.outputs.docs-only != 'true'
    needs: [detect-docs-only]
    strategy:
      matrix:
        python-version: ["3.11"]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Hatch
        run: |
          python -m pip install --upgrade pip
          pip install hatch

      - name: Run quick tests with coverage (PR)
        if: github.event_name == 'pull_request'
        env:
          CI_TIMEOUT_MULTIPLIER: "3"
        run: >
          hatch run test:test-cov --
          -m "((critical or security) and not flaky) or (not slow and not stress and not integration and not flaky)"

      - name: Run flaky tests (PR)
        if: github.event_name == 'pull_request'
        env:
          CI_TIMEOUT_MULTIPLIER: "3"
        run: hatch run test:test -- -m flaky
        continue-on-error: true

      - name: Run full tests with coverage
        if: github.event_name != 'pull_request'
        env:
          CI_TIMEOUT_MULTIPLIER: "3"
        run: hatch run test:test-cov

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Fetch base branch for diff coverage
        if: github.event_name == 'pull_request'
        run: git fetch origin ${{ github.base_ref }} --depth=1

      - name: Diff coverage (changed lines)
        if: github.event_name == 'pull_request'
        run: |
          python -m pip install diff-cover
          diff-cover coverage.xml --compare-branch=origin/${{ github.base_ref }} --fail-under=90

  benchmark-smoke:
    name: Benchmark Smoke Test
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' || needs.detect-docs-only.outputs.docs-only != 'true'
    needs: [detect-docs-only]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Hatch
        run: |
          python -m pip install --upgrade pip
          pip install hatch

      - name: Run benchmark smoke test
        run: hatch run python scripts/benchmarking.py --iterations 100 --latency-iterations 50

  validate-package-constraints:
    name: Validate Package Constraints
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install hatch packaging

      - name: Validate fapilog-audit constraints
        run: |
          # Get core version from hatch (extracts base version without dev suffix)
          FULL_VERSION=$(hatch version)
          CORE_VERSION=$(echo "$FULL_VERSION" | grep -oE '^[0-9]+\.[0-9]+\.[0-9]+')

          # Get minimum version from fapilog-audit pyproject.toml
          AUDIT_MIN=$(grep 'fapilog>=' packages/fapilog-audit/pyproject.toml | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')

          echo "Core version: $CORE_VERSION"
          echo "Audit minimum: $AUDIT_MIN"

          python -c "
          from packaging.version import Version
          core = '$CORE_VERSION'
          audit_min = '$AUDIT_MIN'
          assert Version(core) >= Version(audit_min), f'Core {core} < audit min {audit_min}'
          print('Validation passed')
          "

  docs:
    name: Documentation Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r docs/requirements.txt
          pip install -e ".[docs]"

      - name: Validate doc accuracy
        run: python scripts/check_doc_accuracy.py

      - name: Build docs (fail on warnings)
        run: sphinx-build -W -b html docs/ docs/_build/html

  validate-examples:
    name: Validate Examples
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[fastapi]"
          pip install uvicorn httpx

      - name: Validate FastAPI production example
        run: |
          cd examples/fastapi_production
          # Start server in background and test endpoints
          python -c "
          import subprocess
          import time
          import httpx

          # Start server
          proc = subprocess.Popen(
              ['python', '-m', 'uvicorn', 'main:app', '--host', '127.0.0.1', '--port', '8765'],
              stdout=subprocess.PIPE,
              stderr=subprocess.PIPE,
          )
          time.sleep(5)  # Wait for startup

          try:
              client = httpx.Client(base_url='http://127.0.0.1:8765', timeout=10.0)

              # Health check - should be healthy with lifespan
              r = client.get('/health')
              assert r.status_code == 200, f'Health check failed: {r.status_code} {r.text}'
              print('Health check: OK')

              # Root endpoint
              r = client.get('/')
              assert r.status_code == 200, f'Root failed: {r.status_code} {r.text}'
              assert 'request_id' in r.json(), 'Missing request_id in response'
              print('Root endpoint: OK')

              # Metrics endpoint
              r = client.get('/metrics')
              assert r.status_code == 200, f'Metrics failed: {r.status_code} {r.text}'
              print('Metrics endpoint: OK')

              print('All endpoints validated successfully')
          finally:
              proc.terminate()
              proc.wait(timeout=5)
          "
