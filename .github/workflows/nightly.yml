name: Nightly

on:
  schedule:
    # Run at 2am UTC every day
    - cron: "0 2 * * *"
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read
  issues: write

jobs:
  full-test-suite:
    name: Full Test Suite & Coverage
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Hatch
        run: |
          python -m pip install --upgrade pip
          pip install hatch

      - name: Run full test suite with coverage
        env:
          CI_TIMEOUT_MULTIPLIER: "3"
        run: hatch run test:test-cov

      - name: Check coverage threshold (90%)
        run: |
          python -m pip install coverage
          coverage report --fail-under=90

      - name: Upload coverage to Codecov
        if: matrix.python-version == '3.11'
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: nightly
          name: nightly-coverage
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [full-test-suite]
    if: failure()
    steps:
      - name: Create issue on failure
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Nightly build failed on ${new Date().toISOString().split('T')[0]}`;
            const body = `The nightly build failed. Please investigate.\n\nWorkflow run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'nightly-failure'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['nightly-failure', 'bug']
              });
            }
