name: Deploy Docs (standalone)

on:
  # Manual trigger from GitHub UI
  workflow_dispatch:
    inputs:
      version_label:
        description: 'Version label for docs (e.g., "latest" or "0.3.4")'
        required: false
        default: 'latest'

  # Auto-trigger on docs changes to main
  push:
    branches:
      - main
    paths:
      - 'docs/**'
      - 'src/fapilog/**'  # API changes may affect autodoc

permissions:
  contents: write

env:
  PYTHON_VERSION: "3.11"

jobs:
  build-and-deploy:
    name: Build & Deploy Docs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install hatch
        run: |
          python -m pip install --upgrade pip
          pip install hatch

      - name: Determine version label
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "label=${{ github.event.inputs.version_label }}" >> $GITHUB_OUTPUT
          else
            # For push events, use 'latest'
            echo "label=latest" >> $GITHUB_OUTPUT
          fi

      - name: Build docs
        env:
          FAPILOG_DOC_VERSION: ${{ steps.version.outputs.label }}
          # Set canonical URL for GH Pages builds to point to RTD stable docs
          # This triggers canonical tag injection and robots.txt deployment
          GHPAGES_CANONICAL_URL: "https://docs.fapilog.dev/en/stable/"
        run: |
          hatch run docs:build || {
            echo "Docs build failed"; exit 1;
          }

      - name: Verify GH Pages SEO configuration
        run: |
          echo "Verifying canonical tags in HTML files..."
          if ! grep -r 'rel="canonical"' docs/_build/html/*.html > /dev/null 2>&1; then
            echo "ERROR: No canonical tags found in HTML files"
            exit 1
          fi
          echo "Canonical tags found in HTML files"

          echo "Verifying robots.txt exists..."
          if [ ! -f docs/_build/html/robots.txt ]; then
            echo "ERROR: robots.txt not found in build output"
            exit 1
          fi
          echo "robots.txt found at docs/_build/html/robots.txt"

          echo "Verifying noindex meta tags..."
          if ! grep -r 'name="robots" content="noindex' docs/_build/html/*.html > /dev/null 2>&1; then
            echo "ERROR: No noindex meta tags found in HTML files"
            exit 1
          fi
          echo "noindex meta tags found in HTML files"

          echo "GH Pages SEO configuration verified successfully"

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs/_build/html
          force_orphan: false
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: "docs: update (${{ steps.version.outputs.label }})"

