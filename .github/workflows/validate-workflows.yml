name: Validate Workflows

permissions:
  contents: read

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  validate:
    name: Validate Workflow Syntax
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
    
    - name: Install dependencies
      run: |
        pip install PyYAML
    
    - name: Validate workflow syntax
      run: |
        echo "üîç Validating workflow files..."
        for file in .github/workflows/*.yml; do
          echo "Checking $file..."
          python -c "
        import yaml
        import sys
        try:
            with open('$file', 'r') as f:
                yaml.safe_load(f)
            print('‚úÖ $file is valid')
        except Exception as e:
            print(f'‚ùå $file has syntax errors: {e}')
            sys.exit(1)
        "
        done
        echo "‚úÖ All workflow files are valid!"
    
    - name: Check for potential secrets
      run: |
        echo "üîç Checking for potential secrets in workflows..."
        python - <<'PY'
        import pathlib
        import re

        repo_path = pathlib.Path(".github/workflows")
        assignment = re.compile(r"^\s*(password|secret|key|token)\s*[:=]\s*(.+)$", re.I)
        hits = []

        for workflow in repo_path.glob("*.yml"):
            for lineno, line in enumerate(workflow.read_text().splitlines(), start=1):
                match = assignment.search(line)
                if not match:
                    continue

                value = match.group(2).strip()
                if not value or "secrets." in value:
                    continue

                hits.append(f"{workflow}:{lineno}:{line.strip()}")

        if hits:
            print("‚ö†Ô∏è  Potential secrets found:")
            print("\n".join(hits))
            raise SystemExit(1)
        else:
            print("‚úÖ No potential secrets found in workflow files")
        PY
    
    - name: Validate required jobs exist
      run: |
        echo "üîç Checking for required CI jobs..."
        required_jobs=("lint" "test" "typecheck")
        
        for job in "${required_jobs[@]}"; do
          if grep -q "^  $job:" .github/workflows/ci.yml; then
            echo "‚úÖ Found job: $job"
          else
            echo "‚ùå Missing required job: $job"
            exit 1
          fi
        done
        echo "‚úÖ All required CI jobs are present!" 
