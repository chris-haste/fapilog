


<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Adaptive Sampling for High-Volume Services &mdash; fapilog latest documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=c6e86fd7"></script>
      <script src="../_static/doctools.js?v=fd6eb6e6"></script>
      <script src="../_static/sphinx_highlight.js?v=6ffebe34"></script>
      <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../_static/copybutton.js?v=30646c52"></script>
      <script src="../_static/custom.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Graceful shutdown &amp; flushing logs (don’t lose logs on deploy)" href="graceful-shutdown-flush.html" />
    <link rel="prev" title="Log sampling and rate limiting for FastAPI" href="log-sampling-rate-limiting.html" />
 


<link rel="canonical" href="https://docs.fapilog.dev/en/stable/cookbook/adaptive-sampling-high-volume.html" />
<meta name="robots" content="noindex, follow" />


</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #2980B9" >

          
          
          <a href="../index.html" class="icon icon-home">
            fapilog
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../getting-started/index.html">Getting Started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/installation.html">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/quickstart.html">Quickstart Tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/hello-world.html">Hello World Walkthrough</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../why-fapilog.html">Why fapilog?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../features.html">Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../comparisons.html">Python Logging Library Comparison</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-concepts/index.html">Core Concepts</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../core-concepts/pipeline-architecture.html">Pipeline Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../core-concepts/envelope.html">Envelope</a></li>
<li class="toctree-l2"><a class="reference internal" href="../core-concepts/context-binding.html">Context Binding</a></li>
<li class="toctree-l2"><a class="reference internal" href="../core-concepts/batching-backpressure.html">Batching &amp; Backpressure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../core-concepts/sinks.html">Sinks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../core-concepts/metrics.html">Metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../core-concepts/diagnostics-resilience.html">Diagnostics Resilience</a></li>
<li class="toctree-l2"><a class="reference internal" href="../core-concepts/diagnostics-resilience.html#id1">Diagnostics &amp; Resilience</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../user-guide/index.html">User Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../user-guide/configuration.html">Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user-guide/presets.html">Configuration Presets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user-guide/execution-modes.html">Execution Modes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user-guide/builder-configuration.html">Configuring Fapilog with the Builder API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user-guide/environment-variables.html">Environment Variable Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user-guide/production-checklist.html">Production Checklist</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user-guide/using-logger.html">Using the Logger</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user-guide/context-enrichment.html">Context Enrichment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user-guide/rotating-file-sink.html">Rotating File Sink</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user-guide/sink-routing.html">Sink routing by level</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user-guide/circuit-breaker.html">Circuit Breaker</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user-guide/adaptive-pipeline.html">Adaptive Pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user-guide/sampling.html">Sampling Strategies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user-guide/graceful-shutdown.html">Graceful Shutdown</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user-guide/performance-tuning.html">Performance Tuning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user-guide/benchmarks.html">Performance Benchmarks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user-guide/integration-guide.html">Integration Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user-guide/stdlib-bridge.html">stdlib Logging Bridge</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user-guide/fastapi.html">FastAPI / ASGI Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user-guide/reliability-defaults.html">Reliability Defaults and Guardrails</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user-guide/testing-plugins.html">Testing Plugins</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user-guide/webhook-security.html">Webhook Security</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Cookbook</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="fastapi-microservice-production.html">FastAPI Microservices in Production</a></li>
<li class="toctree-l2"><a class="reference internal" href="fastapi-json-logging.html">FastAPI JSON logging to stdout (Uvicorn access logs included)</a></li>
<li class="toctree-l2"><a class="reference internal" href="fastapi-request-id-logging.html">FastAPI request_id logging (correlation ID middleware, concurrency-safe)</a></li>
<li class="toctree-l2"><a class="reference internal" href="django-structured-logging.html">Django Structured JSON Logging with Correlation IDs</a></li>
<li class="toctree-l2"><a class="reference internal" href="non-blocking-async-logging.html">Non-blocking logging in FastAPI (protect latency under slow sinks)</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev-prod-logging-config.html">One FastAPI logging config for dev + prod (Uvicorn/Gunicorn)</a></li>
<li class="toctree-l2"><a class="reference internal" href="redacting-secrets-pii.html">Redacting secrets and PII in FastAPI logs (Authorization, tokens, fields)</a></li>
<li class="toctree-l2"><a class="reference internal" href="compliance-redaction.html">Compliance Redaction: What Works and What Doesn’t</a></li>
<li class="toctree-l2"><a class="reference internal" href="safe-request-response-logging.html">Logging request/response bodies without hanging (safe patterns)</a></li>
<li class="toctree-l2"><a class="reference internal" href="skip-noisy-endpoints.html">Skipping health/metrics endpoints (noise reduction)</a></li>
<li class="toctree-l2"><a class="reference internal" href="log-sampling-rate-limiting.html">Log sampling and rate limiting for FastAPI</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Adaptive Sampling for High-Volume Services</a></li>
<li class="toctree-l2"><a class="reference internal" href="graceful-shutdown-flush.html">Graceful shutdown &amp; flushing logs (don’t lose logs on deploy)</a></li>
<li class="toctree-l2"><a class="reference internal" href="exception-logging-request-context.html">Exception logging in FastAPI with request_id + structured context</a></li>
<li class="toctree-l2"><a class="reference internal" href="custom-log-levels.html">Custom log levels in Python (TRACE, VERBOSE, NOTICE)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../examples/index.html">Examples &amp; Recipes</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../examples/builder-configurations.html">Builder Configuration Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples/fastapi-logging.html">FastAPI Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples/cli-tools.html">Logging in Scripts/CLIs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples/redacting-secrets.html">Redacting Secrets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples/structured-error-logging.html">Structured Error Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples/kubernetes-file-sink.html">Kubernetes File Sink</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples/prometheus-metrics.html">Prometheus Metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples/sampling-debug-logs.html">Sampling Debug Logs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples/size-limited-destinations.html">Handling Size-Limited Destinations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples/cloudwatch_logging/index.html">CloudWatch Logging (LocalStack)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples/cloud-sinks/index.html">Cloud Sink Examples</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../redaction/index.html">Redaction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../redaction/presets.html">Redaction Presets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../redaction/configuration.html">Redaction Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../redaction/behavior.html">Redaction Behavior</a></li>
<li class="toctree-l2"><a class="reference internal" href="../redaction/testing.html">Testing Redaction</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../enterprise.html">Enterprise Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api-reference/index.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../api-reference/top-level-functions.html">Top-Level Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api-reference/builder.html">Builder API Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api-reference/logger-methods.html">Logger Methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api-reference/context-binding.html">Context Binding</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api-reference/audit-trail.html">Audit Trail</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api-reference/configuration.html">Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api-reference/configuration-map.html">Configuration Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api-reference/types.html">Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api-reference/plugins/index.html">Plugins</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api-reference/lifecycle-results.html">Lifecycle &amp; Results</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api-reference/modules.html">API Modules</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../plugins/index.html">Plugin Development</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../plugins/quickstart.html">Plugin Author Quickstart</a></li>
<li class="toctree-l2"><a class="reference internal" href="../plugins/authoring.html">Authoring Fapilog Plugins</a></li>
<li class="toctree-l2"><a class="reference internal" href="../plugins/contracts-and-versioning.html">Plugin Contracts and API Versioning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../plugins/redactors.html">Redactors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../plugins/sinks.html">Sinks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../plugins/enrichers.html">Enrichers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../plugins/filters.html">Filters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../plugins/processors.html">Processors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../plugins/testing.html">Plugin Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../plugins/configuration.html">Plugin Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../plugins/health-checks.html">Plugin Health Checks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../plugins/error-handling.html">Plugin Error Handling</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../patterns.html">Integration Patterns</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../patterns/sdk-sinks.html">Building SDK-Based Sinks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../patterns/http-sinks.html">Building HTTP-Based Sinks</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting/index.html">Troubleshooting</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting/logs-dropped-under-load.html">Logs Dropped Under Load</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting/destination-size-limits.html">Logs Rejected by Destination Size Limits</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting/context-values-missing.html">Context Values Missing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting/file-sink-not-rotating.html">File Sink Not Rotating</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting/serialization-errors.html">Serialization Errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting/pii-showing-despite-redaction.html">PII Showing Despite Redaction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting/cloudwatch-sink.html">CloudWatch Sink Issues</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting/loki-sink.html">Loki Sink Issues</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendices.html">Appendices</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../env-vars.html">Environment Variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../settings-guide.html">Settings Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../schema-guide.html">Schema Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../schema-migration-v1.0-to-v1.1.html">Schema Migration Guide: v1.0 to v1.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../plugin-guide.html">Plugin Catalog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security-operator-workflows.html">Security Remediation &amp; Approval Workflows</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quality-signals.html">Quality Signals</a></li>
<li class="toctree-l2"><a class="reference internal" href="../guides/settings-to-builder-migration.html">Migrating from Settings to Builder</a></li>
<li class="toctree-l2"><a class="reference internal" href="../guides/migration-file-rotation.html">Migration Guide: Simplified Rotating File Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../guides/tenacity-integration.html">Tenacity Integration Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../guides/testing.html">Testing with Fapilog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../guides/async-context.html">Async Context Propagation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../addons/tamper-evident-logging.html">Tamper-Evident Logging Add-on (Optional)</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #2980B9" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">fapilog</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Cookbook</a></li>
      <li class="breadcrumb-item active">Adaptive Sampling for High-Volume Services</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/cookbook/adaptive-sampling-high-volume.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="adaptive-sampling-for-high-volume-services">
<h1>Adaptive Sampling for High-Volume Services<a class="headerlink" href="#adaptive-sampling-for-high-volume-services" title="Link to this heading"></a></h1>
<p>When your service handles thousands of requests per second, logging everything is expensive and often unnecessary. But during incidents, you need full visibility. Adaptive sampling automatically adjusts the sample rate based on traffic.</p>
<section id="the-problem">
<h2>The Problem<a class="headerlink" href="#the-problem" title="Link to this heading"></a></h2>
<p>A flash sale or viral moment creates a cost explosion:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Normal:     100 req/s × 86,400 sec = 8.6M logs/day    ($4.30/day)
Flash sale: 10,000 req/s × 3,600 sec = 36M logs/hour  ($18/hour)
</pre></div>
</div>
<p>At $0.50/GB ingested (typical cloud pricing), a 4-hour sale event costs more than a month of normal operation. Worse, the flood makes it harder to find actual problems.</p>
<p><strong>What you need:</strong></p>
<ul class="simple">
<li><p>Cost-effective logging during normal operation</p></li>
<li><p>Full visibility during incidents</p></li>
<li><p>Errors never dropped, regardless of volume</p></li>
</ul>
</section>
<section id="the-solution-adaptive-preset-adaptive-sampling">
<h2>The Solution: adaptive Preset + Adaptive Sampling<a class="headerlink" href="#the-solution-adaptive-preset-adaptive-sampling" title="Link to this heading"></a></h2>
<p>Combine the <code class="docutils literal notranslate"><span class="pre">adaptive</span></code> preset with adaptive sampling for intelligent cost control:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">fapilog</span><span class="w"> </span><span class="kn">import</span> <span class="n">LoggerBuilder</span>

<span class="n">logger</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">LoggerBuilder</span><span class="p">()</span>
    <span class="o">.</span><span class="n">with_preset</span><span class="p">(</span><span class="s2">&quot;adaptive&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">with_adaptive_sampling</span><span class="p">(</span><span class="n">target_events_per_sec</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="o">.</span><span class="n">build</span><span class="p">()</span>
<span class="p">)</span>

<span class="c1"># During normal traffic: logs ~100 events/sec</span>
<span class="c1"># During spikes: automatically samples down, never below 1%</span>
<span class="c1"># Errors: always logged via priority queue protection</span>
</pre></div>
</div>
<section id="why-two-layers-of-protection">
<h3>Why Two Layers of Protection?<a class="headerlink" href="#why-two-layers-of-protection" title="Link to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">adaptive</span></code> preset provides <strong>queue-level protection</strong> via <code class="docutils literal notranslate"><span class="pre">protected_levels</span></code>:</p>
<ul class="simple">
<li><p>ERROR/CRITICAL/FATAL events survive queue pressure</p></li>
<li><p>Under extreme load, unprotected events may be evicted to make room for protected ones</p></li>
<li><p>This is a last-resort safety net</p></li>
</ul>
<p>Adaptive sampling provides <strong>pre-queue cost control</strong>:</p>
<ul class="simple">
<li><p>Samples events before they enter the queue</p></li>
<li><p>Automatically adjusts rate based on throughput</p></li>
<li><p>More predictable cost control</p></li>
</ul>
<p>Together they provide both cost efficiency and guaranteed error visibility.</p>
</section>
<section id="configuration">
<h3>Configuration<a class="headerlink" href="#configuration" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Full configuration with adaptive sampling:</span>
<span class="n">logger</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">LoggerBuilder</span><span class="p">()</span>
    <span class="o">.</span><span class="n">with_adaptive_sampling</span><span class="p">(</span>
        <span class="n">target_events_per_sec</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>  <span class="c1"># Target throughput</span>
        <span class="n">min_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>              <span class="c1"># Never below 1%</span>
        <span class="n">max_rate</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>               <span class="c1"># Full logging when quiet</span>
        <span class="n">window_seconds</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>        <span class="c1"># 10-second rolling window</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">with_protected_levels</span><span class="p">([</span><span class="s2">&quot;ERROR&quot;</span><span class="p">,</span> <span class="s2">&quot;CRITICAL&quot;</span><span class="p">,</span> <span class="s2">&quot;FATAL&quot;</span><span class="p">])</span>  <span class="c1"># Queue protection</span>
    <span class="o">.</span><span class="n">with_workers</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>        <span class="c1"># Throughput optimization</span>
    <span class="o">.</span><span class="n">with_drop_on_full</span><span class="p">()</span>    <span class="c1"># Protect latency under pressure</span>
    <span class="o">.</span><span class="n">add_stdout_json</span><span class="p">()</span>
    <span class="o">.</span><span class="n">build</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="how-adaptive-sampling-works">
<h2>How Adaptive Sampling Works<a class="headerlink" href="#how-adaptive-sampling-works" title="Link to this heading"></a></h2>
<p>Unlike fixed-rate sampling, adaptive sampling responds to actual throughput:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Traffic</p></th>
<th class="head"><p>Sample Rate</p></th>
<th class="head"><p>Events Logged</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>50/sec</p></td>
<td><p>100%</p></td>
<td><p>50/sec (full visibility)</p></td>
</tr>
<tr class="row-odd"><td><p>100/sec</p></td>
<td><p>100%</p></td>
<td><p>100/sec (at target)</p></td>
</tr>
<tr class="row-even"><td><p>1,000/sec</p></td>
<td><p>10%</p></td>
<td><p>~100/sec (cost controlled)</p></td>
</tr>
<tr class="row-odd"><td><p>10,000/sec</p></td>
<td><p>1%</p></td>
<td><p>~100/sec (minimum rate)</p></td>
</tr>
</tbody>
</table>
<p>The algorithm uses exponential smoothing over a 10-second window to avoid thrashing.</p>
</section>
<section id="errors-always-pass-through">
<h2>Errors Always Pass Through<a class="headerlink" href="#errors-always-pass-through" title="Link to this heading"></a></h2>
<p>The most important feature: <strong>errors are never dropped</strong>. The <code class="docutils literal notranslate"><span class="pre">protected_levels</span></code> setting ensures ERROR, CRITICAL, and FATAL messages survive queue pressure:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Even during a 10,000 req/sec spike with 1% sampling:</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;request processed&quot;</span><span class="p">)</span>   <span class="c1"># May be sampled out or dropped under pressure</span>
<span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;database timeout&quot;</span><span class="p">)</span>   <span class="c1"># Protected: survives queue pressure</span>
<span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;service down&quot;</span><span class="p">)</span>    <span class="c1"># Protected: survives queue pressure</span>
</pre></div>
</div>
<p>This is production-safe because you’ll always see:</p>
<ul class="simple">
<li><p>Unhandled exceptions</p></li>
<li><p>Database failures</p></li>
<li><p>Service degradations</p></li>
<li><p>Security events logged at ERROR+</p></li>
</ul>
<p>The protection works at two levels:</p>
<ol class="arabic simple">
<li><p><strong>Adaptive sampling filter</strong>: <code class="docutils literal notranslate"><span class="pre">always_pass_levels</span></code> bypasses sampling for protected levels</p></li>
<li><p><strong>Priority queue</strong>: If queue is full, unprotected events are evicted to make room for protected ones</p></li>
</ol>
</section>
<section id="real-world-example-e-commerce-flash-sale">
<h2>Real-World Example: E-commerce Flash Sale<a class="headerlink" href="#real-world-example-e-commerce-flash-sale" title="Link to this heading"></a></h2>
<section id="before-fixed-sampling">
<h3>Before: Fixed Sampling<a class="headerlink" href="#before-fixed-sampling" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fixed 10% sampling - problematic</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">LoggerBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">with_sampling</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span><span class="o">.</span><span class="n">add_stdout</span><span class="p">()</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>

<span class="c1"># Problem 1: During quiet periods, you&#39;re missing 90% of data</span>
<span class="c1"># Problem 2: During flash sale, you might still be over budget</span>
<span class="c1"># Problem 3: No automatic adjustment</span>
</pre></div>
</div>
</section>
<section id="after-adaptive-sampling-with-adaptive">
<h3>After: Adaptive Sampling with adaptive<a class="headerlink" href="#after-adaptive-sampling-with-adaptive" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">fapilog</span><span class="w"> </span><span class="kn">import</span> <span class="n">LoggerBuilder</span>

<span class="c1"># Adaptive sampling - responds to actual traffic</span>
<span class="n">logger</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">LoggerBuilder</span><span class="p">()</span>
    <span class="o">.</span><span class="n">with_preset</span><span class="p">(</span><span class="s2">&quot;adaptive&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">with_adaptive_sampling</span><span class="p">(</span><span class="n">target_events_per_sec</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="o">.</span><span class="n">build</span><span class="p">()</span>
<span class="p">)</span>

<span class="c1"># Quiet period (50 req/s): 100% sampled</span>
<span class="c1"># Normal load (500 req/s): ~20% sampled, hitting 100/sec target</span>
<span class="c1"># Flash sale (5000 req/s): ~2% sampled, hitting 100/sec target</span>
<span class="c1"># All errors: 100% captured via queue protection</span>
</pre></div>
</div>
</section>
<section id="cost-comparison">
<h3>Cost Comparison<a class="headerlink" href="#cost-comparison" title="Link to this heading"></a></h3>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Scenario</p></th>
<th class="head"><p>Fixed 10%</p></th>
<th class="head"><p>adaptive + sampling</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Quiet (50/sec)</p></td>
<td><p>5/sec</p></td>
<td><p>50/sec (full visibility)</p></td>
</tr>
<tr class="row-odd"><td><p>Normal (500/sec)</p></td>
<td><p>50/sec</p></td>
<td><p>100/sec</p></td>
</tr>
<tr class="row-even"><td><p>Flash sale (5000/sec)</p></td>
<td><p>500/sec</p></td>
<td><p>100/sec</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Daily cost</strong>*</p></td>
<td><p>~$10</p></td>
<td><p>~$5</p></td>
</tr>
</tbody>
</table>
<p>*Estimated at $0.50/GB, 1KB average log size</p>
</section>
</section>
<section id="customizing-the-preset">
<h2>Customizing the Preset<a class="headerlink" href="#customizing-the-preset" title="Link to this heading"></a></h2>
<p>Override specific settings while keeping the preset’s base configuration:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">fapilog</span><span class="w"> </span><span class="kn">import</span> <span class="n">LoggerBuilder</span>

<span class="c1"># Higher target for services that need more visibility</span>
<span class="n">logger</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">LoggerBuilder</span><span class="p">()</span>
    <span class="o">.</span><span class="n">with_preset</span><span class="p">(</span><span class="s2">&quot;adaptive&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">with_adaptive_sampling</span><span class="p">(</span><span class="n">target_events_per_sec</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>  <span class="c1"># Override target</span>
    <span class="o">.</span><span class="n">build</span><span class="p">()</span>
<span class="p">)</span>

<span class="c1"># Lower minimum rate for extremely high-volume services</span>
<span class="n">logger</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">LoggerBuilder</span><span class="p">()</span>
    <span class="o">.</span><span class="n">with_preset</span><span class="p">(</span><span class="s2">&quot;adaptive&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">with_adaptive_sampling</span><span class="p">(</span><span class="n">min_rate</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>  <span class="c1"># 0.1% minimum</span>
    <span class="o">.</span><span class="n">build</span><span class="p">()</span>
<span class="p">)</span>

<span class="c1"># Add a cloud sink while keeping preset configuration</span>
<span class="n">logger</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">LoggerBuilder</span><span class="p">()</span>
    <span class="o">.</span><span class="n">with_preset</span><span class="p">(</span><span class="s2">&quot;adaptive&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">add_cloudwatch</span><span class="p">(</span><span class="n">log_group</span><span class="o">=</span><span class="s2">&quot;/app/production&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">build</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="when-to-use-adaptive-vs-other-presets">
<h2>When to Use adaptive vs Other Presets<a class="headerlink" href="#when-to-use-adaptive-vs-other-presets" title="Link to this heading"></a></h2>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Preset</p></th>
<th class="head"><p>Use When</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">adaptive</span></code></p></td>
<td><p>Traffic varies widely, cost is a concern, errors must never be missed</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">production</span></code></p></td>
<td><p>Moderate traffic, durability matters more than cost</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">serverless</span></code></p></td>
<td><p>Lambda/Cloud Functions with short execution time</p></td>
</tr>
</tbody>
</table>
<section id="decision-guide">
<h3>Decision Guide<a class="headerlink" href="#decision-guide" title="Link to this heading"></a></h3>
<p><strong>Choose <code class="docutils literal notranslate"><span class="pre">adaptive</span></code> when:</strong></p>
<ul class="simple">
<li><p>Your service handles 100+ requests/second regularly</p></li>
<li><p>Traffic is spiky or unpredictable</p></li>
<li><p>Log storage/ingestion costs are a concern</p></li>
<li><p>You need errors to always be captured</p></li>
</ul>
<p><strong>Choose <code class="docutils literal notranslate"><span class="pre">production</span></code> instead when:</strong></p>
<ul class="simple">
<li><p>You need every log for compliance/audit</p></li>
<li><p>Traffic is predictable and moderate</p></li>
<li><p>File-based logging is required</p></li>
</ul>
</section>
</section>
<section id="monitoring-adaptive-sampling">
<h2>Monitoring Adaptive Sampling<a class="headerlink" href="#monitoring-adaptive-sampling" title="Link to this heading"></a></h2>
<p>Track the current sample rate and dropped events:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">fapilog</span><span class="w"> </span><span class="kn">import</span> <span class="n">LoggerBuilder</span>

<span class="n">logger</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">LoggerBuilder</span><span class="p">()</span>
    <span class="o">.</span><span class="n">with_preset</span><span class="p">(</span><span class="s2">&quot;adaptive&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">with_metrics</span><span class="p">(</span><span class="n">enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="o">.</span><span class="n">build</span><span class="p">()</span>
<span class="p">)</span>

<span class="c1"># Exposed metrics:</span>
<span class="c1"># - fapilog_adaptive_sample_rate: Current rate (0.0-1.0)</span>
<span class="c1"># - fapilog_events_filtered: Events dropped by sampling</span>
<span class="c1"># - fapilog_events_always_passed: High-priority events that bypassed sampling</span>
</pre></div>
</div>
</section>
<section id="going-deeper">
<h2>Going Deeper<a class="headerlink" href="#going-deeper" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="log-sampling-rate-limiting.html"><span class="std std-doc">Log Sampling and Rate Limiting</span></a> - Fixed-rate sampling and token bucket rate limiting</p></li>
<li><p><a class="reference internal" href="../user-guide/configuration.html"><span class="std std-doc">Configuration Guide</span></a> - Complete settings reference</p></li>
<li><p><a class="reference internal" href="../user-guide/performance-tuning.html"><span class="std std-doc">Performance Tuning</span></a> - Optimization strategies</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          
<footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer" style="position: relative;">
        <a href="log-sampling-rate-limiting.html" class="btn btn-neutral float-left" title="Log sampling and rate limiting for FastAPI" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="graceful-shutdown-flush.html" class="btn btn-neutral float-right" title="Graceful shutdown &amp; flushing logs (don’t lose logs on deploy)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
      <div style="position: absolute; left: 50%; transform: translateX(-50%); top: 50%; margin-top: -0.5em;">
        <a href="https://fapilog.dev">www.fapilog.dev</a>
      </div>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Chris Haste.
      <span class="lastupdated">Last updated on February 20, 2026.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>